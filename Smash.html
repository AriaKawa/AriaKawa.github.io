<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smash 1v1 League Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --card-dark: #111827;
      --accent: #22c55e;
      --accent-blue: #38bdf8;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.2);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.8);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .title-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    h1 {
      font-size: 1.25rem;
      margin: 0;
    }
    .sub {
      color: var(--muted);
      font-size: 0.85rem;
      max-width: 720px;
    }
    #controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    button,
    .pill {
      background: #334155;
      border: none;
      color: var(--text);
      padding: 0.4rem 0.8rem;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 0.85rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    button:hover {
      background: #475569;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .pill {
      background: rgba(30, 41, 59, 0.85);
      border: 1px solid var(--border);
      cursor: default;
    }
    .pill strong {
      color: var(--text);
    }

    main {
      padding: 1rem;
      display: grid;
      gap: 1rem;
      flex: 1 1 auto;
    }
    .matchup {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .slot {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: grid;
      gap: 0.75rem;
    }
    .slot-header {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    .face {
      width: 72px;
      height: 72px;
      border-radius: 0.6rem;
      background: var(--card-dark);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .face img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .slot .name {
      font-weight: 700;
      font-size: 1rem;
    }
    .slot .score {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .slot-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.2rem 0.5rem;
      border-radius: 9999px;
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
      border: 1px solid rgba(56, 189, 248, 0.35);
    }
    .badge.p1 {
      color: var(--accent);
      border-color: rgba(34, 197, 94, 0.35);
      background: rgba(34, 197, 94, 0.15);
    }

    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .section-title h2 {
      margin: 0;
      font-size: 1rem;
    }
    .hint {
      color: var(--muted);
      font-size: 0.8rem;
    }
    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
      gap: 0.75rem;
    }
    .fighter {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0.6rem;
      padding: 0.4rem;
      text-align: center;
      cursor: pointer;
      transition: transform 0.1s ease, border 0.1s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
      min-height: 120px;
      position: relative;
    }
    .fighter:hover {
      transform: translateY(-2px);
      border-color: rgba(226, 232, 240, 0.4);
    }
    .fighter img {
      width: 68px;
      height: 68px;
      border-radius: 0.45rem;
      object-fit: cover;
      background: #0f172a;
    }
    .fighter span {
      font-size: 0.7rem;
      line-height: 1.2;
      word-break: break-word;
    }
    .fighter.used {
      opacity: 0.4;
      filter: grayscale(1);
      cursor: not-allowed;
    }
    .fighter.selected-p1 {
      border-color: rgba(34, 197, 94, 0.7);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }
    .fighter.selected-p2 {
      border-color: rgba(56, 189, 248, 0.8);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
    }
    .fighter .mini-badge {
      position: absolute;
      top: 6px;
      left: 6px;
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .fighter .image-failed {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 0.6rem;
      padding: 0.1rem 0.35rem;
      border-radius: 9999px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.45);
      color: #fecaca;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    @media (max-width: 600px) {
      header {
        padding: 1rem;
      }
      #grid {
        grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div class="title-group">
        <h1>Smash 1v1 League Tracker</h1>
      </div>
    </div>
    <div class="sub">
      Click <strong>Randomize</strong> to pick two fighters. Award the win to P1 or P2 to retire that fighter from future rolls.
    </div>
    <div id="controls">
      <button id="btnRandom" type="button">Randomize (Pick 2)</button>
      <button id="btnReset" type="button">Reset Pool</button>
      <span class="pill">Available: <strong id="availableCount">0</strong></span>
      <span class="pill">Used: <strong id="usedCount">0</strong></span>
    </div>
  </header>

  <main>
    <section class="matchup" aria-label="Matchup">
      <div class="slot">
        <div class="slot-header">
          <div class="face" id="p1Face"></div>
          <div>
            <div class="badge p1">P1</div>
            <div class="name" id="p1Name">P1: —</div>
            <div class="score" id="p1Score">Wins: 0</div>
          </div>
        </div>
        <div class="slot-actions">
          <button id="btnP1Win" type="button" disabled>Give Point to P1</button>
        </div>
      </div>

      <div class="slot">
        <div class="slot-header">
          <div class="face" id="p2Face"></div>
          <div>
            <div class="badge">P2</div>
            <div class="name" id="p2Name">P2: —</div>
            <div class="score" id="p2Score">Wins: 0</div>
          </div>
        </div>
        <div class="slot-actions">
          <button id="btnP2Win" type="button" disabled>Give Point to P2</button>
        </div>
      </div>
    </section>

    <section>
      <div class="section-title">
        <h2>Character Pool</h2>
        <div class="hint">Tip: click a character tile to set P1, then click another to set P2.</div>
      </div>
      <div id="grid"></div>
    </section>
  </main>

  <script>
    const fallbackFighters = [
      "Mario",
      "Donkey Kong",
      "Link",
      "Samus",
      "Dark Samus",
      "Yoshi",
      "Kirby",
      "Fox",
      "Pikachu",
      "Luigi",
      "Ness",
      "Captain Falcon",
      "Jigglypuff",
      "Peach",
      "Daisy",
      "Bowser",
      "Ice Climbers",
      "Sheik",
      "Zelda",
      "Dr. Mario",
      "Pichu",
      "Falco",
      "Marth",
      "Lucina",
      "Young Link",
      "Ganondorf",
      "Mewtwo",
      "Roy",
      "Chrom",
      "Mr. Game & Watch",
      "Meta Knight",
      "Pit",
      "Dark Pit",
      "Zero Suit Samus",
      "Wario",
      "Snake",
      "Ike",
      "Pokemon Trainer",
      "Diddy Kong",
      "Lucas",
      "Sonic",
      "King Dedede",
      "Olimar",
      "Lucario",
      "R.O.B.",
      "Toon Link",
      "Wolf",
      "Villager",
      "Mega Man",
      "Wii Fit Trainer",
      "Rosalina & Luma",
      "Little Mac",
      "Greninja",
      "Mii Brawler",
      "Mii Swordfighter",
      "Mii Gunner",
      "Palutena",
      "Pac-Man",
      "Robin",
      "Shulk",
      "Bowser Jr.",
      "Duck Hunt",
      "Ryu",
      "Ken",
      "Cloud",
      "Corrin",
      "Bayonetta",
      "Inkling",
      "Ridley",
      "Simon",
      "Richter",
      "King K. Rool",
      "Isabelle",
      "Incineroar",
      "Piranha Plant",
      "Joker",
      "Hero",
      "Banjo & Kazooie",
      "Terry",
      "Byleth",
      "Min Min",
      "Steve",
      "Sephiroth",
      "Pyra / Mythra",
      "Kazuya",
      "Sora"
    ];

    const state = {
      fighters: [],
      used: new Set(),
      p1: null,
      p2: null,
      wins: {}
    };

    const elements = {
      grid: document.getElementById("grid"),
      available: document.getElementById("availableCount"),
      used: document.getElementById("usedCount"),
      p1Name: document.getElementById("p1Name"),
      p2Name: document.getElementById("p2Name"),
      p1Score: document.getElementById("p1Score"),
      p2Score: document.getElementById("p2Score"),
      p1Face: document.getElementById("p1Face"),
      p2Face: document.getElementById("p2Face"),
      btnRandom: document.getElementById("btnRandom"),
      btnReset: document.getElementById("btnReset"),
      btnP1Win: document.getElementById("btnP1Win"),
      btnP2Win: document.getElementById("btnP2Win")
    };

    const ICON_BASES = [
      "https://cdn.jsdelivr.net/gh/akabab/smash-ultimate-api@master/assets/icons",
      "https://raw.githubusercontent.com/akabab/smash-ultimate-api/master/assets/icons",
      "https://akabab.github.io/smash-ultimate-api/characters/icon",
      "https://cdn.jsdelivr.net/gh/akabab/smash-ultimate-api@master/characters/icon",
      "https://cdn.jsdelivr.net/gh/akabab/smash-ultimate-api@master/public/characters/icon",
      "https://raw.githubusercontent.com/akabab/smash-ultimate-api/master/characters/icon",
      "https://raw.githubusercontent.com/akabab/smash-ultimate-api/master/public/characters/icon"
    ];
    const ICON_EXTS = ["png", "webp", "jpg"];

    const toIconSlug = (name) => {
      const overrides = {
        "Mr. Game & Watch": "mr_game_and_watch",
        "Dr. Mario": "dr_mario",
        "Dark Samus": "dark_samus",
        "Zero Suit Samus": "zero_suit_samus",
        "Pokémon Trainer": "pokemon_trainer",
        "Pokemon Trainer": "pokemon_trainer",
        "R.O.B.": "rob",
        "King K. Rool": "king_k_rool",
        "Banjo & Kazooie": "banjo_and_kazooie",
        "Rosalina & Luma": "rosalina_and_luma",
        "Pyra / Mythra": "pyra_and_mythra",
        "Pac-Man": "pacman",
        "Bowser Jr.": "bowser_jr",
        "Ice Climbers": "ice_climbers",
        "Duck Hunt": "duck_hunt",
        "Wii Fit Trainer": "wii_fit_trainer"
      };

      if (overrides[name]) {
        return overrides[name];
      }

      return name
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "");
    };

    const iconUrlFor = (base, name, ext) => `${base}/${toIconSlug(name)}.${ext}`;

    const iconVariantsFor = (base, name) =>
      ICON_EXTS.map((ext) => iconUrlFor(base, name, ext));

    const iconSourcesFor = (fighter) => {
      const sources = [];
      if (fighter?.icon) {
        sources.push(fighter.icon);
      }
      if (fighter?.image) {
        sources.push(fighter.image);
      }
      ICON_BASES.forEach((base) => sources.push(...iconVariantsFor(base, fighter.name)));
      return sources.filter(Boolean);
    };

    const createPlaceholder = (name) => {
      const initials = name
        .replace(/[^A-Za-z0-9 ]/g, "")
        .split(" ")
        .filter(Boolean)
        .slice(0, 2)
        .map((chunk) => chunk[0])
        .join("")
        .toUpperCase();
      const hue = Math.floor(Math.random() * 360);
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" role="img" aria-label="${name}">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="hsl(${hue}, 70%, 55%)" />
            <stop offset="1" stop-color="hsl(${(hue + 40) % 360}, 70%, 45%)" />
          </linearGradient>
        </defs>
        <rect width="64" height="64" rx="12" fill="url(#g)" />
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="22" fill="#fff" font-weight="700">${initials}</text>
      </svg>`;
      return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    };

    const normalizeName = (name) => name.replace(/\s+/g, " ").trim();

    const hydrateFallback = () => fallbackFighters.map((name, index) => ({
      id: `fallback-${index}`,
      name,
      icon: iconUrlFor(ICON_BASES[0], name, ICON_EXTS[0])
    }));

    const applyFighterImage = (img, fighter, errorBadge) => {
      const placeholder = createPlaceholder(fighter.name);
      if (errorBadge) {
        errorBadge.hidden = true;
      }
      const sources = iconSourcesFor(fighter);
      const trySource = (index) => {
        if (index >= sources.length) {
          if (errorBadge) {
            errorBadge.hidden = false;
          }
          console.warn("Missing fighter icon asset:", fighter.name, sources);
          img.src = placeholder;
          return;
        }
        img.src = sources[index];
        img.onerror = () => {
          img.onerror = null;
          trySource(index + 1);
        };
      };
      if (sources.length) {
        trySource(0);
      } else {
        img.src = placeholder;
      }
    };

    const loadFighters = async () => {
      try {
        const response = await fetch("https://akabab.github.io/smash-ultimate-api/api/characters");
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        const data = await response.json();
        const unique = new Map();
        data.forEach((fighter) => {
          const name = normalizeName(fighter.name);
          if (!unique.has(name)) {
            unique.set(name, {
              id: fighter.id ?? name,
              name,
              icon: fighter.icon || fighter.image || iconUrlFor(ICON_BASES[0], name, ICON_EXTS[0])
            });
          }
        });
        state.fighters = Array.from(unique.values()).sort((a, b) => a.name.localeCompare(b.name));
      } catch (error) {
        state.fighters = hydrateFallback();
      }
    };

    const updateCounts = () => {
      elements.available.textContent = state.fighters.length - state.used.size;
      elements.used.textContent = state.used.size;
    };

    const renderSlot = (slot, fighter, wins, faceEl, nameEl, scoreEl, buttonEl) => {
      faceEl.innerHTML = "";
      if (fighter) {
        const img = document.createElement("img");
        applyFighterImage(img, fighter);
        img.alt = fighter.name;
        img.referrerPolicy = "no-referrer";
        img.decoding = "async";
        faceEl.appendChild(img);
        nameEl.textContent = `${slot}: ${fighter.name}`;
        scoreEl.textContent = `Wins: ${wins}`;
        buttonEl.disabled = false;
      } else {
        nameEl.textContent = `${slot}: —`;
        scoreEl.textContent = "Wins: 0";
        buttonEl.disabled = true;
      }
    };

    const updateSlots = () => {
      renderSlot("P1", state.p1, state.wins.p1 || 0, elements.p1Face, elements.p1Name, elements.p1Score, elements.btnP1Win);
      renderSlot("P2", state.p2, state.wins.p2 || 0, elements.p2Face, elements.p2Name, elements.p2Score, elements.btnP2Win);
    };

    const renderGrid = () => {
      elements.grid.innerHTML = "";
      state.fighters.forEach((fighter) => {
        const div = document.createElement("div");
        div.className = "fighter";
        div.dataset.id = fighter.id;

        if (state.used.has(fighter.id)) {
          div.classList.add("used");
        }
        if (state.p1 && state.p1.id === fighter.id) {
          div.classList.add("selected-p1");
        }
        if (state.p2 && state.p2.id === fighter.id) {
          div.classList.add("selected-p2");
        }

        if (state.p1 && state.p1.id === fighter.id) {
          const badge = document.createElement("span");
          badge.className = "mini-badge";
          badge.textContent = "P1";
          div.appendChild(badge);
        } else if (state.p2 && state.p2.id === fighter.id) {
          const badge = document.createElement("span");
          badge.className = "mini-badge";
          badge.textContent = "P2";
          div.appendChild(badge);
        }

        const img = document.createElement("img");
        const imageFailure = document.createElement("span");
        imageFailure.className = "image-failed";
        imageFailure.textContent = "image failed";
        imageFailure.hidden = true;
        applyFighterImage(img, fighter, imageFailure);
        img.alt = fighter.name;
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        img.decoding = "async";

        const label = document.createElement("span");
        label.textContent = fighter.name;

        div.appendChild(img);
        div.appendChild(imageFailure);
        div.appendChild(label);

        div.addEventListener("click", () => {
          if (state.used.has(fighter.id)) return;
          if (!state.p1 || state.p1.id === fighter.id) {
            state.p1 = fighter;
          } else if (!state.p2 || state.p2.id === fighter.id) {
            state.p2 = fighter;
          } else {
            state.p1 = fighter;
          }
          updateSlots();
          renderGrid();
        });

        elements.grid.appendChild(div);
      });
      updateCounts();
    };

    const pickRandom = () => {
      const available = state.fighters.filter((fighter) => !state.used.has(fighter.id));
      if (available.length < 2) return;
      const shuffled = available.sort(() => 0.5 - Math.random());
      state.p1 = shuffled[0];
      state.p2 = shuffled[1];
      updateSlots();
      renderGrid();
    };

    const awardWin = (winnerKey) => {
      const winner = state[winnerKey];
      if (!winner) return;
      state.wins[winnerKey] = (state.wins[winnerKey] || 0) + 1;
      state.used.add(winner.id);
      if (winnerKey === "p1" && state.p2) {
        state.p2 = null;
      }
      if (winnerKey === "p2" && state.p1) {
        state.p1 = null;
      }
      updateSlots();
      renderGrid();
    };

    const resetPool = () => {
      state.used.clear();
      state.p1 = null;
      state.p2 = null;
      state.wins = {};
      updateSlots();
      renderGrid();
    };

    elements.btnRandom.addEventListener("click", pickRandom);
    elements.btnReset.addEventListener("click", resetPool);
    elements.btnP1Win.addEventListener("click", () => awardWin("p1"));
    elements.btnP2Win.addEventListener("click", () => awardWin("p2"));

    const start = async () => {
      await loadFighters();
      updateSlots();
      renderGrid();
    };

    start();
  </script>
</body>
</html>
