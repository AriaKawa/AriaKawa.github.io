<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria &amp; Friends Project Vault</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #050311;
            --bg-alt: #120a2d;
            --text-primary: #f5f3ff;
            --text-muted: #bcb4da;
            --accent-pink: #f7a7da;
            --accent-blue: #93c6ff;
            --accent-lavender: #c2b7ff;
            --card-gradient: linear-gradient(155deg, rgba(23, 16, 52, 0.92), rgba(10, 6, 27, 0.88));
            --border-gradient: linear-gradient(140deg, rgba(244, 170, 219, 0.8), rgba(147, 198, 255, 0.8));
            --radius-lg: 28px;
            --radius-sm: 14px;
            --shadow-strong: 0 35px 65px rgba(8, 4, 22, 0.7);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            font-family: "Plus Jakarta Sans", "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            background:
                radial-gradient(circle at top left, rgba(147, 198, 255, 0.28), transparent 55%),
                radial-gradient(circle at bottom right, rgba(247, 167, 218, 0.32), transparent 60%),
                var(--bg-base);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(1.6rem, 4vw, 3.5rem);
        }

        .page {
            width: min(960px, 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(2rem, 4vw, 3rem);
        }

        .games-panel {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(2rem, 4vw, 3rem);
            text-align: center;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .category-selector {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: clamp(1.25rem, 3vw, 2rem);
            height: clamp(300px, 60vh, 460px);
        }

        .category-button {
            appearance: none;
            border: 1px solid transparent;
            border-radius: calc(var(--radius-lg) - 2px);
            background: linear-gradient(150deg, rgba(87, 57, 196, 0.75), rgba(42, 24, 104, 0.92));
            color: var(--text-primary);
            box-shadow: 0 35px 55px rgba(10, 6, 27, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: clamp(1.2rem, 3vw, 2rem);
            min-height: 100%;
            font-size: clamp(1.8rem, 4.5vw, 2.6rem);
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .category-button:hover,
        .category-button:focus-visible {
            transform: translateY(-8px);
            border-color: rgba(247, 167, 218, 0.7);
            box-shadow: 0 45px 75px rgba(8, 4, 22, 0.6);
            outline: none;
        }

        .category-label {
            display: block;
        }

        .category-view {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: clamp(1.6rem, 3vw, 2.4rem);
            align-items: stretch;
            text-align: left;
        }

        .category-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: clamp(0.8rem, 2vw, 1.2rem);
        }

        .category-title-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .category-title {
            margin: 0;
            font-size: clamp(1.35rem, 2.5vw, 1.75rem);
        }

        .category-description {
            margin: 0;
            color: var(--text-muted);
            font-size: clamp(0.95rem, 1.6vw, 1.05rem);
        }

        .category-back {
            appearance: none;
            border: 1px solid rgba(147, 198, 255, 0.45);
            background: linear-gradient(135deg, rgba(31, 21, 58, 0.82), rgba(11, 7, 27, 0.88));
            color: var(--text-primary);
            border-radius: 999px;
            padding: 0.65rem 1.4rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .category-back:hover,
        .category-back:focus-visible {
            transform: translateY(-2px);
            border-color: rgba(247, 167, 218, 0.65);
            outline: none;
        }

        .game-grid {
            display: grid;
            gap: clamp(1.1rem, 2.5vw, 1.8rem);
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .game-button {
            appearance: none;
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            background: var(--card-gradient);
            color: var(--text-primary);
            box-shadow: var(--shadow-strong);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: clamp(1.1rem, 2.8vw, 1.6rem);
            font-size: clamp(1.05rem, 1.8vw, 1.2rem);
            font-weight: 600;
            text-decoration: none;
            letter-spacing: 0.04em;
            background-image: var(--card-gradient), var(--border-gradient);
            background-clip: padding-box, border-box;
            background-origin: border-box;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        .game-button:hover,
        .game-button:focus-visible {
            transform: translateY(-6px);
            box-shadow: 0 40px 80px rgba(5, 3, 17, 0.85);
            outline: none;
        }

        .game-button[disabled],
        .game-button.is-disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .game-button[disabled]:hover,
        .game-button.is-disabled:hover,
        .game-button[disabled]:focus-visible,
        .game-button.is-disabled:focus-visible {
            transform: none;
            box-shadow: none;
            outline: none;
        }

        .cta,
        .cta.disabled {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            margin-top: 0.4rem;
            padding: 0.75rem 1.2rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.95rem;
            text-decoration: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .cta {
            color: #110720;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            box-shadow: 0 18px 32px rgba(147, 198, 255, 0.28);
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .cta:hover,
        .cta:focus-visible {
            transform: translateY(-3px);
            box-shadow: 0 22px 40px rgba(247, 167, 218, 0.32);
        }

        .cta.disabled {
            color: var(--text-muted);
            background: rgba(147, 198, 255, 0.12);
            border: 1px solid rgba(147, 198, 255, 0.22);
            cursor: default;
            box-shadow: none;
            pointer-events: none;
        }

        @media (max-width: 720px) {
            body {
                padding: clamp(1.2rem, 6vw, 2rem);
            }

            .category-selector {
                grid-template-columns: 1fr;
                height: auto;
            }

            .category-header {
                align-items: stretch;
            }

            .category-back {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <main class="page">
        <section class="games-panel">
            <h1 class="sr-only">Game Vault</h1>

            <div class="category-selector" data-category-selector>
                <button class="category-button" type="button" data-category-button="good">
                    <span class="category-label">Good Games</span>
                </button>
                <button class="category-button" type="button" data-category-button="bad">
                    <span class="category-label">Bad Games</span>
                </button>
            </div>

            <div class="category-view" data-category-view hidden>
                <div class="category-header">
                    <button class="category-back" type="button" data-category-back>
                        <span aria-hidden="true">←</span>
                        Back to categories
                    </button>
                    <div class="category-title-group">
                        <h2 class="category-title" data-category-title>Good Games</h2>
                        <p class="category-description" data-category-subtitle>
                            Pick from the certified hits.
                        </p>
                    </div>
                </div>

                <div class="game-grid" data-category-grid="good">
                    <a class="game-button" href="RatRace.html">Rat Race</a>
                    <a class="game-button" href="blackjack.html">Blackjack</a>
                    <a class="game-button" href="pokemon.html">Pokémon Typer</a>
                    <a class="game-button" href="movie-grid.html">Movie Grid</a>
                </div>

                <div class="game-grid" data-category-grid="bad" hidden>
                    <a class="game-button" href="trolley-game.html">Trolley Game</a>
                    <a class="game-button" href="thing-vs-thing.html">Thing vs Thing</a>
                    <a class="game-button" href="AutoRogue">AutoRogue</a>
                    <button class="game-button is-disabled" type="button" disabled>Rhythm Reactor (Coming Soon)</button>
                    <a class="game-button" href="rat-kingdom.html">Rat Kingdom</a>
                    <a class="game-button" href="grand-war.html">Grand War</a>
                    <a class="game-button" href="ForFriends.html">Know Your Friends</a>
                    <a class="game-button" href="newlywed.html">Newlywed Game</a>
                    <button class="game-button" type="button" data-download-banana>Download Banana</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        (function setupGameCategories() {
            const selector = document.querySelector('[data-category-selector]');
            const view = document.querySelector('[data-category-view]');
            if (!selector || !view) {
                return;
            }

            const titleEl = view.querySelector('[data-category-title]');
            const subtitleEl = view.querySelector('[data-category-subtitle]');
            const backButton = view.querySelector('[data-category-back]');
            const grids = Array.from(view.querySelectorAll('[data-category-grid]'));

            const metadata = {
                good: {
                    title: 'Good Games',
                    subtitle: 'Pick from the certified hits.'
                },
                bad: {
                    title: 'Bad Games',
                    subtitle: 'Everything else lives here.'
                }
            };

            function showCategory(key) {
                if (!metadata[key]) {
                    return;
                }

                selector.hidden = true;
                view.hidden = false;

                grids.forEach((grid) => {
                    const isMatch = grid.getAttribute('data-category-grid') === key;
                    grid.hidden = !isMatch;
                });

                const details = metadata[key];
                if (titleEl) {
                    titleEl.textContent = details.title;
                }
                if (subtitleEl) {
                    subtitleEl.textContent = details.subtitle;
                }

                if (backButton instanceof HTMLButtonElement) {
                    window.requestAnimationFrame(() => {
                        backButton.focus();
                    });
                }
            }

            function showSelector() {
                view.hidden = true;
                selector.hidden = false;

                grids.forEach((grid) => {
                    grid.hidden = true;
                });

                const firstButton = selector.querySelector('[data-category-button]');
                if (firstButton instanceof HTMLButtonElement) {
                    window.requestAnimationFrame(() => {
                        firstButton.focus();
                    });
                }
            }

            selector.addEventListener('click', (event) => {
                const button = event.target instanceof HTMLElement
                    ? event.target.closest('[data-category-button]')
                    : null;

                if (!(button instanceof HTMLButtonElement)) {
                    return;
                }

                const key = button.dataset.categoryButton;
                if (!key || !metadata[key]) {
                    return;
                }

                showCategory(key);
            });

            if (backButton instanceof HTMLButtonElement) {
                backButton.addEventListener('click', () => {
                    showSelector();
                });
            }

            showSelector();
        })();

        (function setupBananaDownload() {
            const button = document.querySelector('[data-download-banana]');
            if (!(button instanceof HTMLButtonElement)) {
                return;
            }

            const defaultLabel = button.textContent?.trim() || 'Download banana';
            const downloadUrl = 'assets/banana.svg';
            const downloadName = 'banana.svg';

            button.addEventListener('click', async () => {
                const restoreLabel = () => {
                    button.textContent = defaultLabel;
                    button.disabled = false;
                };

                button.disabled = true;
                button.textContent = 'Preparing banana…';

                try {
                    const response = await fetch(downloadUrl, { cache: 'no-store' });
                    if (!response.ok) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }

                    const blob = await response.blob();
                    const href = URL.createObjectURL(blob);
                    const anchor = document.createElement('a');
                    anchor.href = href;
                    anchor.download = downloadName;
                    document.body.appendChild(anchor);
                    anchor.click();
                    anchor.remove();
                    URL.revokeObjectURL(href);

                    button.textContent = 'Banana ready!';
                    window.setTimeout(restoreLabel, 1200);
                } catch (error) {
                    console.error('Unable to download banana image', error);
                    button.textContent = 'Download failed. Try again';
                    window.setTimeout(restoreLabel, 1800);
                }
            });
        })();

        (function setupAccountMenu() {
            const menu = document.querySelector('[data-account-menu]');
            if (!menu) {
                return;
            }

            const trigger = menu.querySelector('[data-account-trigger]');
            const dropdown = menu.querySelector('[data-account-dropdown]');
            const avatar = menu.querySelector('[data-account-avatar]');
            const nameEl = menu.querySelector('[data-account-name]');
            const statusEl = menu.querySelector('[data-account-status]');
            const signInButton = menu.querySelector('[data-account-action="signin"]');
            const signOutButton = menu.querySelector('[data-account-action="signout"]');

            if (!trigger || !dropdown || !avatar || !nameEl || !statusEl || !signInButton || !signOutButton) {
                return;
            }

            const storageKey = 'ak-account-profile';
            let storageAvailable = true;
            let isOpen = false;
            let account = null;

            function normalizeName(value) {
                if (typeof value !== 'string') {
                    return '';
                }

                return value.replace(/\s+/g, ' ').trim();
            }

            function getInitial(name) {
                const normalized = normalizeName(name);
                if (!normalized) {
                    return 'G';
                }

                return normalized.charAt(0).toUpperCase();
            }

            function updateUI() {
                const isSignedIn = Boolean(account && account.name);
                menu.dataset.state = isSignedIn ? 'signed-in' : 'signed-out';
                avatar.textContent = isSignedIn ? getInitial(account.name) : 'G';
                nameEl.textContent = isSignedIn ? account.name : 'Guest';

                const statusText = isSignedIn ? 'Signed in' : 'Signed out';
                statusEl.textContent = storageAvailable ? statusText : `${statusText} • not saved`;

                signInButton.hidden = isSignedIn;
                signOutButton.hidden = !isSignedIn;

                const ariaLabel = isSignedIn
                    ? `Open account menu for ${account.name}`
                    : 'Open account menu. You are signed out.';
                trigger.setAttribute('aria-label', ariaLabel);
            }

            function loadAccount() {
                if (!storageAvailable) {
                    return null;
                }

                try {
                    const stored = window.localStorage.getItem(storageKey);
                    if (!stored) {
                        return null;
                    }

                    const parsed = JSON.parse(stored);
                    if (parsed && typeof parsed === 'object' && 'name' in parsed) {
                        const normalizedName = normalizeName(parsed.name);
                        if (normalizedName) {
                            return { name: normalizedName };
                        }
                    }
                } catch (error) {
                    storageAvailable = false;
                    console.warn('Account state unavailable', error);
                }

                return null;
            }

            function persistAccount(value) {
                if (!storageAvailable) {
                    return;
                }

                try {
                    if (value && value.name) {
                        window.localStorage.setItem(storageKey, JSON.stringify({ name: value.name }));
                    } else {
                        window.localStorage.removeItem(storageKey);
                    }
                } catch (error) {
                    storageAvailable = false;
                    console.warn('Unable to persist account state', error);
                    updateUI();
                }
            }

            function closeMenu(options = {}) {
                const { focusTrigger = false } = options;

                if (!isOpen) {
                    if (focusTrigger) {
                        trigger.focus();
                    }
                    return;
                }

                isOpen = false;
                menu.classList.remove('is-open');
                dropdown.hidden = true;
                trigger.setAttribute('aria-expanded', 'false');
                document.removeEventListener('pointerdown', handlePointerDown, true);
                document.removeEventListener('keydown', handleKeydown, true);

                if (focusTrigger) {
                    trigger.focus();
                }
            }

            function openMenu() {
                if (isOpen) {
                    return;
                }

                isOpen = true;
                dropdown.hidden = false;
                menu.classList.add('is-open');
                trigger.setAttribute('aria-expanded', 'true');

                document.addEventListener('pointerdown', handlePointerDown, true);
                document.addEventListener('keydown', handleKeydown, true);

                const firstAction = dropdown.querySelector('[data-account-action]:not([hidden])');
                if (firstAction instanceof HTMLElement) {
                    window.requestAnimationFrame(() => {
                        firstAction.focus();
                    });
                }
            }

            function handlePointerDown(event) {
                if (!menu.contains(event.target)) {
                    closeMenu();
                }
            }

            function handleKeydown(event) {
                if (!isOpen) {
                    return;
                }

                if (event.key === 'Escape') {
                    event.preventDefault();
                    closeMenu({ focusTrigger: true });
                    return;
                }

                if (event.key === 'Tab') {
                    const focusable = Array.from(
                        dropdown.querySelectorAll('[data-account-action]:not([hidden])')
                    );

                    if (focusable.length === 0) {
                        return;
                    }

                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];

                    if (!event.shiftKey && document.activeElement === last) {
                        event.preventDefault();
                        first.focus();
                    } else if (event.shiftKey && document.activeElement === first) {
                        event.preventDefault();
                        last.focus();
                    }
                }
            }

            trigger.addEventListener('click', () => {
                if (isOpen) {
                    closeMenu();
                } else {
                    openMenu();
                }
            });

            trigger.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    openMenu();
                }
            });

            signInButton.addEventListener('click', () => {
                closeMenu();
                const input = window.prompt('Enter your display name to sign in:', account?.name ?? '');
                if (input === null) {
                    trigger.focus();
                    return;
                }

                const normalizedName = normalizeName(input);
                if (!normalizedName) {
                    trigger.focus();
                    return;
                }

                account = { name: normalizedName };
                persistAccount(account);
                updateUI();
                trigger.focus();
            });

            signOutButton.addEventListener('click', () => {
                account = null;
                persistAccount(account);
                updateUI();
                closeMenu({ focusTrigger: true });
            });

            account = loadAccount();
            updateUI();
        })();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRniZatGeylxphjHQadYjucOcirNBRIdk",
            authDomain: "multiplayer-640ec.firebaseapp.com",
            databaseURL: "https://multiplayer-640ec-default-rtdb.firebaseio.com",
            projectId: "multiplayer-640ec",
            storageBucket: "multiplayer-640ec.firebasestorage.app",
            messagingSenderId: "94914236381",
            appId: "1:94914236381:web:55ab00cc690140180cf034",
            measurementId: "G-V43J1S8RGF"
        };

        const app = initializeApp(firebaseConfig);
        isSupported()
            .then((supported) => {
                if (supported) {
                    getAnalytics(app);
                }
            })
            .catch((err) => console.warn("Firebase analytics not supported", err));

        const outfits = [
            { id: 'classic', name: 'Cozy Classic', description: 'The baseline guild tunic.', price: 0 },
            { id: 'hoodie', name: 'Midnight Hoodie', description: 'Urban stealth with neon trim.', price: 1 },
            { id: 'adventurer', name: 'Adventurer Cape', description: 'Ready for future expeditions.', price: 2 }
        ];

        const avatarCard = document.querySelector('[data-avatar-card]');
        const avatarPreview = avatarCard?.querySelector('.rat-avatar') ?? null;
        const closet = avatarCard?.querySelector('[data-avatar-closet]') ?? null;
        const closetToggle = closet?.querySelector('[data-closet-toggle]') ?? null;
        const closetMenu = closet?.querySelector('[data-closet-menu]') ?? null;
        const closetList = closet?.querySelector('[data-closet-list]') ?? null;
        const closetEmpty = closet?.querySelector('[data-closet-empty]') ?? null;
        const currentOutfitLabel = avatarCard?.querySelector('[data-current-outfit]') ?? null;
        const currencyDisplay = document.querySelector('[data-currency-balance]');
        const currencyAmount = currencyDisplay?.querySelector('[data-currency-amount]') ?? null;

        if (!avatarCard || !avatarPreview || !closet || !closetToggle || !closetMenu || !closetList || !currentOutfitLabel) {
            if (currencyAmount) {
                currencyAmount.textContent = '—';
            }
            return;
        }

        const outfitById = new Map(outfits.map((outfit) => [outfit.id, outfit]));
        const closetEntries = new Map();

        outfits.forEach((outfit) => {
            const item = document.createElement('li');
            item.className = 'closet-item';
            item.dataset.outfit = outfit.id;

            const body = document.createElement('div');
            body.className = 'closet-item__body';

            const name = document.createElement('span');
            name.className = 'closet-item__name';
            name.textContent = outfit.name;
            body.appendChild(name);

            if (outfit.description) {
                const description = document.createElement('p');
                description.className = 'closet-item__description';
                description.textContent = outfit.description;
                body.appendChild(description);
            }

            const footer = document.createElement('div');
            footer.className = 'closet-item__footer';

            const status = document.createElement('span');
            status.className = 'closet-item__status';
            status.setAttribute('data-closet-status', '');
            footer.appendChild(status);

            const action = document.createElement('button');
            action.type = 'button';
            action.className = 'closet-item__action';
            action.setAttribute('data-closet-action', '');
            action.textContent = 'Wear';
            footer.appendChild(action);

            item.appendChild(body);
            item.appendChild(footer);
            closetList.appendChild(item);

            closetEntries.set(outfit.id, {
                element: item,
                status,
                button: action
            });
        });

        const outfitStorageKey = 'ak-avatar-outfit';
        const walletStorageKey = 'ak-wallet-coins';
        const ownedStorageKey = 'ak-avatar-owned-outfits';
        const defaultOutfit = 'classic';
        const defaultCoins = 1;
        const defaultOwnedOutfits = new Set([defaultOutfit]);

        let storageAvailable = true;
        let coins = defaultCoins;
        let ownedOutfits = new Set(defaultOwnedOutfits);
        let currentOutfit = defaultOutfit;
        let closetIsOpen = false;

        function loadCoins() {
            if (!storageAvailable) {
                return defaultCoins;
            }

            try {
                const stored = window.localStorage.getItem(walletStorageKey);
                if (!stored) {
                    return defaultCoins;
                }

                const parsed = Number.parseInt(stored, 10);
                if (Number.isFinite(parsed) && parsed >= 0) {
                    return parsed;
                }
            } catch (error) {
                storageAvailable = false;
                console.warn('Wallet state unavailable', error);
            }

            return defaultCoins;
        }

        function persistCoins(value) {
            if (!storageAvailable) {
                return;
            }

            try {
                window.localStorage.setItem(walletStorageKey, String(value));
            } catch (error) {
                storageAvailable = false;
                console.warn('Unable to save coin balance', error);
            }
        }

        function loadOwnedOutfits() {
            const owned = new Set(defaultOwnedOutfits);
            if (!storageAvailable) {
                return owned;
            }

            try {
                const stored = window.localStorage.getItem(ownedStorageKey);
                if (!stored) {
                    return owned;
                }

                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed)) {
                    parsed.forEach((value) => {
                        if (typeof value === 'string' && value) {
                            owned.add(value);
                        }
                    });
                }
            } catch (error) {
                storageAvailable = false;
                console.warn('Avatar shop ownership unavailable', error);
            }

            return owned;
        }

        function persistOwnedOutfits(owned) {
            if (!storageAvailable) {
                return;
            }

            try {
                const value = JSON.stringify(Array.from(owned));
                window.localStorage.setItem(ownedStorageKey, value);
            } catch (error) {
                storageAvailable = false;
                console.warn('Unable to save owned outfits', error);
            }
        }

        function loadOutfit() {
            if (!storageAvailable) {
                return defaultOutfit;
            }

            try {
                const stored = window.localStorage.getItem(outfitStorageKey);
                if (stored) {
                    return stored;
                }
            } catch (error) {
                storageAvailable = false;
                console.warn('Avatar outfit storage unavailable', error);
            }

            return defaultOutfit;
        }

        function persistOutfit(value) {
            if (!storageAvailable) {
                return;
            }

            try {
                window.localStorage.setItem(outfitStorageKey, value);
            } catch (error) {
                storageAvailable = false;
                console.warn('Unable to save outfit selection', error);
            }
        }

        function updateCurrencyUI() {
            if (!currencyAmount) {
                return;
            }

            const label = coins === 1 ? 'coin' : 'coins';
            currencyAmount.textContent = `${coins} ${label}`;
        }

        function applyOutfit(value) {
            const next = value && outfitById.has(value) ? value : defaultOutfit;
            avatarPreview.dataset.outfit = next;
            currentOutfit = next;
            return next;
        }

        function updateCurrentOutfitSummary() {
            const details = outfitById.get(currentOutfit) ?? outfitById.get(defaultOutfit);
            const fallback = outfitById.get(defaultOutfit)?.name ?? 'Cozy Classic';
            currentOutfitLabel.textContent = `Currently wearing: ${details?.name ?? fallback}`;
        }

        function updateClosetUI() {
            let ownedCount = 0;

            closetEntries.forEach((entry, outfitId) => {
                const owned = ownedOutfits.has(outfitId);
                entry.element.hidden = !owned;
                entry.element.classList.toggle('is-selected', currentOutfit === outfitId);

                if (!owned) {
                    return;
                }

                ownedCount += 1;

                if (entry.status) {
                    entry.status.textContent = currentOutfit === outfitId ? 'Currently wearing' : 'Owned';
                }

                if (entry.button) {
                    entry.button.disabled = currentOutfit === outfitId;
                    entry.button.textContent = currentOutfit === outfitId ? 'Equipped' : 'Wear';
                }
            });

            if (closetEmpty) {
                closetEmpty.hidden = ownedCount > 0;
            }

            const disabled = ownedCount === 0;
            closetToggle.disabled = disabled;
            closetToggle.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        }

        function openCloset() {
            if (closetIsOpen) {
                return;
            }

            closetIsOpen = true;
            closet.classList.add('is-open');
            closetMenu.hidden = false;
            closetToggle.setAttribute('aria-expanded', 'true');

            document.addEventListener('pointerdown', handlePointerDown, true);
            document.addEventListener('keydown', handleClosetKeydown, true);

            const focusable = closetMenu.querySelector('[data-closet-action]:not([disabled])');
            if (focusable instanceof HTMLElement) {
                window.requestAnimationFrame(() => {
                    focusable.focus();
                });
            }
        }

        function closeCloset(options = {}) {
            const { focusToggle = false } = options;

            if (!closetIsOpen) {
                if (focusToggle) {
                    closetToggle.focus();
                }
                return;
            }

            closetIsOpen = false;
            closet.classList.remove('is-open');
            closetMenu.hidden = true;
            closetToggle.setAttribute('aria-expanded', 'false');
            document.removeEventListener('pointerdown', handlePointerDown, true);
            document.removeEventListener('keydown', handleClosetKeydown, true);

            if (focusToggle) {
                closetToggle.focus();
            }
        }

        function handlePointerDown(event) {
            if (!closet.contains(event.target)) {
                closeCloset();
            }
        }

        function handleClosetKeydown(event) {
            if (!closetIsOpen) {
                return;
            }

            if (event.key === 'Escape') {
                event.preventDefault();
                closeCloset({ focusToggle: true });
                return;
            }

            if (event.key === 'Tab') {
                const focusable = Array.from(
                    closetMenu.querySelectorAll('[data-closet-action]:not([disabled])')
                );

                if (focusable.length === 0) {
                    return;
                }

                const first = focusable[0];
                const last = focusable[focusable.length - 1];

                if (!event.shiftKey && document.activeElement === last) {
                    event.preventDefault();
                    first.focus();
                } else if (event.shiftKey && document.activeElement === first) {
                    event.preventDefault();
                    last.focus();
                }
            }
        }

        closetToggle.addEventListener('click', () => {
            if (closetIsOpen) {
                closeCloset();
            } else {
                openCloset();
            }
        });

        closetToggle.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                openCloset();
            }
        });

        closetList.addEventListener('click', (event) => {
            const button = event.target instanceof HTMLElement
                ? event.target.closest('[data-closet-action]')
                : null;

            if (!(button instanceof HTMLButtonElement)) {
                return;
            }

            const item = button.closest('.closet-item');
            if (!item) {
                return;
            }

            const outfit = item.dataset.outfit;
            if (!outfit || !ownedOutfits.has(outfit)) {
                return;
            }

            if (currentOutfit === outfit) {
                closeCloset({ focusToggle: true });
                return;
            }

            const applied = applyOutfit(outfit);
            persistOutfit(applied);
            updateClosetUI();
            updateCurrentOutfitSummary();
            closeCloset({ focusToggle: true });
        });

        coins = loadCoins();
        ownedOutfits = loadOwnedOutfits();
        const storedOutfit = loadOutfit();
        const appliedOutfit = applyOutfit(storedOutfit);
        if (!ownedOutfits.has(appliedOutfit)) {
            ownedOutfits.add(appliedOutfit);
            persistOwnedOutfits(ownedOutfits);
        }
        if (appliedOutfit !== storedOutfit) {
            persistOutfit(appliedOutfit);
        }

        updateCurrencyUI();
        updateClosetUI();
        updateCurrentOutfitSummary();
        closeCloset();

        window.addEventListener('storage', (event) => {
            if (!event) {
                return;
            }

            if (event.key === walletStorageKey) {
                coins = loadCoins();
                updateCurrencyUI();
            } else if (event.key === ownedStorageKey) {
                ownedOutfits = loadOwnedOutfits();
                updateClosetUI();
            } else if (event.key === outfitStorageKey) {
                const next = applyOutfit(loadOutfit());
                if (!ownedOutfits.has(next)) {
                    ownedOutfits.add(next);
                    persistOwnedOutfits(ownedOutfits);
                }
                updateCurrentOutfitSummary();
                updateClosetUI();
            }
        });
    </script>
</body>
</html>
