<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LoL Champion Checklist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #22c55e;
      --text: #e2e8f0;
      --muted: #94a3b8;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.5rem;
      background: rgba(15, 23, 42, 0.8);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .controls-row {
      align-items: flex-end;
    }
    h1 {
      font-size: 1.25rem;
      margin: 0;
    }
    #controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    button {
      background: #334155;
      border: none;
      color: var(--text);
      padding: 0.4rem 0.8rem;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    button:hover {
      background: #475569;
    }
    #sortCompleted.active {
      background: var(--accent);
      color: #0f172a;
    }
    #status {
      font-size: 0.8rem;
      color: var(--muted);
    }
    #account-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    #account-controls label {
      font-size: 0.85rem;
      color: var(--muted);
    }
    #accountSelect,
    #newAccount {
      padding: 0.35rem 0.6rem;
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.3);
      color: var(--text);
    }
    #accountSelect:disabled {
      opacity: 0.6;
    }
    #accountMessage {
      font-size: 0.75rem;
      color: var(--muted);
      min-width: 12ch;
    }
    main {
      padding: 1rem;
      flex: 1 1 auto;
    }
    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 0.75rem;
    }
    .champ {
      background: var(--card);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 0.5rem;
      padding: 0.35rem;
      text-align: center;
      cursor: pointer;
      transition: transform 0.1s ease, border 0.1s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }
    .champ:hover {
      transform: translateY(-2px);
      border: 1px solid rgba(226, 232, 240, 0.4);
    }
    .champ img {
      width: 64px;
      height: 64px;
      border-radius: 0.35rem;
      object-fit: cover;
      background: #0f172a;
    }
    .champ span {
      font-size: 0.7rem;
      line-height: 1.1;
      word-break: break-word;
    }
    .checked {
      border: 1px solid rgba(34, 197, 94, 0.8);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
      opacity: 0.7;
      position: relative;
    }
    .checked::after {
      content: "âœ“";
      position: absolute;
      top: 4px;
      right: 6px;
      background: var(--accent);
      color: #0f172a;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      font-size: 0.75rem;
      display: grid;
      place-items: center;
      font-weight: 700;
    }
    #loader {
      text-align: center;
      margin-top: 3rem;
      color: var(--muted);
    }
    #search {
      padding: 0.35rem 0.6rem;
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.3);
      color: var(--text);
    }
    @media (max-width: 500px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      #grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <h1>LoL Win-Tracker</h1>
      <div id="account-controls">
        <label for="accountSelect">Account</label>
        <select id="accountSelect" disabled></select>
        <input
          id="newAccount"
          type="text"
          placeholder="New username"
          aria-label="Create new account"
        />
        <button id="addAccount">Add</button>
        <div id="accountMessage" aria-live="polite"></div>
      </div>
    </div>
    <div class="header-row controls-row">
      <div id="controls">
        <input id="search" type="text" placeholder="Search champ..." disabled />
        <button id="clear" disabled>Clear all</button>
        <button id="sortCompleted" disabled aria-pressed="false">Completed first</button>
      </div>
      <div id="status">Loading championsâ€¦</div>
    </div>
  </header>
  <main>
    <div id="loader">Fetching champions from Data Dragonâ€¦</div>
    <div id="grid" hidden></div>
  </main>

  <script>
    // storage keys
    const LEGACY_STORAGE_KEY = "lol-champ-checklist-v1";
    const ACCOUNT_STORAGE_KEY = "lol-champ-accounts-v1";
    const ACTIVE_USER_KEY = "lol-champ-active-user";

    const statusEl = document.getElementById("status");
    const gridEl = document.getElementById("grid");
    const loaderEl = document.getElementById("loader");
    const clearBtn = document.getElementById("clear");
    const searchInput = document.getElementById("search");
    const sortCompletedBtn = document.getElementById("sortCompleted");
    const accountSelect = document.getElementById("accountSelect");
    const newAccountInput = document.getElementById("newAccount");
    const addAccountBtn = document.getElementById("addAccount");
    const accountMessageEl = document.getElementById("accountMessage");

    function safeParse(json, fallback) {
      try {
        const parsed = JSON.parse(json);
        return parsed ?? fallback;
      } catch {
        return fallback;
      }
    }

    let accounts = safeParse(localStorage.getItem(ACCOUNT_STORAGE_KEY), {});
    if (typeof accounts !== "object" || accounts === null || Array.isArray(accounts)) {
      accounts = {};
    }
    let activeUser = localStorage.getItem(ACTIVE_USER_KEY) || null;
    let checked = new Set();
    let champsList = [];
    let filterText = "";
    let completedFirst = false;

    function setAccountMessage(message = "", isError = false) {
      accountMessageEl.textContent = message;
      accountMessageEl.style.color = isError ? "#f87171" : "var(--muted)";
    }

    function persistAccounts() {
      localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(accounts));
    }

    function ensureAccount(username) {
      if (!accounts[username]) {
        accounts[username] = { checked: [] };
        persistAccounts();
      }
    }

    function populateAccountSelect() {
      accountSelect.innerHTML = "";
      Object.keys(accounts).forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        accountSelect.appendChild(option);
      });
      accountSelect.disabled = accountSelect.options.length === 0;
      if (activeUser && accounts[activeUser]) {
        accountSelect.value = activeUser;
      }
    }

    function applyCheckedToGrid() {
      renderGrid();
    }

    function setActiveUser(username) {
      ensureAccount(username);
      activeUser = username;
      localStorage.setItem(ACTIVE_USER_KEY, activeUser);
      const saved = accounts[activeUser]?.checked || [];
      checked = new Set(saved);
      if (accountSelect.value !== activeUser) {
        accountSelect.value = activeUser;
      }
      applyCheckedToGrid();
      setAccountMessage(`Tracking wins for ${activeUser}.`);
    }

    if (!activeUser || !accounts[activeUser]) {
      const existingUsers = Object.keys(accounts);
      if (existingUsers.length === 0) {
        activeUser = "Default";
        accounts[activeUser] = { checked: [] };
        persistAccounts();
      } else {
        activeUser = existingUsers[0];
      }
      localStorage.setItem(ACTIVE_USER_KEY, activeUser);
    }

    // migrate legacy single-account data if present
    const legacyChecked = safeParse(localStorage.getItem(LEGACY_STORAGE_KEY), []);
    if (Array.isArray(legacyChecked) && legacyChecked.length > 0) {
      ensureAccount(activeUser);
      accounts[activeUser].checked = legacyChecked;
      persistAccounts();
    }
    localStorage.removeItem(LEGACY_STORAGE_KEY);

    checked = new Set(accounts[activeUser]?.checked || []);
    populateAccountSelect();
    setAccountMessage(`Tracking wins for ${activeUser}.`);

    accountSelect.addEventListener("change", () => {
      const selected = accountSelect.value;
      if (selected) {
        setActiveUser(selected);
      }
    });

    addAccountBtn.addEventListener("click", () => {
      const newName = newAccountInput.value.trim();
      if (!newName) {
        setAccountMessage("Enter a username to add.", true);
        return;
      }
      const exists = Object.keys(accounts).some(
        (name) => name.toLowerCase() === newName.toLowerCase()
      );
      if (exists) {
        setAccountMessage("That username already exists.", true);
        return;
      }
      accounts[newName] = { checked: [] };
      persistAccounts();
      populateAccountSelect();
      newAccountInput.value = "";
      setActiveUser(newName);
    });

    newAccountInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        addAccountBtn.click();
      }
    });

    function setControlsEnabled(enabled) {
      clearBtn.disabled = !enabled;
      searchInput.disabled = !enabled;
      sortCompletedBtn.disabled = !enabled;
    }

    setControlsEnabled(false);
    statusEl.textContent = "Loading championsâ€¦";

    function saveChecked() {
      ensureAccount(activeUser);
      accounts[activeUser].checked = [...checked];
      persistAccounts();
      localStorage.setItem(ACTIVE_USER_KEY, activeUser);
      updateStatus(champsList.length);
    }

    function updateStatus(total) {
      const count = checked.size;
      let totalCount;
      if (typeof total === "number") {
        totalCount = total;
      } else if (champsList.length > 0) {
        totalCount = champsList.length;
      } else {
        totalCount = gridEl.children.length;
      }
      statusEl.textContent = `${count} / ${totalCount} marked`;
    }

    function renderGrid() {
      if (!Array.isArray(champsList) || champsList.length === 0) {
        return;
      }

      sortCompletedBtn.classList.toggle("active", completedFirst);
      sortCompletedBtn.setAttribute("aria-pressed", completedFirst ? "true" : "false");

      const query = filterText.trim().toLowerCase();
      const filtered = champsList.filter((champ) =>
        champ.name.toLowerCase().includes(query)
      );

      const toRender = completedFirst ? [...filtered] : filtered;
      if (completedFirst) {
        toRender.sort((a, b) => {
          const aChecked = checked.has(a.id);
          const bChecked = checked.has(b.id);
          if (aChecked === bChecked) {
            return a.name.localeCompare(b.name);
          }
          return aChecked ? -1 : 1;
        });
      }

      gridEl.innerHTML = "";

      toRender.forEach((champ) => {
        const div = document.createElement("div");
        div.className = "champ";
        div.dataset.champId = champ.id.toString();

        const img = document.createElement("img");
        img.src = champ.imgUrl;
        img.alt = champ.name;

        const span = document.createElement("span");
        span.textContent = champ.name;

        if (checked.has(champ.id)) {
          div.classList.add("checked");
        }

        div.appendChild(img);
        div.appendChild(span);

        div.addEventListener("click", () => {
          if (checked.has(champ.id)) {
            checked.delete(champ.id);
          } else {
            checked.add(champ.id);
          }
          saveChecked();
          renderGrid();
        });

        gridEl.appendChild(div);
      });

      updateStatus(champsList.length);
    }

    async function loadChamps() {
      try {
        // 1) get latest version
        const versionsRes = await fetch("https://ddragon.leagueoflegends.com/api/versions.json");
        const versions = await versionsRes.json();
        const latest = versions[0]; // newest patch

        // 2) get champion data
        const champsRes = await fetch(
          `https://ddragon.leagueoflegends.com/cdn/${latest}/data/en_US/champion.json`
        );
        const champsJson = await champsRes.json();
        const data = champsJson.data; // object keyed by champ id (Aatrox, Ahri, ...)
        const champs = Object.values(data)
          .map((champ) => ({
            ...champ,
            imgUrl: `https://ddragon.leagueoflegends.com/cdn/${latest}/img/champion/${champ.image.full}`,
          }))
          .sort((a, b) => a.name.localeCompare(b.name));

        champsList = champs;
        renderGrid();

        loaderEl.hidden = true;
        gridEl.hidden = false;
        setControlsEnabled(true);
        updateStatus(champs.length);

        // hook up search
        searchInput.addEventListener("input", () => {
          filterText = searchInput.value;
          renderGrid();
        });

        // clear button
        clearBtn.addEventListener("click", () => {
          checked.clear();
          saveChecked();
          renderGrid();
        });

        sortCompletedBtn.addEventListener("click", () => {
          completedFirst = !completedFirst;
          renderGrid();
        });
      } catch (err) {
        loaderEl.textContent = "Failed to load champions ðŸ˜¢";
        statusEl.textContent = "Unable to load champions.";
        console.error(err);
        throw err;
      }
    }

    (async () => {
      loaderEl.hidden = false;
      loaderEl.textContent = "Fetching champions from Data Dragonâ€¦";
      try {
        await loadChamps();
      } catch (error) {
        // already handled in loadChamps
      }
    })();
  </script>
</body>
</html>
