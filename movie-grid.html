<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3×3 Image Grid Uploader</title>
  <style>
    :root{
      --bg:#12040d;        /* page background */
      --card:#1c0a14;      /* grid background */
      --line:#3a1827;      /* grid line */
      --ring:#ff9fd7;      /* focus ring */
      --text:#f9ecff;      /* text */
      --muted:#d5b4c9;     /* subtler text */
      --btn:#23101a;       /* button bg */
      --btn-hover:#2e1823; /* hover */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:
        radial-gradient(1100px 780px at 78% -8%, rgba(122, 41, 88, .38) 0%, rgba(18, 4, 13, 0) 62%),
        radial-gradient(900px 680px at 8% 8%, rgba(90, 30, 70, .42) 0%, rgba(18, 4, 13, 0) 60%),
        radial-gradient(600px 420px at 50% 120%, rgba(160, 65, 105, .25) 0%, rgba(18, 4, 13, 0) 70%),
        linear-gradient(160deg, #14050f 0%, #0d0208 38%, #180713 100%);
      display:flex; flex-direction:column; align-items:center; gap:20px; padding:24px;
    }
    h1{font-size:clamp(20px, 2.4vw, 28px); margin:0 0 8px}
    .sub{color:var(--muted); margin:0 0 8px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
    .search{width:min(92vw, 920px); background:rgba(17,21,27,.75); border:1px solid var(--line); border-radius:14px; padding:14px 18px; box-shadow:0 20px 40px rgba(0,0,0,.35); display:flex; flex-direction:column; gap:10px}
    .search-row{display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr))}
    .field{display:flex; flex-direction:column; gap:6px; font-size:14px; color:var(--muted)}
    .field span{font-weight:600; text-transform:uppercase; letter-spacing:.05em; font-size:12px}
    .field input{background:var(--btn); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:15px}
    .field input:focus-visible{outline:2px solid var(--ring); outline-offset:2px}
    .field.query{grid-column:span 2}
    .query-input{display:flex; gap:10px}
    .query-input input{flex:1}
    .button.inline{display:inline-flex; align-items:center; justify-content:center; white-space:nowrap; padding:0 18px; height:42px}
    @media(max-width:720px){
      .field.query{grid-column:span 1}
      .query-input{flex-direction:column}
      .button.inline{width:100%; height:44px}
    }
    .results{width:min(92vw, 920px); display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:12px}
    .results[aria-busy="true"]{opacity:.7}
    .result-card{border:1px solid var(--line); background:var(--card); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; cursor:pointer; padding:0; text-align:left; color:var(--text); box-shadow:0 12px 30px rgba(0,0,0,.25); transition:transform .1s ease, border-color .1s ease}
    .result-card:hover{transform:translateY(-2px); border-color:var(--ring)}
    .result-card img{width:100%; height:140px; object-fit:cover}
    .result-info{padding:10px 12px; font-size:13px; color:var(--muted); line-height:1.4}
    .result-info b{display:block; color:var(--text); margin-bottom:4px; font-size:14px}
    button, label.button{
      border:1px solid var(--line); background:var(--btn); color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; 
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none; display:inline-flex; align-items:center; gap:8px;
    }
    button:hover, label.button:hover{background:var(--btn-hover)}
    button:active, label.button:active{transform:translateY(1px)}
    button:focus-visible, label.button:focus-visible{outline:2px solid var(--ring); outline-offset:2px}

    /* GRID WRAPPER */
    .grid-wrap{width:min(92vw, 920px);}
    .grid{
      background:var(--card);
      display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; padding:10px; border-radius:16px; border:1px solid var(--line);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }

    /* Each cell maintains a square via aspect-ratio */
    .cell{
      position:relative; aspect-ratio:1/1; border-radius:12px; overflow:hidden; border:1px dashed #2a3a54;
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:grid; place-items:center; color:var(--muted);
    }
    .cell:hover{border-color:#3c5278}

    .cell input[type=file]{display:none}

    .prompt{ text-align:center; padding:8px; }
    .prompt svg{width:28px; height:28px; opacity:.8; display:block; margin:0 auto 8px}
    .prompt b{color:#c7d7ff}

    /* Image preview */
    .preview{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}

    /* Controls inside cell */
    .controls{position:absolute; inset:auto 8px 8px auto; display:flex; gap:6px; opacity:0; transition:opacity .2s ease}
    .cell:hover .controls{opacity:1}
    .icon-btn{
      border:1px solid var(--line); background:rgba(15,18,22,.75); backdrop-filter:blur(6px);
      width:34px; height:34px; border-radius:9px; display:inline-grid; place-items:center; cursor:pointer;
    }
    .icon-btn:hover{background:rgba(28,35,48,.85)}
    .icon-btn svg{width:18px; height:18px; fill:#e8eef6}

    /* Keyboard focus style for cells */
    .cell:focus-within{outline:2px solid var(--ring); outline-offset:2px}

    .search-hint{font-size:13px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>3×3 Image Grid Uploader</h1>
  </header>

  <div class="toolbar" aria-label="Toolbar">
    <label class="button" for="bulkInput" title="Add images; they will fill empty cells left-to-right, top-to-bottom.">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Add multiple images
    </label>
    <input id="bulkInput" type="file" accept="image/*" multiple />

    <button id="resetGrid" type="button" title="Clear all images from the grid">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18M6 6v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6M9 6V4a3 3 0 0 1 3-3v0a3 3 0 0 1 3 3v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Reset grid
    </button>
  </div>

  <form id="imageSearch" class="search" aria-label="Google Image Search">
    <div class="search-row">
      <label class="field" title="Google Custom Search API key">
        <span>API key</span>
        <input type="text" id="apiKey" name="apiKey" autocomplete="off" placeholder="Enter your API key" required />
      </label>
      <label class="field" title="Google Custom Search Engine ID (cx)">
        <span>Search engine ID</span>
        <input type="text" id="searchCx" name="searchCx" autocomplete="off" placeholder="Enter your CX" required />
      </label>
      <label class="field query" title="Search Google Images">
        <span>Search images</span>
        <div class="query-input">
          <input type="text" id="searchQuery" name="searchQuery" placeholder="e.g. cyberpunk city" required />
          <button type="submit" class="button inline">Search</button>
        </div>
      </label>
    </div>
    <p class="search-hint">Use a Google Custom Search API key and custom search engine (set to image search). Click a result to drop it into the grid.</p>
  </form>

  <section id="searchResults" class="results" aria-live="polite" aria-busy="false"></section>

  <main class="grid-wrap">
    <section class="grid" id="grid" aria-label="3 by 3 image grid">
      <!-- 9 cells generated by JS if you prefer; here we hardcode for clarity -->
      <div class="cell" data-index="0" tabindex="0">
        <img alt="" class="preview" hidden />
        <div class="prompt" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg>
          <div><b>Click</b> to upload<br/>or <b>drop</b> image here</div>
        </div>
        <div class="controls" aria-hidden="true">
          <button class="icon-btn replace" title="Replace image" aria-label="Replace image">
            <svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg>
          </button>
          <button class="icon-btn clear" title="Clear image" aria-label="Clear image">
            <svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg>
          </button>
        </div>
        <input type="file" accept="image/*" aria-label="Upload image for cell 1" />
      </div>

      <!-- Duplicate 8 more cells -->
      <div class="cell" data-index="1" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 2" /></div>
      <div class="cell" data-index="2" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 3" /></div>
      <div class="cell" data-index="3" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 4" /></div>
      <div class="cell" data-index="4" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 5" /></div>
      <div class="cell" data-index="5" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 6" /></div>
      <div class="cell" data-index="6" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 7" /></div>
      <div class="cell" data-index="7" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 8" /></div>
      <div class="cell" data-index="8" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/>or <b>drop</b> image here</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 9" /></div>
    </section>

  </main>

  <script>
    /**
     * Minimal, dependency‑free uploader for a 3×3 grid.
     * Features:
     *  - Click cell to pick an image
     *  - Drag & drop files onto cells
     *  - Replace / Clear per cell
     *  - Bulk add (fills empty cells)
     *  - Keyboard friendly (Tab into a cell, press Enter to open file picker)
     */

    const grid = document.getElementById('grid');
    const cells = Array.from(grid.querySelectorAll('.cell'));
    let hoveredCell = null;

    function setPreviewFromFile(cell, file){
      if(!file || !file.type.startsWith('image/')) return;
      const objectUrl = URL.createObjectURL(file);
      setCellImage(cell, { src: objectUrl, alt: file.name, revokeOnClear: true });
    }

    function setCellImage(cell, { src, alt = '', revokeOnClear = false }){
      const img = cell.querySelector('.preview');
      const prompt = cell.querySelector('.prompt');
      if(cell.dataset.revokeUrl && cell.dataset.revokeUrl !== src){
        URL.revokeObjectURL(cell.dataset.revokeUrl);
      }
      img.src = src;
      img.alt = alt;
      img.hidden = false;
      prompt.hidden = true;
      cell.dataset.filled = '1';
      if(revokeOnClear){
        cell.dataset.revokeUrl = src;
      }else{
        delete cell.dataset.revokeUrl;
      }
    }

    function clearCell(cell){
      const img = cell.querySelector('.preview');
      const input = cell.querySelector('input[type=file]');
      const prompt = cell.querySelector('.prompt');
      if(cell.dataset.revokeUrl){
        URL.revokeObjectURL(cell.dataset.revokeUrl);
        delete cell.dataset.revokeUrl;
      }
      img.removeAttribute('src');
      img.alt = '';
      img.hidden = true;
      prompt.hidden = false;
      input.value = '';
      delete cell.dataset.filled;
    }

    function openPicker(cell){
      const input = cell.querySelector('input[type=file]');
      input.click();
    }

    function getImageFromTransfer(transfer){
      if(!transfer) return null;
      const files = Array.from(transfer.files || []).filter(file=>file.type.startsWith('image/'));
      if(files.length) return files[0];
      const items = Array.from(transfer.items || []);
      for(const item of items){
        if(item.kind === 'file' && item.type.startsWith('image/')){
          const file = item.getAsFile();
          if(file) return file;
        }
      }
      return null;
    }

    function handlePasteEvent(e){
      const file = getImageFromTransfer(e.clipboardData);
      if(!file) return;
      e.preventDefault();
      const eventTargetCell = e.target?.closest?.('.cell');
      const activeCell = document.activeElement?.closest?.('.cell');
      const targetCell = eventTargetCell || hoveredCell || activeCell || cells.find(cell=>!cell.dataset.filled) || cells[0];
      if(targetCell){
        setPreviewFromFile(targetCell, file);
      }
    }

    // Per‑cell listeners
    cells.forEach((cell)=>{
      const input = cell.querySelector('input[type=file]');
      const replaceBtn = cell.querySelector('.replace');
      const clearBtn = cell.querySelector('.clear');

      cell.addEventListener('mouseenter', ()=>{ hoveredCell = cell; });
      cell.addEventListener('mouseleave', ()=>{ if(hoveredCell === cell) hoveredCell = null; });

      // Click empty area to pick file
      cell.addEventListener('click', (e)=>{
        // avoid clicks on control buttons bubbling
        if(e.target.closest('.controls')) return;
        openPicker(cell);
      });

      // Keyboard: Enter opens picker
      cell.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          openPicker(cell);
        }
      });

      // File picked
      input.addEventListener('change', (e)=>{
        const file = e.target.files?.[0];
        if(file) setPreviewFromFile(cell, file);
      });

      replaceBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openPicker(cell); });
      clearBtn.addEventListener('click', (e)=>{ e.stopPropagation(); clearCell(cell); });

      // Drag & drop
      ;['dragenter','dragover'].forEach(evt=>{
        cell.addEventListener(evt, (e)=>{ e.preventDefault(); cell.style.outline = '2px solid var(--ring)'; });
      });
      ;['dragleave','drop'].forEach(evt=>{
        cell.addEventListener(evt, (e)=>{ e.preventDefault(); cell.style.outline = ''; });
      });
      cell.addEventListener('drop', (e)=>{
        const file = e.dataTransfer?.files?.[0];
        if(file) setPreviewFromFile(cell, file);
      });

      cell.addEventListener('paste', handlePasteEvent);

      // Optional: Right‑click to clear
      cell.addEventListener('contextmenu', (e)=>{ e.preventDefault(); clearCell(cell); });
    });

    // Bulk add fills empty cells left‑to‑right, top‑to‑bottom
    const bulkInput = document.getElementById('bulkInput');
    bulkInput.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []).filter(f=>f.type.startsWith('image/'));
      if(!files.length) return;
      let i = 0;
      cells.forEach(cell=>{
        if(i >= files.length) return;
        if(!cell.dataset.filled){ setPreviewFromFile(cell, files[i++]); }
      });
      bulkInput.value = '';
    });

    // Reset all
    document.getElementById('resetGrid').addEventListener('click', ()=>{
      cells.forEach(clearCell);
    });

    document.addEventListener('paste', handlePasteEvent);

    const searchForm = document.getElementById('imageSearch');
    const searchResults = document.getElementById('searchResults');
    const apiKeyInput = document.getElementById('apiKey');
    const cxInput = document.getElementById('searchCx');
    const queryInput = document.getElementById('searchQuery');

    function getTargetCell(){
      return document.activeElement?.closest?.('.cell') || cells.find(cell=>!cell.dataset.filled) || cells[0];
    }

    function escapeHtml(value){
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderResults(items){
      if(!searchResults) return;
      searchResults.innerHTML = '';
      items.forEach((item, index)=>{
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'result-card';
        const hostname = item.image?.contextLink ? (()=>{ try{ return new URL(item.image.contextLink).hostname; }catch{ return ''; } })() : '';
        const title = item.title || 'Untitled image';
        const imageUrl = item.link || '';
        button.innerHTML = `
          <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title)}">
          <div class="result-info">
            <b>${escapeHtml(title)}</b>
            ${hostname ? `<span>${escapeHtml(hostname)}</span>` : ''}
          </div>
        `;
        button.addEventListener('click', ()=>{
          const target = getTargetCell();
          if(target){
            setCellImage(target, { src: imageUrl, alt: title });
            target.focus();
          }
        });
        searchResults.appendChild(button);
      });
    }

    function setStatus(message){
      if(searchResults){
        searchResults.innerHTML = `<div class="result-info">${message}</div>`;
      }
    }

    if(searchForm){
      searchForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const key = apiKeyInput.value.trim();
        const cx = cxInput.value.trim();
        const query = queryInput.value.trim();
        if(!key || !cx || !query){
          setStatus('Please provide API key, search engine ID, and a query.');
          return;
        }
        const params = new URLSearchParams({ key, cx, searchType: 'image', q: query });
        searchForm.setAttribute('aria-busy', 'true');
        searchResults?.setAttribute?.('aria-busy', 'true');
        setStatus('Searching for images…');
        try{
          const response = await fetch(`https://customsearch.googleapis.com/customsearch/v1?${params.toString()}`);
          if(!response.ok){
            throw new Error(`Request failed with status ${response.status}`);
          }
          const data = await response.json();
          const items = data.items || [];
          if(!items.length){
            setStatus('No image results found. Adjust your search terms and try again.');
            return;
          }
          renderResults(items);
        }catch(err){
          console.error(err);
          setStatus('Image search failed. Check your credentials and network connection.');
        }finally{
          searchForm.setAttribute('aria-busy', 'false');
          searchResults?.setAttribute?.('aria-busy', 'false');
        }
      });
    }
  </script>
</body>
</html>
