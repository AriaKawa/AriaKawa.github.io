<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blackjack — Aria & Friends Hub</title>
<style>
  :root{
    --felt:#0e4d37;            /* table background */
    --felt-dark:#0a3a2a;
    --line:#154f40;
    --card:#fff;
    --shadow:0 14px 30px rgba(0,0,0,.35);
    --accent:#ffd13b;          /* primary button */
    --accent-2:#161a24;        /* secondary button */
    --text:#e9f1ee;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    color:var(--text); background:#0b1020; display:grid; place-items:center;
  }
  .lobby-overlay{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(6,10,24,.82);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    z-index:10;
    transition:opacity .3s ease;
  }
  .lobby-overlay.is-hidden{
    opacity:0;
    pointer-events:none;
  }
  .lobby-card{
    width:min(92vw, 440px);
    background:rgba(10,18,32,.82);
    border:1px solid rgba(255,255,255,.12);
    border-radius:26px;
    padding:2.4rem clamp(1.4rem,4vw,2.6rem);
    box-shadow:0 28px 60px rgba(0,0,0,.45);
    display:grid;
    gap:1.6rem;
    text-align:center;
  }
  .lobby-card h2{margin:0; font-size:1.8rem; letter-spacing:.08em;}
  .lobby-subtitle{font-size:.95rem; opacity:.75; line-height:1.5;}
  .mode-grid{display:grid; gap:1.4rem;}
  .lobby-btn{
    display:inline-flex; align-items:center; justify-content:center;
    gap:.4rem;
    padding:.85rem 1.45rem;
    border-radius:999px;
    font-weight:700; letter-spacing:.05em;
    border:1px solid transparent;
    cursor:pointer;
    transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
    color:#0b1020;
  }
  .lobby-btn.primary{
    background:linear-gradient(135deg,#ffd13b,#ffef9a);
    box-shadow:0 16px 38px rgba(255,209,59,.25);
  }
  .lobby-btn.ghost{
    background:rgba(255,255,255,.08);
    color:#f0f6ff;
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 12px 28px rgba(0,0,0,.35);
  }
  .lobby-btn.small{padding:.65rem 1.1rem; font-size:.9rem;}
  .lobby-btn:disabled{opacity:.5; cursor:not-allowed;}
  .lobby-btn:not(:disabled):hover,
  .lobby-btn:not(:disabled):focus-visible{transform:translateY(-2px);}
  .multiplayer-card{
    background:rgba(0,0,0,.22);
    border-radius:22px;
    padding:1.6rem;
    display:grid;
    gap:1rem;
    text-align:left;
  }
  .multiplayer-card h3{margin:0; letter-spacing:.1em; font-size:1rem; text-transform:uppercase; opacity:.8;}
  .multiplayer-card p{margin:0; font-size:.92rem; opacity:.75; line-height:1.6;}
  .multiplayer-actions{display:flex; flex-wrap:wrap; gap:.6rem;}
  .host-panel,.join-form{
    background:rgba(7,12,22,.6);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    padding:1rem 1.1rem;
    display:grid;
    gap:.75rem;
  }
  .code-label{font-size:.8rem; letter-spacing:.16em; text-transform:uppercase; opacity:.6;}
  .code-chip{
    font-size:1.6rem; font-weight:700; letter-spacing:.34em;
    background:rgba(255,209,59,.16);
    color:#ffd13b;
    text-align:center;
    padding:.55rem 1rem;
    border-radius:16px;
    border:1px solid rgba(255,209,59,.38);
  }
  .join-form label{font-size:.78rem; letter-spacing:.14em; text-transform:uppercase; opacity:.65;}
  .join-input-row{display:flex; gap:.6rem; align-items:center;}
  .join-input-row input{
    flex:1;
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.22);
    border-radius:14px;
    padding:.55rem .9rem;
    font-size:1rem;
    letter-spacing:.24em;
    text-transform:uppercase;
    color:#f4f7fb;
  }
  .join-input-row input::placeholder{
    color:rgba(244,247,251,.55);
    letter-spacing:0;
    text-transform:none;
  }
  .join-input-row button{flex-shrink:0;}
  .lobby-status{
    min-height:1.2rem;
    font-size:.95rem;
    color:#ffd13b;
  }
  .hidden{display:none !important;}
  .table{
    position:relative; width:min(1100px, 96vw); aspect-ratio: 16/9;
    background: radial-gradient(120% 90% at 50% -15%, #208b6e 0, var(--felt) 32%, var(--felt-dark) 95%);
    border-radius:28px; box-shadow: var(--shadow);
    overflow:hidden; border:6px solid #0c3024;
  }
  .table::after{
    content:""; position:absolute; inset:20px;
    border:2px dashed rgba(255,255,255,.15); border-radius:22px; pointer-events:none;
  }
  header{
    position:absolute; top:14px; left:18px; right:18px; display:flex; align-items:center; gap:.75rem;
    z-index:3;
  }
  .brand{font-weight:800; letter-spacing:.08em; opacity:.9}
  .spacer{flex:1}
  .chip{
    font-variant-numeric:tabular-nums;
    background:linear-gradient(#ffe07a, #e3b312);
    color:#2a2100; font-weight:800; padding:.45rem .7rem; border-radius:999px; box-shadow: var(--shadow);
  }

  /* Lanes */
  .lane{ position:absolute; left:50%; transform:translateX(-50%); width:80%; }
  .dealer.lane{ top:10%; }
  .player.lane{ bottom:12%; }

  /* Card */
  .card{
    width:96px; height:136px; border-radius:12px; background:var(--card);
    box-shadow: var(--shadow); position:absolute; transition: transform .4s ease, top .4s ease, left .4s ease, opacity .3s ease;
    display:grid; place-items:center; overflow:hidden;
  }
  @media (max-width:720px){
    .card{ width:78px; height:112px; border-radius:10px; }
  }
  .card .svg{ width:94%; height:94%; }
  .back{
    background:repeating-linear-gradient(45deg, #1d2740, #1d2740 10px, #2b3a66 10px, #2b3a66 20px);
    border:3px solid #e5e9f6; position:absolute; inset:0; border-radius:12px;
  }

  /* Spots where cards settle */
  .spot{ position:relative; height:150px; }
  @media (max-width:720px){ .spot{ height:120px; } }

  /* Labels */
  .label{
    position:absolute; left:50%; transform:translateX(-50%);
    text-align:center; text-shadow:0 2px 8px rgba(0,0,0,.5);
  }
  .label.dealer{ top:4%; font-weight:700; opacity:.9 }
  .label.player{ bottom:6%; font-weight:700; opacity:.95 }
  .total{ font-size:1.05rem; opacity:.9 }

  /* Controls */
  .controls{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:3%; display:flex; gap:.6rem; z-index:3; flex-wrap:wrap; justify-content:center;
  }
  button{
    appearance:none; border:0; border-radius:14px; padding:.9rem 1.2rem;
    font-weight:800; box-shadow: var(--shadow); cursor:pointer; transition: transform .05s ease, filter .2s ease, opacity .2s ease;
  }
  button:active{ transform:translateY(1px) scale(.99) }
  .primary{ background:var(--accent); color:#1a1400 }
  .ghost{ background:var(--accent-2); color:#e9ecf5; border:1px solid rgba(255,255,255,.1) }
  .muted{ opacity:.6; pointer-events:none }

  /* Toast / status */
  .status{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    font-size:1.6rem; font-weight:800; letter-spacing:.02em; text-align:center;
    text-shadow:0 3px 30px rgba(0,0,0,.55); opacity:0; transition:opacity .2s ease;
    pointer-events:none; max-width:80%;
  }
  .status.show{ opacity:1 }

  /* Exit link */
  .back-link{
    position:absolute; top:16px; right:20px; z-index:4; display:inline-flex; align-items:center;
    gap:.4rem; font-size:.95rem; text-decoration:none; font-weight:600; color:var(--text);
    background:rgba(0,0,0,.35); padding:.45rem .8rem; border-radius:999px; transition:background .2s ease, transform .2s ease;
  }
  .back-link:hover{ background:rgba(0,0,0,.55); transform:translateY(-1px); }
</style>
</head>
<body>
  <a class="back-link" href="index.html">← Back to the friend hub</a>
  <div class="lobby-overlay" id="lobbyOverlay" role="dialog" aria-modal="true" aria-hidden="false">
    <div class="lobby-card">
      <div>
        <h2>Blackjack Lobby</h2>
        <p class="lobby-subtitle">Choose how you'd like to play before sitting at the table.</p>
      </div>
      <div class="mode-grid">
        <button class="lobby-btn primary" id="singleplayerBtn">Singleplayer</button>
        <div class="multiplayer-card">
          <h3>Play with a friend</h3>
          <p>Host a table to generate a shareable code, or join a friend by entering their invite code.</p>
          <div class="multiplayer-actions">
            <button class="lobby-btn ghost" id="hostBtn">Host</button>
            <button class="lobby-btn ghost small" id="joinToggle" aria-expanded="false" aria-controls="joinForm">Join by code</button>
          </div>
          <div class="host-panel hidden" id="hostPanel">
            <div class="code-label">Share this code</div>
            <div class="code-chip" id="hostCode">-----</div>
          </div>
          <form class="join-form hidden" id="joinForm" autocomplete="off">
            <label for="joinCodeInput">Enter invite code</label>
            <div class="join-input-row">
              <input id="joinCodeInput" name="joinCode" inputmode="text" autocomplete="off" autocapitalize="characters" maxlength="6" placeholder="e.g. 4KD82" />
              <button type="submit" class="lobby-btn primary small" id="joinSubmit">Join</button>
            </div>
          </form>
        </div>
      </div>
      <div class="lobby-status" id="lobbyStatus"></div>
    </div>
  </div>

  <div class="table" id="table">
    <header>
      <div class="brand">BLACKJACK • FRIENDS LOUNGE</div>
      <div class="spacer"></div>
      <div class="chip">Bank: <span id="bank">1000</span></div>
    </header>

    <div class="label dealer">Dealer • <span class="total" id="dealerTotal">0</span></div>
    <div class="lane dealer">
      <div class="spot" id="dealerSpot"></div>
    </div>

    <div class="label player">You • <span class="total" id="playerTotal">0</span></div>
    <div class="lane player">
      <div class="spot" id="playerSpot"></div>
    </div>

    <div class="status" id="status"></div>

    <div class="controls" id="controls">
      <button class="primary" id="btnDeal">Deal</button>
      <button class="primary muted" id="btnHit">Hit</button>
      <button class="ghost muted" id="btnStand">Stand</button>
      <button class="ghost" id="btnNew">New Shoe</button>
    </div>
  </div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js';
import { getAnalytics, isSupported as analyticsIsSupported } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js';
import { getDatabase, ref, set, update, onValue, onDisconnect, get, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js';

const firebaseConfig = {
  apiKey: 'AIzaSyDRniZatGeylxphjHQadYjucOcirNBRIdk',
  authDomain: 'multiplayer-640ec.firebaseapp.com',
  databaseURL: 'https://multiplayer-640ec-default-rtdb.firebaseio.com',
  projectId: 'multiplayer-640ec',
  storageBucket: 'multiplayer-640ec.firebasestorage.app',
  messagingSenderId: '94914236381',
  appId: '1:94914236381:web:55ab00cc690140180cf034',
  measurementId: 'G-V43J1S8RGF'
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

analyticsIsSupported()
  .then(supported => {
    if (supported) {
      getAnalytics(app);
    }
  })
  .catch(err => {
    console.warn('Analytics not available', err);
  });

const SUITS = ['♠','♥','♦','♣'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

function buildShoe(decks = 6) {
  const shoe = [];
  for (let d = 0; d < decks; d++) {
    for (const s of SUITS) {
      for (const r of RANKS) {
        shoe.push({ suit: s, rank: r });
      }
    }
  }
  for (let i = shoe.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shoe[i], shoe[j]] = [shoe[j], shoe[i]];
  }
  return shoe;
}

function cardValue(card) {
  if (!card) return 0;
  if (card.rank === 'A') return 11;
  if (['K', 'Q', 'J'].includes(card.rank)) return 10;
  return parseInt(card.rank, 10);
}

function handValue(cards) {
  let sum = 0;
  let aces = 0;
  for (const c of cards) {
    sum += cardValue(c);
    if (c.rank === 'A') aces++;
  }
  while (sum > 21 && aces > 0) {
    sum -= 10;
    aces--;
  }
  return sum;
}

function suitColor(s) {
  return s === '♥' || s === '♦' ? '#d64545' : '#1f2a44';
}

function renderSVG(card) {
  const s = suitColor(card.suit);
  const rank = card.rank;
  return `
  <svg class="svg" viewBox="0 0 250 350" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${rank} ${card.suit}">
    <defs>
      <filter id="innerShadow" x="-50%" y="-50%" width="200%" height="200%">
        <feOffset dx="0" dy="2" />
        <feGaussianBlur stdDeviation="2" result="offblur" />
        <feComposite in="SourceGraphic" in2="offblur" operator="arithmetic" k2="-1" k3="1" />
      </filter>
    </defs>
    <rect x="4" y="4" rx="22" ry="22" width="242" height="342" fill="#ffffff" filter="url(#innerShadow)" />
    <rect x="8" y="8" rx="18" ry="18" width="234" height="334" fill="#ffffff" />
    <g fill="${s}">
      <text x="22" y="40" font-size="44" font-family="ui-monospace, Menlo, Consolas, monospace">${rank}</text>
      <text x="22" y="76" font-size="44">${card.suit}</text>
      <text x="228" y="340" font-size="44" text-anchor="end" transform="rotate(180,228,340)">${rank}</text>
      <text x="228" y="304" font-size="44" text-anchor="end" transform="rotate(180,228,304)">${card.suit}</text>
      <text x="125" y="205" font-size="120" text-anchor="middle" dominant-baseline="middle" opacity=".9">${card.suit}</text>
    </g>
  </svg>`;
}

const dealerSpot = document.getElementById('dealerSpot');
const playerSpot = document.getElementById('playerSpot');
const dealerTotal = document.getElementById('dealerTotal');
const playerTotal = document.getElementById('playerTotal');
const statusEl = document.getElementById('status');
const btnDeal = document.getElementById('btnDeal');
const btnHit = document.getElementById('btnHit');
const btnStand = document.getElementById('btnStand');
const btnNew = document.getElementById('btnNew');
const bankDisplay = document.getElementById('bank');

const lobbyOverlay = document.getElementById('lobbyOverlay');
const singleplayerBtn = document.getElementById('singleplayerBtn');
const hostBtn = document.getElementById('hostBtn');
const joinToggle = document.getElementById('joinToggle');
const hostPanel = document.getElementById('hostPanel');
const hostCodeEl = document.getElementById('hostCode');
const joinForm = document.getElementById('joinForm');
const joinCodeInput = document.getElementById('joinCodeInput');
const joinSubmit = document.getElementById('joinSubmit');
const lobbyStatus = document.getElementById('lobbyStatus');

let shoe = buildShoe(6);
let player = [];
let dealer = [];
let bank = 1000;
let dealerHoleHidden = false;
let currentButtonState = 'deal';
let statusTimer = null;
let statusVisible = false;
let statusDuration = 1100;
let suppressSync = false;

let mode = 'lobby';
let isHost = false;
let gameCode = null;
let remoteGameRef = null;
let remoteMetaUnsub = null;
let remoteStateUnsub = null;
let hostDisconnect = null;
let joinDisconnect = null;

bankDisplay.textContent = bank;
setButtons('deal');
showOverlay('Pick a mode to get started.');

function setButtons(state) {
  currentButtonState = state;
  const toggle = (el, on) => el.classList.toggle('muted', !on);
  switch (state) {
    case 'deal':
      toggle(btnDeal, true);
      toggle(btnHit, false);
      toggle(btnStand, false);
      break;
    case 'player':
      toggle(btnDeal, false);
      toggle(btnHit, true);
      toggle(btnStand, true);
      break;
    case 'lock':
      toggle(btnDeal, false);
      toggle(btnHit, false);
      toggle(btnStand, false);
      break;
  }
}

function showStatus(msg, ms = 1100, broadcast = true) {
  clearTimeout(statusTimer);
  statusEl.textContent = msg;
  statusEl.classList.add('show');
  statusVisible = true;
  statusDuration = ms;
  statusTimer = setTimeout(() => {
    statusEl.classList.remove('show');
    statusVisible = false;
    if (broadcast) broadcastState();
  }, ms);
  if (broadcast) broadcastState();
}

function clearStatus() {
  clearTimeout(statusTimer);
  statusEl.textContent = '';
  statusEl.classList.remove('show');
  statusVisible = false;
}

function clearSpots() {
  dealerSpot.innerHTML = '';
  playerSpot.innerHTML = '';
  dealerTotal.textContent = '0';
  playerTotal.textContent = '0';
}

function renderHand(spot, cards, hideHole) {
  spot.innerHTML = '';
  cards.forEach((card, idx) => {
    const el = document.createElement('div');
    el.className = 'card';
    const x = 20 + idx * 28;
    const y = 6 + idx * 2;
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
    el.style.transform = `translate(0,0) rotate(${[-3, -1, 1, 3][idx % 4]}deg)`;
    if (hideHole && idx === 1) {
      el.innerHTML = '<div class="back"></div>';
    } else {
      el.innerHTML = renderSVG(card);
    }
    spot.appendChild(el);
  });
}

function updateTotals() {
  if (dealer.length === 0) {
    dealerTotal.textContent = '0';
  } else if (dealerHoleHidden) {
    const first = dealer[0];
    dealerTotal.textContent = first ? `${cardValue(first)} +` : '0';
  } else {
    dealerTotal.textContent = String(handValue(dealer));
  }
  playerTotal.textContent = player.length ? String(handValue(player)) : '0';
}

function drawCard(toHand, toSpot, faceDown = false) {
  const card = shoe.pop();
  toHand.push(card);
  const el = document.createElement('div');
  el.className = 'card';
  el.style.left = '50%';
  el.style.top = '45%';
  el.style.transform = 'translate(-50%,-50%) rotate(5deg)';
  if (faceDown) {
    el.innerHTML = '<div class="back"></div>';
  } else {
    el.innerHTML = renderSVG(card);
  }
  const idx = toSpot.children.length;
  const x = 20 + idx * 28;
  const y = 6 + idx * 2;
  toSpot.appendChild(el);
  requestAnimationFrame(() => {
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
    el.style.transform = `translate(0,0) rotate(${[-3, -1, 1, 3][idx % 4]}deg)`;
  });
  return card;
}

function flipDealerHole() {
  dealerHoleHidden = false;
  const cardEl = dealerSpot.children[1];
  if (cardEl) {
    cardEl.innerHTML = renderSVG(dealer[1]);
  }
}

function broadcastState() {
  if (!remoteGameRef || !isHost || suppressSync) return;
  const state = {
    player,
    dealer,
    bank,
    dealerHoleHidden,
    buttonState: currentButtonState,
    statusMessage: statusEl.textContent,
    statusVisible,
    statusDuration
  };
  update(remoteGameRef, {
    state,
    updatedAt: serverTimestamp()
  }).catch(() => {});
}

function applyRemoteState(state) {
  if (mode !== 'joiner' || !state) return;
  suppressSync = true;
  player = Array.isArray(state.player) ? state.player : [];
  dealer = Array.isArray(state.dealer) ? state.dealer : [];
  bank = typeof state.bank === 'number' ? state.bank : bank;
  dealerHoleHidden = !!state.dealerHoleHidden;
  currentButtonState = state.buttonState || 'deal';
  statusDuration = state.statusDuration || 1100;

  bankDisplay.textContent = bank;
  renderHand(dealerSpot, dealer, dealerHoleHidden);
  renderHand(playerSpot, player, false);
  updateTotals();
  setButtons(currentButtonState);

  if (state.statusVisible && state.statusMessage) {
    showStatus(state.statusMessage, statusDuration, false);
  } else {
    clearStatus();
  }

  suppressSync = false;
}

function resetLocalGame() {
  shoe = buildShoe(6);
  player = [];
  dealer = [];
  bank = 1000;
  dealerHoleHidden = false;
  bankDisplay.textContent = bank;
  clearSpots();
  clearStatus();
  setButtons('deal');
}

function setLobbyStatus(message) {
  lobbyStatus.textContent = message || '';
}

function showOverlay(message) {
  if (message) setLobbyStatus(message);
  lobbyOverlay.classList.remove('is-hidden');
  lobbyOverlay.setAttribute('aria-hidden', 'false');
}

function hideOverlay() {
  lobbyOverlay.classList.add('is-hidden');
  lobbyOverlay.setAttribute('aria-hidden', 'true');
  setLobbyStatus('');
}

function resetLobbyPanels() {
  hostPanel.classList.add('hidden');
  joinForm.classList.add('hidden');
  joinToggle.setAttribute('aria-expanded', 'false');
  hostBtn.disabled = false;
  hostBtn.textContent = 'Host';
  joinToggle.disabled = false;
  joinSubmit.disabled = false;
  joinCodeInput.value = '';
}

function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 5; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

function cleanupListeners() {
  if (remoteStateUnsub) {
    remoteStateUnsub();
    remoteStateUnsub = null;
  }
  if (remoteMetaUnsub) {
    remoteMetaUnsub();
    remoteMetaUnsub = null;
  }
}

async function cleanupRemote(removeHostedGame = isHost) {
  const refToClean = remoteGameRef;
  cleanupListeners();
  if (hostDisconnect) {
    try { await hostDisconnect.cancel(); } catch (err) {}
    hostDisconnect = null;
  }
  if (joinDisconnect) {
    try { await joinDisconnect.cancel(); } catch (err) {}
    joinDisconnect = null;
  }
  remoteGameRef = null;
  gameCode = null;
  if (refToClean) {
    try {
      if (removeHostedGame) {
        await remove(refToClean);
      } else {
        await update(refToClean, { joinConnected: false });
      }
    } catch (err) {}
  }
}

function scheduleCleanup(removeHostedGame) {
  cleanupRemote(removeHostedGame).catch(() => {});
}

function deal() {
  clearSpots();
  if (shoe.length < 40) {
    shoe = buildShoe(6);
    showStatus('Shuffling…', 800);
  }
  player = [];
  dealer = [];
  drawCard(dealer, dealerSpot, false);
  dealerHoleHidden = true;
  drawCard(dealer, dealerSpot, true);
  drawCard(player, playerSpot, false);
  drawCard(player, playerSpot, false);
  updateTotals();
  setButtons('player');
  broadcastState();

  if (handValue(player) === 21) {
    setButtons('lock');
    setTimeout(() => {
      flipDealerHole();
      updateTotals();
      const dv = handValue(dealer);
      if (dv === 21) {
        showStatus('Push — both Blackjack');
      } else {
        bank += 150;
        bankDisplay.textContent = bank;
        showStatus('Blackjack! +150');
      }
      setButtons('deal');
      broadcastState();
    }, 550);
  }
}

function playerHit() {
  drawCard(player, playerSpot, false);
  updateTotals();
  broadcastState();
  const pv = handValue(player);
  if (pv > 21) {
    setButtons('lock');
    setTimeout(() => {
      flipDealerHole();
      updateTotals();
      bank -= 100;
      bankDisplay.textContent = bank;
      showStatus('Bust!');
      setButtons('deal');
      broadcastState();
    }, 450);
  }
}

function playerStand() {
  setButtons('lock');
  flipDealerHole();
  updateTotals();
  broadcastState();

  const drawDealer = () => {
    const dv = handValue(dealer);
    const soft17 = dv === 17 && dealer.some(c => c.rank === 'A') && handValue(dealer) === 17;
    if (dv < 17 || soft17) {
      setTimeout(() => {
        drawCard(dealer, dealerSpot, false);
        updateTotals();
        broadcastState();
        drawDealer();
      }, 420);
    } else {
      resolve();
    }
  };
  drawDealer();
}

function resolve() {
  const pv = handValue(player);
  const dv = handValue(dealer);
  let msg = '';
  if (dv > 21) {
    bank += 100;
    msg = 'Dealer busts — You win +100';
  } else if (pv > dv) {
    bank += 100;
    msg = 'You win +100';
  } else if (pv < dv) {
    bank -= 100;
    msg = 'You lose -100';
  } else {
    msg = 'Push';
  }
  bankDisplay.textContent = bank;
  showStatus(msg);
  setButtons('deal');
  broadcastState();
}

singleplayerBtn.addEventListener('click', async () => {
  const wasHost = isHost;
  await cleanupRemote(wasHost);
  isHost = false;
  mode = 'singleplayer';
  resetLobbyPanels();
  hideOverlay();
  resetLocalGame();
});

joinToggle.addEventListener('click', () => {
  const showing = !joinForm.classList.contains('hidden');
  if (showing) {
    joinForm.classList.add('hidden');
    joinToggle.setAttribute('aria-expanded', 'false');
  } else {
    joinForm.classList.remove('hidden');
    joinToggle.setAttribute('aria-expanded', 'true');
    hostPanel.classList.add('hidden');
    joinCodeInput.focus();
  }
});

async function startHosting() {
  hostBtn.disabled = true;
  hostBtn.textContent = 'Hosting…';
  joinToggle.disabled = true;
  joinSubmit.disabled = true;
  joinForm.classList.add('hidden');
  joinToggle.setAttribute('aria-expanded', 'false');
  setLobbyStatus('Creating lobby…');

  const wasHost = isHost;
  await cleanupRemote(wasHost);
  isHost = true;
  mode = 'host';

  gameCode = generateCode();
  hostCodeEl.textContent = gameCode;
  hostPanel.classList.remove('hidden');
  resetLocalGame();

  remoteGameRef = ref(db, `blackjack/${gameCode}`);
  try {
    await set(remoteGameRef, {
      createdAt: serverTimestamp(),
      hostConnected: true,
      joinConnected: false,
      state: null
    });
    hostDisconnect = onDisconnect(remoteGameRef);
    await hostDisconnect.remove();
    setLobbyStatus('Share this code with a friend to start playing.');
    joinToggle.disabled = false;
    joinSubmit.disabled = false;

    cleanupListeners();
    remoteMetaUnsub = onValue(remoteGameRef, snapshot => {
      const data = snapshot.val();
      if (!data) {
        return;
      }
      if (data.joinConnected) {
        if (!lobbyOverlay.classList.contains('is-hidden')) {
          resetLocalGame();
          hideOverlay();
          broadcastState();
        }
      } else {
        if (lobbyOverlay.classList.contains('is-hidden')) {
          showOverlay('Friend disconnected. Waiting for another player.');
          hostPanel.classList.remove('hidden');
          hostCodeEl.textContent = gameCode;
          resetLocalGame();
          broadcastState();
        } else {
          setLobbyStatus('Share this code with a friend to start playing.');
        }
      }
    });
  } catch (err) {
    console.error(err);
    setLobbyStatus('Unable to create lobby. Please try again.');
    hostPanel.classList.add('hidden');
    await cleanupRemote(true);
    isHost = false;
    mode = 'lobby';
  } finally {
    hostBtn.disabled = false;
    hostBtn.textContent = 'Host';
    joinToggle.disabled = false;
    joinSubmit.disabled = false;
  }
}

hostBtn.addEventListener('click', () => {
  startHosting();
});

joinForm.addEventListener('submit', event => {
  event.preventDefault();
  joinGame(joinCodeInput.value);
});

joinCodeInput.addEventListener('input', event => {
  event.target.value = event.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});

async function joinGame(code) {
  const trimmed = (code || '').trim().toUpperCase();
  if (trimmed.length < 4) {
    setLobbyStatus('Enter a valid 4–6 character code.');
    return;
  }

  joinSubmit.disabled = true;
  joinToggle.disabled = true;
  hostBtn.disabled = true;
  setLobbyStatus('Searching for lobby…');

  const wasHost = isHost;
  await cleanupRemote(wasHost);
  isHost = false;

  const pathRef = ref(db, `blackjack/${trimmed}`);
  try {
    const snapshot = await get(pathRef);
    if (!snapshot.exists()) {
      setLobbyStatus('No lobby found with that code.');
      return;
    }
    const data = snapshot.val();
    if (!data.hostConnected) {
      setLobbyStatus("That lobby isn't ready yet.");
      return;
    }

    gameCode = trimmed;
    remoteGameRef = pathRef;
    mode = 'joiner';

    const joinStatusRef = ref(db, `blackjack/${trimmed}/joinConnected`);
    joinDisconnect = onDisconnect(joinStatusRef);
    await joinDisconnect.set(false);
    await update(pathRef, { joinConnected: true });

    setLobbyStatus('Connected! Waiting for the host…');
    resetLobbyPanels();
    hideOverlay();
    clearSpots();
    clearStatus();
    setButtons('deal');

    cleanupListeners();
    remoteStateUnsub = onValue(ref(db, `blackjack/${trimmed}/state`), snap => {
      const state = snap.val();
      if (state) {
        applyRemoteState(state);
      }
    });
    remoteMetaUnsub = onValue(pathRef, snap => {
      const meta = snap.val();
      if (!meta) {
        cleanupRemote(false).then(() => {
          resetLobbyPanels();
          showOverlay('The host closed the lobby.');
          mode = 'lobby';
        });
        return;
      }
      if (!meta.hostConnected && mode === 'joiner') {
        cleanupRemote(false).then(() => {
          resetLobbyPanels();
          showOverlay('The host left the lobby.');
          mode = 'lobby';
        });
      }
    });
  } catch (err) {
    console.error(err);
    setLobbyStatus('Could not join the lobby. Try again.');
    await cleanupRemote(false);
    mode = 'lobby';
    showOverlay();
  } finally {
    joinSubmit.disabled = false;
    joinToggle.disabled = false;
    hostBtn.disabled = false;
  }
}

btnDeal.addEventListener('click', () => {
  if (mode === 'joiner' || btnDeal.classList.contains('muted')) return;
  deal();
});

btnHit.addEventListener('click', () => {
  if (mode === 'joiner' || btnHit.classList.contains('muted')) return;
  playerHit();
});

btnStand.addEventListener('click', () => {
  if (mode === 'joiner' || btnStand.classList.contains('muted')) return;
  playerStand();
});

btnNew.addEventListener('click', () => {
  if (mode === 'joiner') return;
  shoe = buildShoe(6);
  showStatus('New shoe ready', 700);
  if (isHost) broadcastState();
});

window.addEventListener('beforeunload', () => scheduleCleanup(isHost));
window.addEventListener('pagehide', () => scheduleCleanup(isHost));
</script>
</body>
</html>
