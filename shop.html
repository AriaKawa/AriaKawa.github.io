<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailor's Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #050311;
            --bg-alt: #120a2d;
            --text-primary: #f5f3ff;
            --text-muted: #bcb4da;
            --accent-pink: #f7a7da;
            --accent-blue: #93c6ff;
            --accent-lavender: #c2b7ff;
            --card-gradient: linear-gradient(155deg, rgba(23, 16, 52, 0.92), rgba(10, 6, 27, 0.88));
            --border-gradient: linear-gradient(140deg, rgba(244, 170, 219, 0.8), rgba(147, 198, 255, 0.8));
            --radius-lg: 28px;
            --radius-sm: 14px;
            --shadow-strong: 0 35px 65px rgba(8, 4, 22, 0.7);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            font-family: "Plus Jakarta Sans", "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            background:
                radial-gradient(circle at top left, rgba(147, 198, 255, 0.28), transparent 55%),
                radial-gradient(circle at bottom right, rgba(247, 167, 218, 0.32), transparent 60%),
                var(--bg-base);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            padding: clamp(1.6rem, 4vw, 3.5rem);
        }

        .top-actions {
            position: fixed;
            top: clamp(0.9rem, 2vw, 1.6rem);
            left: clamp(0.9rem, 2vw, 1.6rem);
            right: clamp(0.9rem, 2vw, 1.6rem);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
            gap: clamp(0.8rem, 2vw, 1.4rem);
            z-index: 60;
        }

        .back-nav {
            position: static;
            margin-right: auto;
        }

        .back-nav__button {
            appearance: none;
            border: 1px solid rgba(147, 198, 255, 0.35);
            background: linear-gradient(135deg, rgba(31, 21, 58, 0.82), rgba(11, 7, 27, 0.88));
            color: var(--text-primary);
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.55rem 1.2rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            box-shadow: 0 18px 35px rgba(5, 3, 17, 0.35);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .back-nav__button:hover,
        .back-nav__button:focus-visible {
            transform: translateY(-1px);
            border-color: rgba(247, 167, 218, 0.65);
            box-shadow: 0 25px 45px rgba(5, 3, 17, 0.45);
            outline: none;
        }

        .back-nav__icon {
            font-size: 1.1rem;
            line-height: 1;
        }

        .currency-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.45rem 1rem;
            border-radius: 999px;
            border: 1px solid rgba(147, 198, 255, 0.35);
            background: linear-gradient(135deg, rgba(31, 21, 58, 0.82), rgba(11, 7, 27, 0.88));
            box-shadow: 0 20px 35px rgba(5, 3, 17, 0.45);
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .currency-display__icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 243, 184, 0.95), rgba(244, 203, 78, 0.85));
            color: #2a1647;
            font-size: 0.95rem;
            box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.55);
        }

        .currency-display__amount {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .account-menu {
            position: relative;
            display: flex;
            align-items: center;
        }

        .account-menu__trigger {
            appearance: none;
            border: none;
            background: transparent;
            padding: 0;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 20px 35px rgba(5, 3, 17, 0.45);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .account-menu__trigger:hover,
        .account-menu__trigger:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 28px 45px rgba(5, 3, 17, 0.55);
            outline: none;
        }

        .account-menu__avatar {
            width: clamp(38px, 4vw, 44px);
            height: clamp(38px, 4vw, 44px);
            border-radius: 50%;
            border: 1px solid rgba(147, 198, 255, 0.35);
            background: linear-gradient(135deg, rgba(147, 198, 255, 0.35), rgba(247, 167, 218, 0.35));
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.04em;
        }

        .account-menu[data-state="signed-in"] .account-menu__avatar {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-pink));
            border-color: rgba(255, 255, 255, 0.45);
            color: #140827;
        }

        .account-menu__dropdown {
            position: absolute;
            top: calc(100% + 0.8rem);
            right: 0;
            min-width: clamp(220px, 30vw, 260px);
            padding: 1rem;
            border-radius: var(--radius-lg);
            background: linear-gradient(150deg, rgba(19, 12, 38, 0.95), rgba(8, 5, 20, 0.98));
            border: 1px solid rgba(147, 198, 255, 0.22);
            box-shadow: var(--shadow-strong);
            opacity: 0;
            transform: translateY(-6px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .account-menu.is-open .account-menu__dropdown {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .account-menu__dropdown[hidden] {
            display: none;
        }

        .account-menu__details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .account-menu__name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .account-menu__status {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .account-menu__actions {
            display: grid;
            gap: 0.5rem;
        }

        .account-menu__action {
            appearance: none;
            border: 1px solid rgba(147, 198, 255, 0.28);
            background: rgba(147, 198, 255, 0.12);
            color: var(--text-primary);
            border-radius: calc(var(--radius-sm) - 4px);
            padding: 0.55rem 0.9rem;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
        }

        .account-menu__action:hover,
        .account-menu__action:focus-visible {
            border-color: rgba(247, 167, 218, 0.6);
            background: rgba(147, 198, 255, 0.22);
            transform: translateY(-1px);
            outline: none;
        }

        .account-menu__action[data-account-action="signin"] {
            background: linear-gradient(135deg, rgba(147, 198, 255, 0.28), rgba(247, 167, 218, 0.28));
            border-color: rgba(147, 198, 255, 0.42);
        }

        .account-menu__action[data-account-action="signin"]:hover,
        .account-menu__action[data-account-action="signin"]:focus-visible {
            background: linear-gradient(135deg, rgba(147, 198, 255, 0.45), rgba(247, 167, 218, 0.45));
            border-color: rgba(247, 167, 218, 0.7);
        }

        .account-menu__action[data-account-action="signout"] {
            background: rgba(241, 118, 159, 0.12);
            border-color: rgba(241, 118, 159, 0.35);
        }

        .account-menu__action[data-account-action="signout"]:hover,
        .account-menu__action[data-account-action="signout"]:focus-visible {
            background: rgba(241, 118, 159, 0.22);
            border-color: rgba(241, 118, 159, 0.55);
        }

        .shop-page {
            width: min(1100px, 100%);
            display: grid;
            gap: clamp(2rem, 5vw, 3.2rem);
        }

        .shop-header {
            display: grid;
            gap: 0.6rem;
        }

        .shop-content {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
            gap: clamp(1.8rem, 4vw, 2.8rem);
            align-items: start;
        }

        .avatar-card {
            display: grid;
            gap: 1.4rem;
            padding: clamp(1.8rem, 3.6vw, 2.6rem);
            border-radius: var(--radius-lg);
            background: linear-gradient(150deg, rgba(21, 13, 40, 0.88), rgba(7, 5, 20, 0.94));
            border: 1px solid rgba(147, 198, 255, 0.18);
            box-shadow: var(--shadow-strong);
            width: 100%;
        }

        .avatar-card h2 {
            margin: 0;
            font-size: clamp(1.6rem, 3.6vw, 2.2rem);
        }

        .panel-title {
            margin: 0;
            font-size: clamp(2rem, 5vw, 3rem);
        }

        .panel-description {
            margin: 0;
            max-width: 52ch;
            color: var(--text-muted);
        }

        .avatar-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, rgba(147, 198, 255, 0.25), transparent 65%);
            border-radius: var(--radius-lg);
            padding: clamp(1.2rem, 3vw, 1.8rem);
            border: 1px solid rgba(147, 198, 255, 0.2);
        }

        .rat-avatar {
            width: clamp(180px, 28vw, 240px);
            height: clamp(180px, 28vw, 240px);
        }

        .rat-avatar svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .rat-avatar [data-layer="outfit"] {
            display: none;
        }

        .rat-avatar[data-outfit="classic"] .outfit-classic,
        .rat-avatar[data-outfit="hoodie"] .outfit-hoodie,
        .rat-avatar[data-outfit="adventurer"] .outfit-adventurer {
            display: inline;
        }

        .shop-catalog {
            padding: clamp(1.8rem, 3vw, 2.4rem);
            border-radius: var(--radius-lg);
            background: linear-gradient(150deg, rgba(21, 13, 40, 0.88), rgba(7, 5, 20, 0.94));
            border: 1px solid rgba(147, 198, 255, 0.18);
            box-shadow: var(--shadow-strong);
            display: grid;
            gap: 1.4rem;
        }

        .shop-catalog__header {
            display: grid;
            gap: 0.35rem;
        }

        .shop-catalog__header h2 {
            margin: 0;
            font-size: clamp(1.4rem, 3vw, 1.9rem);
        }

        .shop-catalog__hint {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .shop-grid {
            display: grid;
            gap: 1rem;
        }

        .shop-item {
            border-radius: var(--radius-sm);
            padding: 1rem 1.1rem;
            background: rgba(18, 10, 45, 0.65);
            border: 1px solid rgba(147, 198, 255, 0.18);
            display: grid;
            gap: 0.75rem;
            transition: border-color 0.25s ease, transform 0.25s ease;
        }

        .shop-item.is-owned {
            border-color: rgba(247, 167, 218, 0.35);
        }

        .shop-item.is-selected {
            box-shadow: 0 16px 28px rgba(247, 167, 218, 0.22);
            transform: translateY(-3px);
        }

        .shop-item__header {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .shop-item__header h3 {
            margin: 0;
            font-size: 1.05rem;
        }

        .shop-item__header span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .shop-item__status {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .shop-item__action {
            appearance: none;
            border: none;
            border-radius: 999px;
            padding: 0.55rem 1.2rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            color: var(--text-primary);
            background: linear-gradient(135deg, rgba(147, 198, 255, 0.22), rgba(247, 167, 218, 0.28));
            box-shadow: 0 18px 32px rgba(147, 198, 255, 0.18);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .shop-item__action:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }

        .shop-item__action:not(:disabled):hover,
        .shop-item__action:not(:disabled):focus-visible {
            transform: translateY(-2px);
            box-shadow: 0 24px 40px rgba(247, 167, 218, 0.28);
            outline: none;
        }

        footer {
            text-align: center;
            color: rgba(188, 180, 218, 0.72);
            font-size: 0.85rem;
            padding-bottom: 0.5rem;
        }

        @media (max-width: 960px) {
            .shop-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 720px) {
            body {
                padding: clamp(1.2rem, 6vw, 2rem);
            }

            .top-actions {
                top: clamp(0.7rem, 5vw, 1.2rem);
                left: clamp(0.7rem, 5vw, 1.2rem);
                right: clamp(0.7rem, 5vw, 1.2rem);
                gap: 0.75rem;
            }

            .account-menu__dropdown {
                min-width: min(260px, 82vw);
            }
        }
    </style>
</head>
<body>
    <div class="top-actions">
        <div class="back-nav" role="navigation" aria-label="Return to vault">
            <button type="button" class="back-nav__button" data-home="index.html" onclick="handleBack(event)">
                <span class="back-nav__icon" aria-hidden="true">&#8962;</span>
                <span class="back-nav__text">Back to vault</span>
            </button>
        </div>
        <div
            class="currency-display"
            data-currency-balance
            aria-label="Vault coins"
            role="status"
            aria-live="polite"
        >
            <span class="currency-display__icon" aria-hidden="true">◎</span>
            <span class="currency-display__amount" data-currency-amount>1 coin</span>
        </div>
        <div class="account-menu" data-account-menu data-state="signed-out">
            <button
                type="button"
                class="account-menu__trigger"
                data-account-trigger
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="account-menu-dropdown"
            >
                <span class="account-menu__avatar" data-account-avatar>G</span>
                <span class="sr-only">Open account menu</span>
            </button>
            <div
                class="account-menu__dropdown"
                data-account-dropdown
                id="account-menu-dropdown"
                role="menu"
                aria-label="Account options"
                hidden
            >
                <div class="account-menu__details">
                    <span class="account-menu__name" data-account-name>Guest</span>
                    <span class="account-menu__status" data-account-status>Signed out</span>
                </div>
                <div class="account-menu__actions">
                    <button type="button" class="account-menu__action" data-account-action="signin" role="menuitem">
                        Sign in
                    </button>
                    <button
                        type="button"
                        class="account-menu__action"
                        data-account-action="signout"
                        role="menuitem"
                        hidden
                    >
                        Sign out
                    </button>
                </div>
            </div>
        </div>
    </div>
    <main class="shop-page">
        <header class="shop-header">
            <h1 class="panel-title">Tailor's shop</h1>
            <p class="panel-description">Pick out new looks and unlock them with your vault coins.</p>
        </header>
        <div class="shop-content">
            <div class="avatar-card" data-avatar-card>
                <h2>Preview</h2>
                <p class="panel-description" data-shop-summary>Currently wearing: Cozy Classic</p>
                <div class="avatar-preview" aria-live="polite">
                    <div class="rat-avatar" data-outfit="classic">
                        <svg viewBox="0 0 220 280" role="img" aria-label="Armored standing rat avatar illustration">
                            <defs>
                                <linearGradient id="rat-fur" x1="15%" y1="5%" x2="85%" y2="95%">
                                    <stop offset="0%" stop-color="#d0cde6"></stop>
                                    <stop offset="45%" stop-color="#b4afd4"></stop>
                                    <stop offset="100%" stop-color="#8d86b2"></stop>
                                </linearGradient>
                                <linearGradient id="rat-fur-shade" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#f0edf9" stop-opacity="0.8"></stop>
                                    <stop offset="100%" stop-color="#726c9b" stop-opacity="0.8"></stop>
                                </linearGradient>
                                <linearGradient id="rat-ear" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#f9c2dc"></stop>
                                    <stop offset="100%" stop-color="#f180ba"></stop>
                                </linearGradient>
                                <linearGradient id="rat-tail" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#f5aecf"></stop>
                                    <stop offset="100%" stop-color="#e075a7"></stop>
                                </linearGradient>
                                <linearGradient id="classic-coat" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#99b6ff"></stop>
                                    <stop offset="100%" stop-color="#6d7dff"></stop>
                                </linearGradient>
                                <linearGradient id="hoodie-body" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#7f63ff"></stop>
                                    <stop offset="100%" stop-color="#5433e7"></stop>
                                </linearGradient>
                                <linearGradient id="adventurer-cloak" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#f9bb6f"></stop>
                                    <stop offset="100%" stop-color="#cc6f29"></stop>
                                </linearGradient>
                            </defs>
                            <g fill="none" fill-rule="evenodd">
                                <ellipse cx="110" cy="248" rx="70" ry="16" fill="rgba(19, 10, 37, 0.45)"></ellipse>
                                <path d="M166 160c32 32 30 58 10 70-20 12-46-0-58-12" stroke="url(#rat-tail)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
                                <g transform="translate(36 24)">
                                    <g>
                                        <path d="M83 66c-28-4-50 16-54 52-4 40 6 88 48 96 36 6 62-18 68-58 6-40-10-80-34-88-14-5-20 0-28-2z" fill="url(#rat-fur)"></path>
                                        <path d="M78 68c-16 4-30 16-34 34-10 38 12 86 54 96" fill="url(#rat-fur-shade)" opacity="0.35"></path>
                                    </g>
                                    <g>
                                        <ellipse cx="56" cy="36" rx="22" ry="30" fill="url(#rat-ear)" transform="rotate(-12 56 36)"></ellipse>
                                        <ellipse cx="150" cy="34" rx="22" ry="30" fill="url(#rat-ear)" transform="rotate(12 150 34)"></ellipse>
                                        <circle cx="104" cy="62" r="46" fill="url(#rat-fur)"></circle>
                                        <ellipse cx="104" cy="94" rx="24" ry="18" fill="#f5d9e7"></ellipse>
                                        <circle cx="90" cy="60" r="6" fill="#23152f"></circle>
                                        <circle cx="122" cy="60" r="6" fill="#23152f"></circle>
                                        <path d="M102 90c4 2 10 2 14 0" stroke="#38234d" stroke-width="4" stroke-linecap="round"></path>
                                        <path d="M120 98c-6 4-14 4-20 0" fill="#f8b7ce"></path>
                                        <circle cx="130" cy="92" r="4" fill="#ef769f"></circle>
                                        <path d="M70 90c-16-4-24-10-26-14" stroke="#cf90b5" stroke-linecap="round" stroke-width="4"></path>
                                        <path d="M138 90c16-4 24-10 26-14" stroke="#cf90b5" stroke-linecap="round" stroke-width="4"></path>
                                    </g>
                                    <g>
                                        <path d="M70 140c-10-10-26-18-40-16" stroke="url(#rat-fur)" stroke-width="18" stroke-linecap="round"></path>
                                        <path d="M140 140c10-10 26-18 40-16" stroke="url(#rat-fur)" stroke-width="18" stroke-linecap="round"></path>
                                        <path d="M80 220c-2 14-12 22-24 24-8 2-12-6-10-12 6-18 20-34 32-40" fill="url(#rat-fur)" stroke="#786f9b" stroke-width="3" stroke-linecap="round"></path>
                                        <path d="M132 220c2 14 12 22 24 24 8 2 12-6 10-12-6-18-20-34-32-40" fill="url(#rat-fur)" stroke="#786f9b" stroke-width="3" stroke-linecap="round"></path>
                                    </g>
                                </g>
                                <g data-layer="outfit" class="outfit-classic">
                                    <path d="M72 158c-12 36-10 74 6 94 20 24 54 24 74 0 16-20 18-58 6-94-6-18-22-32-44-34s-38 12-42 34z" fill="url(#classic-coat)" stroke="#d8e3ff" stroke-width="4" stroke-linejoin="round"></path>
                                    <path d="M112 150l-10 32 20 12 20-12-10-32z" fill="#f5f7ff" opacity="0.65"></path>
                                    <circle cx="110" cy="204" r="5" fill="#f9fcff"></circle>
                                </g>
                                <g data-layer="outfit" class="outfit-hoodie">
                                    <path d="M68 164c-8 40-4 86 18 106 18 14 48 14 66 0 22-20 26-66 18-106-4-20-22-38-50-38s-46 18-52 38z" fill="url(#hoodie-body)" stroke="#a99bff" stroke-width="4" stroke-linejoin="round"></path>
                                    <path d="M82 150c12-16 26-22 46-22s34 6 46 22c6 8 10 22 6 32-4 8-22 18-52 18s-48-10-52-18c-4-10 0-24 6-32z" fill="#2f216a" opacity="0.35"></path>
                                    <path d="M90 182c10 10 20 14 20 34" stroke="#d9d3ff" stroke-width="4" stroke-linecap="round"></path>
                                </g>
                                <g data-layer="outfit" class="outfit-adventurer">
                                    <path d="M74 156c-8 16-12 52-6 86 2 12 10 24 20 32 24 18 64 8 78-24 16-38 12-82-2-110-10-20-26-26-44-26-22 0-38 12-46 42z" fill="url(#adventurer-cloak)" stroke="#ffe1b2" stroke-width="4" stroke-linejoin="round"></path>
                                    <path d="M82 190h72l-10 26H92z" fill="#9b4a18" opacity="0.6"></path>
                                    <path d="M104 164l10-20h28l10 20z" fill="#5f2d10" opacity="0.6"></path>
                                </g>
                            </g>
                        </svg>
                    </div>
                </div>
                <p class="panel-description">Owned outfits stay synced across every page.</p>
            </div>
            <section class="shop-catalog" aria-labelledby="shop-title">
                <div class="shop-catalog__header">
                    <h2 id="shop-title">Available outfits</h2>
                    <p class="shop-catalog__hint">Unlock a new look and equip it instantly.</p>
                </div>
                <div class="shop-grid" data-shop-grid></div>
            </section>
        </div>
    </main>

    <script>
        function handleBack(event) {
            if (event) {
                event.preventDefault();
            }

            const home = event?.currentTarget?.dataset?.home || "index.html";

            const normalizePath = (value) => {
                const url = new URL(value, window.location.origin);
                let path = url.pathname;

                if (path.endsWith("/index.html")) {
                    path = path.slice(0, -"/index.html".length) || "/";
                }

                if (path.endsWith("/")) {
                    path = path.slice(0, -1) || "/";
                }

                return path || "/";
            };

            const currentPath = normalizePath(window.location.pathname || window.location.href);
            const homePath = normalizePath(home);

            if (currentPath === homePath) {
                return;
            }

            window.location.href = home;
        }

        (function setupAccountMenu() {
            const menu = document.querySelector('[data-account-menu]');
            if (!menu) {
                return;
            }

            const trigger = menu.querySelector('[data-account-trigger]');
            const dropdown = menu.querySelector('[data-account-dropdown]');
            const signInButton = menu.querySelector('[data-account-action="signin"]');
            const signOutButton = menu.querySelector('[data-account-action="signout"]');

            if (!trigger || !dropdown || !signInButton || !signOutButton) {
                return;
            }

            let isOpen = false;

            function closeMenu(options = {}) {
                const { focusTrigger = false } = options;

                if (!isOpen) {
                    if (focusTrigger) {
                        trigger.focus();
                    }
                    return;
                }

                isOpen = false;
                menu.classList.remove('is-open');
                dropdown.hidden = true;
                trigger.setAttribute('aria-expanded', 'false');
                document.removeEventListener('pointerdown', handlePointerDown, true);
                document.removeEventListener('keydown', handleKeydown, true);

                if (focusTrigger) {
                    trigger.focus();
                }
            }

            function openMenu() {
                if (isOpen) {
                    return;
                }

                isOpen = true;
                dropdown.hidden = false;
                menu.classList.add('is-open');
                trigger.setAttribute('aria-expanded', 'true');

                document.addEventListener('pointerdown', handlePointerDown, true);
                document.addEventListener('keydown', handleKeydown, true);

                const firstAction = dropdown.querySelector('[data-account-action]:not([hidden])');
                if (firstAction instanceof HTMLElement) {
                    window.requestAnimationFrame(() => {
                        firstAction.focus();
                    });
                }
            }

            function handleKeydown(event) {
                if (!isOpen) {
                    return;
                }

                if (event.key === 'Escape') {
                    event.preventDefault();
                    closeMenu({ focusTrigger: true });
                    return;
                }

                if (event.key === 'Tab') {
                    const focusable = Array.from(
                        dropdown.querySelectorAll('[data-account-action]:not([hidden])')
                    );

                    if (focusable.length === 0) {
                        return;
                    }

                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];

                    if (!event.shiftKey && document.activeElement === last) {
                        event.preventDefault();
                        first.focus();
                    } else if (event.shiftKey && document.activeElement === first) {
                        event.preventDefault();
                        last.focus();
                    }
                }
            }

            function handlePointerDown(event) {
                if (!menu.contains(event.target)) {
                    closeMenu();
                }
            }

            menu.__closeAccountMenu = closeMenu;
            menu.__openAccountMenu = openMenu;

            trigger.addEventListener('click', () => {
                if (isOpen) {
                    closeMenu();
                } else {
                    openMenu();
                }
            });

            trigger.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    openMenu();
                }
            });
        })();
    </script>

    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import {
            getAuth,
            GoogleAuthProvider,
            onAuthStateChanged,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRniZatGeylxphjHQadYjucOcirNBRIdk",
            authDomain: "multiplayer-640ec.firebaseapp.com",
            databaseURL: "https://multiplayer-640ec-default-rtdb.firebaseio.com",
            projectId: "multiplayer-640ec",
            storageBucket: "multiplayer-640ec.firebasestorage.app",
            messagingSenderId: "94914236381",
            appId: "1:94914236381:web:55ab00cc690140180cf034",
            measurementId: "G-V43J1S8RGF"
        };

        const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
        isSupported()
            .then((supported) => {
                if (supported) {
                    getAnalytics(app);
                }
            })
            .catch((err) => console.warn("Firebase analytics not supported", err));

        const database = getDatabase(app);
        const auth = getAuth(app);
        auth.useDeviceLanguage();
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        const outfits = [
            { id: 'classic', name: 'Cozy Classic', description: 'The baseline guild tunic.', price: 0 },
            { id: 'hoodie', name: 'Midnight Hoodie', description: 'Urban stealth with neon trim.', price: 1 },
            { id: 'adventurer', name: 'Adventurer Cape', description: 'Ready for future expeditions.', price: 2 }
        ];

        const avatarCard = document.querySelector('[data-avatar-card]');
        const avatarPreview = avatarCard?.querySelector('.rat-avatar') ?? null;
        const shopSummary = avatarCard?.querySelector('[data-shop-summary]') ?? null;
        const shopGrid = document.querySelector('[data-shop-grid]');
        const currencyDisplay = document.querySelector('[data-currency-balance]');
        const currencyAmount = currencyDisplay?.querySelector('[data-currency-amount]') ?? null;

        if (!avatarCard || !avatarPreview || !shopGrid || !shopSummary) {
            if (currencyAmount) {
                currencyAmount.textContent = '—';
            }
            setupAccountMenu();
            return;
        }

        const defaultOutfit = 'classic';
        const defaultCoins = 1;
        const defaultOwnedOutfits = new Set([defaultOutfit]);

        let coins = defaultCoins;
        let ownedOutfits = new Set(defaultOwnedOutfits);
        let currentOutfit = defaultOutfit;
        let currentUser = null;
        let applyingRemoteState = false;
        let stopUserListener = null;

        const accountMenu = setupAccountMenu();

        function setupAccountMenu() {
            const menu = document.querySelector('[data-account-menu]');
            const trigger = menu?.querySelector('[data-account-trigger]') ?? null;
            const dropdown = menu?.querySelector('[data-account-dropdown]') ?? null;
            const avatar = menu?.querySelector('[data-account-avatar]') ?? null;
            const nameEl = menu?.querySelector('[data-account-name]') ?? null;
            const statusEl = menu?.querySelector('[data-account-status]') ?? null;
            const signInButton = menu?.querySelector('[data-account-action="signin"]') ?? null;
            const signOutButton = menu?.querySelector('[data-account-action="signout"]') ?? null;

            if (!menu || !trigger || !dropdown || !avatar || !nameEl || !statusEl || !signInButton || !signOutButton) {
                return {
                    onUserChange() {
                        return () => {};
                    },
                    reportSyncStatus() {}
                };
            }

            const listeners = new Set();
            let syncHealthy = true;
            let currentAccount = null;

            function normalizeName(value) {
                if (typeof value !== 'string') {
                    return '';
                }

                return value.replace(/\s+/g, ' ').trim();
            }

            function resolveDisplayName(user) {
                if (!user) {
                    return 'Guest';
                }

                const fromDisplayName = normalizeName(user.displayName ?? '');
                if (fromDisplayName) {
                    return fromDisplayName;
                }

                const fromEmail = normalizeName(user.email ?? '');
                if (fromEmail) {
                    const [first] = fromEmail.split('@');
                    return first ? normalizeName(first) || 'Traveler' : 'Traveler';
                }

                return 'Traveler';
            }

            function getInitial(name) {
                const normalized = normalizeName(name);
                if (!normalized) {
                    return 'G';
                }

                return normalized.charAt(0).toUpperCase();
            }

            function updateUI(user) {
                const displayName = resolveDisplayName(user);
                const isSignedIn = Boolean(user);
                menu.dataset.state = isSignedIn ? 'signed-in' : 'signed-out';
                avatar.textContent = getInitial(displayName);
                nameEl.textContent = displayName;

                const baseStatus = isSignedIn ? 'Signed in' : 'Signed out';
                const statusText = !syncHealthy && isSignedIn ? `${baseStatus} • sync unavailable` : baseStatus;
                statusEl.textContent = statusText;

                signInButton.hidden = isSignedIn;
                signOutButton.hidden = !isSignedIn;

                if (trigger) {
                    const ariaLabel = isSignedIn
                        ? `Open account menu for ${displayName}`
                        : 'Open account menu. You are signed out.';
                    trigger.setAttribute('aria-label', ariaLabel);
                }
            }

            const closeMenu = typeof menu.__closeAccountMenu === 'function'
                ? menu.__closeAccountMenu
                : () => {}
            ;

            signInButton.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.warn('Sign-in failed', error);
                } finally {
                    closeMenu({ focusTrigger: true });
                }
            });

            signOutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.warn('Sign-out failed', error);
                }

                closeMenu({ focusTrigger: true });
            });

            onAuthStateChanged(auth, (user) => {
                currentAccount = user ?? null;
                updateUI(currentAccount);
                listeners.forEach((listener) => {
                    try {
                        listener(currentAccount);
                    } catch (error) {
                        console.error('Account listener error', error);
                    }
                });
            });

            updateUI(null);

            return {
                onUserChange(listener) {
                    if (typeof listener !== 'function') {
                        return () => {};
                    }

                    listeners.add(listener);
                    listener(currentAccount);
                    return () => {
                        listeners.delete(listener);
                    };
                },
                reportSyncStatus(healthy) {
                    syncHealthy = Boolean(healthy);
                    updateUI(currentAccount);
                }
            };
        }

        function userVaultRef(uid) {
            return ref(database, `users/${uid}/vault`);
        }

        function defaultUserState() {
            return {
                coins: defaultCoins,
                currentOutfit: defaultOutfit,
                ownedOutfits: Array.from(defaultOwnedOutfits)
            };
        }

        function sanitizeState(value) {
            let coinsValue = defaultCoins;
            let outfitValue = defaultOutfit;
            const owned = new Set(defaultOwnedOutfits);

            if (value && typeof value === 'object') {
                const parsedCoins = Number.parseInt(value.coins, 10);
                if (Number.isFinite(parsedCoins) && parsedCoins >= 0) {
                    coinsValue = parsedCoins;
                }

                if (Array.isArray(value.ownedOutfits)) {
                    value.ownedOutfits.forEach((item) => {
                        if (typeof item === 'string' && outfitById.has(item)) {
                            owned.add(item);
                        }
                    });
                }

                if (typeof value.currentOutfit === 'string' && outfitById.has(value.currentOutfit)) {
                    outfitValue = value.currentOutfit;
                }
            }

            owned.add(outfitValue);

            return {
                coins: coinsValue,
                currentOutfit: outfitValue,
                ownedOutfits: owned
            };
        }

        async function syncUserState(partial) {
            if (!currentUser || applyingRemoteState) {
                return;
            }

            try {
                await update(userVaultRef(currentUser.uid), partial);
                accountMenu.reportSyncStatus(true);
            } catch (error) {
                console.warn('Unable to sync wardrobe profile', error);
                accountMenu.reportSyncStatus(false);
            }
        }

        function persistCoins(value) {
            coins = value;
            if (!currentUser || applyingRemoteState) {
                return;
            }

            syncUserState({ coins: value });
        }

        function persistOwnedOutfits(owned) {
            if (!currentUser || applyingRemoteState) {
                return;
            }

            const list = Array.from(owned);
            syncUserState({ ownedOutfits: list });
        }

        function persistOutfit(value) {
            currentOutfit = value;
            if (!currentUser || applyingRemoteState) {
                return;
            }

            syncUserState({ currentOutfit: value });
        }

        function applyRemoteState(state) {
            applyingRemoteState = true;
            coins = state.coins;
            ownedOutfits = new Set(state.ownedOutfits);
            const applied = applyOutfit(state.currentOutfit);
            ownedOutfits.add(applied);
            applyingRemoteState = false;

            updateCurrencyUI();
            updateSummary();
            updateShopUI();
        }

        function updateCurrencyUI() {
            if (!currencyAmount) {
                return;
            }

            const label = coins === 1 ? 'coin' : 'coins';
            currencyAmount.textContent = `${coins} ${label}`;
        }

        function applyOutfit(value) {
            const next = value && outfitById.has(value) ? value : defaultOutfit;
            avatarPreview.dataset.outfit = next;
            currentOutfit = next;
            return next;
        }

        function updateSummary() {
            const details = outfitById.get(currentOutfit) ?? outfitById.get(defaultOutfit);
            const fallback = outfitById.get(defaultOutfit)?.name ?? 'Cozy Classic';
            shopSummary.textContent = `Currently wearing: ${details?.name ?? fallback}`;
        }

        function updateShopUI() {
            shopEntries.forEach((entry, outfitId) => {
                const owned = ownedOutfits.has(outfitId);
                const isEquipped = currentOutfit === outfitId;
                const { element, status, button, price } = entry;

                element.classList.toggle('is-owned', owned);
                element.classList.toggle('is-selected', isEquipped);

                if (status) {
                    if (!owned) {
                        if (price === 0) {
                            status.textContent = 'Included.';
                        } else if (price > coins) {
                            const short = Math.max(0, price - coins);
                            status.textContent = `Costs ${price} coin${price === 1 ? '' : 's'}. You're ${short} coin${short === 1 ? '' : 's'} short.`;
                        } else {
                            status.textContent = `Costs ${price} coin${price === 1 ? '' : 's'}.`;
                        }
                    } else {
                        status.textContent = isEquipped
                            ? 'Currently wearing this look.'
                            : 'Owned.';
                    }
                }

                if (button) {
                    if (!owned) {
                        const lacksCoins = price > coins;
                        const priceText = price === 0 ? 'Unlock' : `Buy for ${price} coin${price === 1 ? '' : 's'}`;
                        if (lacksCoins && price > 0) {
                            const short = Math.max(0, price - coins);
                            button.textContent = `Need ${short} more coin${short === 1 ? '' : 's'}`;
                        } else {
                            button.textContent = priceText;
                        }
                        button.disabled = lacksCoins && price > 0;
                    } else {
                        button.disabled = isEquipped;
                        button.textContent = isEquipped ? 'Equipped' : 'Wear';
                    }
                }
            });
        }

        shopGrid.addEventListener('click', (event) => {
            const button = event.target instanceof HTMLElement
                ? event.target.closest('[data-shop-action]')
                : null;

            if (!(button instanceof HTMLButtonElement)) {
                return;
            }

            const item = button.closest('[data-shop-item]');
            if (!item) {
                return;
            }

            const outfit = item.dataset.outfit;
            if (!outfit) {
                return;
            }

            const entry = shopEntries.get(outfit);
            if (!entry) {
                return;
            }

            const price = entry.price ?? 0;

            if (ownedOutfits.has(outfit)) {
                if (currentOutfit === outfit) {
                    return;
                }

                const applied = applyOutfit(outfit);
                persistOutfit(applied);
                updateSummary();
                updateShopUI();
                return;
            }

            if (price > coins) {
                updateShopUI();
                return;
            }

            coins = Math.max(0, coins - price);
            ownedOutfits.add(outfit);
            persistCoins(coins);
            persistOwnedOutfits(ownedOutfits);

            const applied = applyOutfit(outfit);
            persistOutfit(applied);
            updateCurrencyUI();
            updateSummary();
            updateShopUI();
        });

        const appliedDefault = applyOutfit(defaultOutfit);
        ownedOutfits.add(appliedDefault);
        updateCurrencyUI();
        updateSummary();
        updateShopUI();

        accountMenu.onUserChange((user) => {
            currentUser = user ?? null;

            if (stopUserListener) {
                stopUserListener();
                stopUserListener = null;
            }

            applyRemoteState(sanitizeState({}));

            if (!currentUser) {
                accountMenu.reportSyncStatus(true);
                return;
            }

            stopUserListener = onValue(
                userVaultRef(currentUser.uid),
                (snapshot) => {
                    if (!snapshot.exists()) {
                        set(userVaultRef(currentUser.uid), defaultUserState())
                            .then(() => {
                                accountMenu.reportSyncStatus(true);
                            })
                            .catch((error) => {
                                console.warn('Unable to initialize wardrobe profile', error);
                                accountMenu.reportSyncStatus(false);
                            });
                        return;
                    }

                    const sanitized = sanitizeState(snapshot.val());
                    applyRemoteState(sanitized);
                    accountMenu.reportSyncStatus(true);
                },
                (error) => {
                    console.warn('Unable to read wardrobe profile', error);
                    accountMenu.reportSyncStatus(false);
                }
            );
        });

    </script>
</body>
</html>
