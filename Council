<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Council of Power — Playable UI Mock (Pie + City)</title>
<style>
  :root{
    --bg:#090d14; --bg2:#0b111c; --panel:#0e1523; --panel2:#0a1120; --line:#22314a;
    --text:#e7eefc; --muted:#a8b5cc; --sub:#93a4bf;
    --accent:#7dd3fc; --accent2:#38bdf8; --glow:#7dd3fc33;
    --good:#86efac; --bad:#fca5a5; --warn:#fde68a; --shadow:0 18px 60px rgba(0,0,0,.45);

    --red:#ef4444; --blue:#60a5fa; --green:#34d399; --yellow:#facc15;
    --purple:#a78bfa; --orange:#fb923c; --cyan:#22d3ee; --gray:#94a3b8;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 70% -10%, #1a2740 0%, transparent 60%),
      radial-gradient(900px 900px at -10% 110%, #1a2238 0%, transparent 55%),
      linear-gradient(180deg, var(--bg), var(--bg2));
    color:var(--text);
    font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
  }

  /* Global buttons */
  button{
    background:
      linear-gradient(180deg,var(--accent),var(--accent2));
    color:#06101c;
    border:none;
    border-radius:14px;
    padding:12px 16px;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 10px 28px rgba(56,189,248,.25);
    transition:transform .08s ease, filter .15s ease, box-shadow .15s ease;
  }
  button:hover{ filter:brightness(1.04) }
  button:active{ transform:translateY(1px) }
  button:disabled{ opacity:.55; cursor:not-allowed }
  .btn-secondary{
    background:linear-gradient(180deg,#16223a,#0f182b);
    color:var(--text);
    border:1px solid #27334d;
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
  }

  /* Screens + cards */
  .screen{display:none;height:100%;align-items:center;justify-content:center}
  .screen.active{display:flex}
  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:var(--shadow);
    backdrop-filter:saturate(120%) blur(3px);
    position:relative;
  }
  .stack{display:flex;gap:14px;flex-wrap:wrap}

  h1,h2,h3{margin:0}
  h1.title{
    font-size:44px;letter-spacing:.6px;font-weight:1000;
    text-shadow:0 6px 30px rgba(125,211,252,.14);
  }
  .subtitle{color:var(--sub)}
  .eyebrow{
    letter-spacing:.12em;color:#82a0c7; font-size:12px; text-transform:uppercase;
  }

  /* Start */
  #screen-start .wrap{
    display:flex;flex-direction:column;align-items:center;gap:24px;padding:52px 60px
  }
  #logoSpark{
    position:absolute; inset:-2px; border-radius:inherit; pointer-events:none;
    box-shadow:0 0 0 1px rgba(125,211,252,.12) inset, 0 0 80px var(--glow);
  }

  /* Select */
  #screen-select .wrap{
    display:grid;grid-template-columns:380px 1fr;gap:24px;padding:24px;width:min(1200px,100%)
  }
  .role{
    display:flex;align-items:flex-start;gap:12px;padding:12px 12px 10px;
    border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#121a2a,#0c1424);
    transition:transform .06s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .role:hover{ transform:translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.35); border-color:#2b3a55 }
  .role input{accent-color:var(--accent);margin-top:2px}
  .pill{height:14px;width:14px;border-radius:4px;box-shadow:0 0 0 2px rgba(255,255,255,.08) inset}
  .desc{color:var(--muted);font-size:13px;margin-top:6px}

  /* Game layout */
  #screen-game{align-items:stretch}
  #game-wrap{display:grid;grid-template-columns: 900px 420px;gap:16px;padding:18px;width:min(1440px,100%)}
  #board{
    position:relative;height:900px;min-height:720px;
    background:
      radial-gradient(circle at 50% 40%, #0f1a2d 0%, #0b1323 60%, #091221 100%);
    border-radius:28px;border:1px solid var(--line);overflow:hidden;
  }
  #sidebar{display:flex;flex-direction:column;gap:12px}
  .panel{padding:14px 16px;border:1px solid var(--line);border-radius:18px;background:linear-gradient(180deg,#121a24,#0c1422); position:relative}
  .panel::after{
    content:''; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
  }
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}

  /* Pie map */
  .map{position:absolute;inset:32px;border-radius:50%;box-shadow:inset 0 0 50px rgba(0,0,0,.55)}
  .castle{
    position:absolute;inset:calc(50% - 74px);width:148px;height:148px;border-radius:50%;
    background:
      radial-gradient(circle at 30% 30%,#9aa5b1,#647184 65%);
    border:4px solid #a4adba;display:flex;align-items:center;justify-content:center;font-size:44px;z-index:3;
    box-shadow:0 10px 34px rgba(0,0,0,.45), inset 0 0 22px rgba(255,255,255,.08)
  }
  svg{position:absolute;inset:0}
  .slice{cursor:pointer;transition:filter .12s ease}
  .slice:hover{filter:brightness(1.08)}
  .district-label{font-size:13px;fill:#e5e7eb;text-shadow:0 1px 2px #000; text-anchor:middle;pointer-events:none}
  .owner-dot{stroke:#0b0f18;stroke-width:2}

  /* Slots */
  .badges{position:absolute;inset:0;pointer-events:none}
  body.aiming .slot.empty{box-shadow:0 0 0 1px rgba(125,211,252,.38), 0 0 24px rgba(56,189,248,.22)}
  .slot{
    position:absolute;width:28px;height:28px;border-radius:8px;border:1px solid #3a435b;
    background:linear-gradient(180deg,#0e1523,#0a1220);display:flex;align-items:center;justify-content:center;
    font-size:16px;color:#cbd5e1;pointer-events:auto;cursor:pointer;
    transition:transform .08s ease, background .15s ease, box-shadow .15s ease, opacity .15s ease;
  }
  .slot.empty{opacity:.85}
  .slot:hover{transform:translateY(-1px);background:#121b2d}
  .slot.owner-red{box-shadow:0 0 0 2px rgba(239,68,68,.35) inset}
  .slot.owner-blue{box-shadow:0 0 0 2px rgba(96,165,250,.35) inset}
  .slot.owner-green{box-shadow:0 0 0 2px rgba(52,211,153,.35) inset}
  .slot.owner-yellow{box-shadow:0 0 0 2px rgba(250,204,21,.45) inset}

  /* HUD */
  .hud{
    position:absolute;left:16px;right:16px;bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:16px
  }
  .pile{display:flex;align-items:center;gap:10px}
  .pile .box{
    width:84px;height:110px;border-radius:14px;border:1px dashed #39435b;background:linear-gradient(180deg,#141c2e,#0f1726);
    display:flex;align-items:center;justify-content:center;flex-direction:column;color:#a8c0e0;
    box-shadow:inset 0 6px 14px rgba(0,0,0,.35)
  }
  .hand{display:flex;gap:12px;min-height:132px;align-items:flex-end;flex-wrap:wrap}
  .hand .card-ui{
    width:190px;min-height:120px;border-radius:16px;padding:12px 12px;border:1px solid var(--line);
    background:linear-gradient(180deg,#141e32,#0f1727);
    display:flex;flex-direction:column;gap:8px;cursor:pointer;
    box-shadow:0 14px 28px rgba(0,0,0,.34), inset 0 1px 0 rgba(255,255,255,.04);
    transform:translateZ(0); transition:transform .12s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .hand .card-ui:hover{ transform:translateY(-2px) }
  .card-ui .name{font-weight:900;display:flex;align-items:center;justify-content:space-between}
  .card-ui .text{color:#c7d2fe;font-size:12px;opacity:.96}
  .card-ui .tags{font-size:11px;color:#93c5fd}
  .card-ui.selected{
    outline:2px solid var(--accent); box-shadow:0 16px 34px rgba(125,211,252,.28)
  }

  .meter{display:flex;gap:10px;flex-wrap:wrap}
  .dot{width:14px;height:14px;border-radius:4px}
  .score{font-weight:1000}
  .tiny{font-size:12px;color:var(--sub)}
  .muted{color:var(--muted); font-size:13px}

  .pill-red{background:var(--red)} .pill-blue{background:var(--blue)} .pill-green{background:var(--green)} .pill-yellow{background:var(--yellow)}
  .pill-purple{background:var(--purple)} .pill-orange{background:var(--orange)} .pill-cyan{background:var(--cyan)} .pill-gray{background:var(--gray)}

  /* Tooltip */
  #tooltip{
    position:absolute;pointer-events:none;background:linear-gradient(180deg,#0f1624,#0c1320);
    border:1px solid #27334d;color:var(--text);padding:8px 10px;border-radius:10px;font-size:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.4);opacity:0;transform:translate(-50%, -140%) scale(.98);
    transition:opacity .08s ease, transform .08s ease;max-width:240px;z-index:5
  }
  #tooltip.show{opacity:1;transform:translate(-50%, -150%) scale(1)}

  /* Header watermark */
  .brandbar{
    position:fixed;left:0;right:0;top:0;height:52px;display:flex;align-items:center;justify-content:center;
    pointer-events:none; color:#7aa5d8; font-weight:800; letter-spacing:.14em; font-size:12px; text-transform:uppercase;
    opacity:.65;
  }

  /* Noise & vignette for finish */
  .filmgrain::after{
    content:""; position:fixed; inset:0; pointer-events:none; opacity:.04; mix-blend-mode:overlay;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" opacity=".9" width="120" height="120" viewBox="0 0 120 120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".75" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" /></svg>');
    background-size:140px 140px;
  }
  .vignette::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:radial-gradient(55% 70% at 50% 40%, transparent 0%, transparent 60%, rgba(0,0,0,.38) 100%);
  }

  /* Footer tip */
  .footer{
    position:fixed; right:14px; bottom:10px; color:#7fa0c8; font-size:12px; opacity:.8;
    background:linear-gradient(180deg,#0e1523,#0b1220); border:1px solid #2a3957; border-radius:10px; padding:6px 10px;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
  }

  @media (max-width: 1180px){
    #game-wrap{ grid-template-columns:1fr; }
    #board{ height:760px }
  }
</style>
</head>
<body class="filmgrain vignette">

<div class="brandbar">Council of Power – Prototype UI</div>

<!-- START SCREEN -->
<section id="screen-start" class="screen active">
  <div class="card wrap" style="text-align:center; max-width:720px; width:calc(100% - 24px)">
    <div id="logoSpark"></div>
    <div class="eyebrow">Playable Mock</div>
    <h1 class="title">Council of Power</h1>
    <div class="subtitle">Semi-cooperative city control — polished prototype</div>
    <div class="stack" style="margin-top:6px">
      <button id="btnPlay" aria-label="Play">Play</button>
      <button class="btn-secondary" id="btnHow" aria-expanded="false">How it works</button>
    </div>
    <div id="how" class="desc" style="max-width:680px;display:none;margin-top:12px">
      Draw 2 cards, select 1, then click a district slice to play it. Cards add icons and influence there.
      Click a slice (district) to open its detail panel and see the actual cards & effects.
      Claim control by having the highest total influence in a district.
    </div>
  </div>
</section>

<!-- SELECT SCREEN -->
<section id="screen-select" class="screen">
  <div class="wrap" style="width:1100px; max-width:100%">
    <div class="card" style="padding:18px">
      <div class="eyebrow">Setup</div>
      <h2 style="margin:2px 0 10px">Choose Your Advisor</h2>
      <div class="desc">Pick a role & color. (Others are simulated lightly.)</div>
      <div class="stack" id="roleList" style="margin-top:10px"></div>
      <div style="margin-top:14px;display:flex;gap:10px">
        <button id="btnStartGame">Start</button>
        <button class="btn-secondary" id="btnBack1">Back</button>
      </div>
    </div>

    <div class="card" style="padding:18px">
      <div class="eyebrow">Deck</div>
      <h3 style="margin:2px 0 8px">Preview: Starter Cards</h3>
      <div id="deckPreview" class="stack"></div>
    </div>
  </div>
</section>

<!-- GAME SCREEN -->
<section id="screen-game" class="screen">
  <div id="game-wrap">
    <div id="board" class="card">
      <div id="pie" class="map">
        <div class="castle" title="High Keep">🏰</div>
      </div>

      <!-- slot badges -->
      <div class="badges" id="badges" aria-live="polite"></div>
      <div id="tooltip" role="status" aria-live="polite"></div>

      <!-- HUD -->
      <div class="hud">
        <div class="pile">
          <div class="box" id="deckBox" aria-label="Deck">
            <div>Deck</div><strong id="deckCount">0</strong>
          </div>
          <div class="box" id="discardBox" aria-label="Discard">
            <div>Discard</div><strong id="discardCount">0</strong>
          </div>
          <button id="btnDraw">Draw 2</button>
          <button id="btnEnd">End Turn</button>
        </div>
        <div class="hand" id="hand" aria-label="Your hand"></div>
      </div>
    </div>

    <div id="sidebar">
      <div class="panel">
        <div class="row">
          <div>
            <div class="eyebrow">Advisor</div>
            <div style="display:flex; align-items:center; gap:8px; font-weight:900" id="roleTitle">Advisor</div>
          </div>
          <div class="score">Score: <span id="score">0</span></div>
        </div>
        <div class="tiny" style="margin-top:6px">Click a card, then click a district to play it. Click a slice to view details.</div>
        <div class="meter" style="margin-top:10px" id="colorLegend"></div>
      </div>

      <div class="panel" id="districtPanel">
        <div class="row" style="margin-bottom:6px">
          <div>
            <div class="eyebrow">District</div>
            <div style="font-weight:900" id="districtTitle">—</div>
          </div>
          <div id="districtOwner" class="tiny muted">owner: —</div>
        </div>
        <div id="districtCards" class="stack"></div>
      </div>

      <div class="panel">
        <div class="eyebrow">Event</div>
        <div class="muted" id="eventText">No event this turn.</div>
      </div>
    </div>
  </div>
</section>

<div class="footer">Prototype • UI polish pass</div>

<script>
/* =========================
   Minimal Game State & Data
   ========================= */
const ROLES=[
  {id:'general', name:'General', color:'var(--red)', pill:'pill-red', starter:[
    {name:'Barracks', icon:'⚔️', inf:3, text:'Add +3 influence here.'},
    {name:'Patrols', icon:'🛡️', inf:2, text:'+2 influence; protects from next sabotage.'},
    {name:'Conscription', icon:'🏹', inf:2, text:'+2 influence; -1 event penalty if any.'},
    {name:'Watchtower', icon:'🏰', inf:1, text:'+1 influence; reveal district cards.'}
  ]},
  {id:'treasurer', name:'Treasurer', color:'var(--blue)', pill:'pill-blue', starter:[
    {name:'Market Guild', icon:'💰', inf:3, text:'+3 influence; this district yields +1 gold.'},
    {name:'Mint', icon:'🪙', inf:2, text:'+2 influence; draw +1 next turn.'},
    {name:'Tithe', icon:'📜', inf:2, text:'+2 influence; if you control, +1 score.'},
    {name:'Vault', icon:'🏦', inf:1, text:'+1 influence; immune to first fire.'}
  ]},
  {id:'diplomat', name:'Chancellor', color:'var(--green)', pill:'pill-green', starter:[
    {name:'Embassy', icon:'🏛️', inf:3, text:'+3 influence; adjacent unrest -1.'},
    {name:'Treaty', icon:'🤝', inf:2, text:'+2 influence; swap 1 banner if tie.'},
    {name:'Spy Network', icon:'🕵️', inf:2, text:'+2 influence; peek one hand card.'},
    {name:'Courier House', icon:'📯', inf:1, text:'+1 influence; your next card +1 inf.'}
  ]},
  {id:'priest', name:'High Priest', color:'var(--yellow)', pill:'pill-yellow', starter:[
    {name:'Library', icon:'📚', inf:2, text:'+2 influence; when you control, draw +1.'},
    {name:'Shrine', icon:'⛪', inf:2, text:'+2 influence; prevents unrest here.'},
    {name:'Festival', icon:'🎉', inf:2, text:'+2; at end, +1 score if Faith ≥ X (mock).'},
    {name:'Orphanage', icon:'🧒', inf:1, text:'+1; if adjacent Gardens, +1 more.'}
  ]}
];

const DISTRICTS=['Market','Harbor','Plaza','Temple Grounds','Barracks','Docks','Gardens','Walls'];

let state={
  role:null,
  deck:[], hand:[], discard:[],
  score:0,
  districts: DISTRICTS.map(name=>({name, owner:null, cards:[], slots:[null,null,null,null]})),
  selectedCardIndex:null,
};

/* ================
   Utility helpers
   ================ */
const $ = id => document.getElementById(id);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function colorFor(owner){ if(!owner) return 'var(--gray)'; return ROLES.find(r=>r.id===owner)?.color||'var(--gray)'; }
function toast(msg){ $('eventText').textContent = msg; }

/* =========
   Screens
   ========= */
const scrStart=$('screen-start');
const scrSelect=$('screen-select');
const scrGame=$('screen-game');

$('btnPlay').onclick=()=>{scrStart.classList.remove('active');scrSelect.classList.add('active')};
$('btnHow').onclick=()=>{
  const el=$('how'); const open = el.style.display==='none';
  el.style.display = open ? 'block' : 'none';
  $('btnHow').setAttribute('aria-expanded', open ? 'true' : 'false');
};
$('btnBack1').onclick=()=>{scrSelect.classList.remove('active');scrStart.classList.add('active')}

/* ======================
   Role Select Rendering
   ====================== */
const roleList=$('roleList');
let selectedRoleId='general';

function renderRoles(){
  roleList.innerHTML='';
  ROLES.forEach(r=>{
    const row=document.createElement('label');
    row.className='role';
    row.innerHTML=
      `<input type="radio" name="role" value="${r.id}" ${r.id===selectedRoleId?'checked':''} aria-label="${r.name}">`+
      `<span class="pill ${r.pill}"></span>`+
      `<div style="display:flex; flex-direction:column; gap:2px">
         <strong>${r.name}</strong>
         <div class="desc">Starter: ${r.starter.map(c=>`${c.icon} ${c.name}`).join(', ')}</div>
       </div>`;
    row.querySelector('input').onchange=()=>{selectedRoleId=r.id; renderDeckPreview();};
    roleList.appendChild(row);
  });
}
function renderDeckPreview(){
  const r=ROLES.find(x=>x.id===selectedRoleId);
  const wrap=$('deckPreview'); wrap.innerHTML='';
  r.starter.forEach(c=>{
    const el=document.createElement('div');
    el.className='card-ui';
    el.innerHTML=`<div class="name"><span>${c.icon} ${c.name}</span></div>
                  <div class="text">${c.text}</div>
                  <div class="tags">Influence: +${c.inf}</div>`;
    wrap.appendChild(el);
  });
}
renderRoles(); renderDeckPreview();

$('btnStartGame').onclick=()=>{
  const role=ROLES.find(r=>r.id===selectedRoleId);
  startGame(role);
  scrSelect.classList.remove('active');
  scrGame.classList.add('active');
};

/* ===============
   Game Lifecycle
   =============== */
function startGame(role){
  state.role=role.id;
  $('roleTitle').textContent=role.name;

  // build deck: duplicate starter 2x
  const d=[]; role.starter.forEach(c=>{d.push({...c, owner:role.id}); d.push({...c, owner:role.id});});
  state.deck=shuffle(d);
  state.hand=[]; state.discard=[]; state.score=0; state.selectedCardIndex=null;

  updateCounts();
  drawCards(5); // opening hand

  // draw map after layout
  requestAnimationFrame(()=>{ buildPie(); renderBadges(); runSelfTests(); });
  renderHand();
  renderColorLegend();
}

function updateCounts(){
  $('deckCount').textContent=state.deck.length;
  $('discardCount').textContent=state.discard.length;
  $('score').textContent=state.score;
}

/* ===========
   Hand / Draw
   =========== */
function drawCards(n){
  for(let i=0;i<n;i++){
    if(state.deck.length===0){ state.deck=shuffle(state.discard.splice(0)); }
    if(state.deck.length) state.hand.push(state.deck.pop());
  }
  renderHand(); updateCounts();
}
$('btnDraw').onclick=()=>drawCards(2);
$('btnEnd').onclick=()=>{
  // scoring: +1 per district you currently control
  const you=state.role;
  const add=state.districts.reduce((a,d)=>a+(d.owner===you?1:0),0);
  state.score+=add;
  updateCounts();
  $('eventText').textContent = add?`You control ${add} district(s). +${add} score.`:`No control this turn.`;
};

function renderHand(){
  const hand=$('hand'); hand.innerHTML='';
  state.hand.forEach((c,idx)=>{
    const el=document.createElement('div'); el.className='card-ui';
    if(state.selectedCardIndex===idx) el.classList.add('selected');
    el.innerHTML=`<div class="name">${c.icon} ${c.name}</div>
                  <div class="text">${c.text}</div>
                  <div class="tags">Influence: +${c.inf}</div>`;
    el.onclick=()=>{
      state.selectedCardIndex = state.selectedCardIndex===idx?null:idx;
      document.body.classList.toggle('aiming', state.selectedCardIndex!==null);
      renderHand();
    };
    hand.appendChild(el);
  });
}

/* =========================
   Map (SVG pie + skyline)
   ========================= */
function buildPie(){
  const pie=$('pie');
  pie.style.width='calc(100% - 64px)';
  pie.style.height='calc(100% - 64px)';

  const size=Math.min(pie.clientWidth||700, pie.clientHeight||700);
  const cx=size/2, cy=size/2, r=size/2-6;

  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width', size);
  svg.setAttribute('height', size);
  svg.setAttribute('viewBox',`0 0 ${size} ${size}`);

  // defs: subtle roof texture & soft vignette
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');

  const pattern=document.createElementNS('http://www.w3.org/2000/svg','pattern');
  pattern.setAttribute('id','roof'); pattern.setAttribute('width','10'); pattern.setAttribute('height','10');
  pattern.setAttribute('patternUnits','userSpaceOnUse');
  const pr1=document.createElementNS('http://www.w3.org/2000/svg','rect');
  pr1.setAttribute('width','10'); pr1.setAttribute('height','10'); pr1.setAttribute('fill','#1a2336');
  const pr2=document.createElementNS('http://www.w3.org/2000/svg','path');
  pr2.setAttribute('d','M0 0 L10 0 L10 10 Z'); pr2.setAttribute('fill','#182133'); pr2.setAttribute('opacity','0.65');
  pattern.appendChild(pr1); pattern.appendChild(pr2); defs.appendChild(pattern);

  svg.appendChild(defs);

  // skyline ring (decorative city feel)
  const skyline=document.createElementNS('http://www.w3.org/2000/svg','g');
  const skyR = r*0.97, baseY = cy;
  for(let i=0;i<42;i++){
    const ang = (i/42)*Math.PI*2;
    const x = cx + skyR*Math.cos(ang);
    const y = cy + skyR*Math.sin(ang);
    const h = 10 + Math.random()*26;
    const w = 3 + Math.random()*5;
    const rot = (ang*180/Math.PI)+90;
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', -w/2); rect.setAttribute('y', -h);
    rect.setAttribute('width', w); rect.setAttribute('height', h);
    rect.setAttribute('fill', ['#233149','#263657','#2a3a5b','#314361'][Math.floor(Math.random()*4)]);
    rect.setAttribute('transform', `translate(${x} ${y}) rotate(${rot})`);
    skyline.appendChild(rect);
  }
  svg.appendChild(skyline);

  // ring roads
  const roads = document.createElementNS('http://www.w3.org/2000/svg','g');
  [0.35,0.6,0.85].forEach(fr=>{
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r*fr);
    c.setAttribute('fill','none'); c.setAttribute('stroke','#1d2740'); c.setAttribute('stroke-width','3'); c.setAttribute('opacity','0.9');
    roads.appendChild(c);
  });

  const streetsG=document.createElementNS('http://www.w3.org/2000/svg','g');

  const slices=DISTRICTS.length; const sweep=360/slices;
  const neutralStroke='#2a3a57';

  for(let i=0;i<slices;i++){
    const a0=(i*sweep-90)*Math.PI/180, a1=((i+1)*sweep-90)*Math.PI/180;
    const x0=cx+r*Math.cos(a0), y0=cy+r*Math.sin(a0);
    const x1=cx+r*Math.cos(a1), y1=cy+r*Math.sin(a1);
    const large = sweep>180 ? 1 : 0;
    const path=`M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`;

    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d',path);
    p.setAttribute('class','slice');
    p.setAttribute('data-index',i);
    p.setAttribute('fill','url(#roof)');
    const owner=state.districts[i].owner; const stroke = owner ? colorFor(owner) : neutralStroke;
    p.setAttribute('stroke', stroke);
    p.setAttribute('stroke-width','10');
    p.onclick=onSliceClick;
    svg.appendChild(p);

    // boundary street
    const street=document.createElementNS('http://www.w3.org/2000/svg','line');
    street.setAttribute('x1',cx); street.setAttribute('y1',cy);
    street.setAttribute('x2',x0); street.setAttribute('y2',y0);
    street.setAttribute('stroke','#16213a'); street.setAttribute('stroke-width','3');
    streetsG.appendChild(street);

    // label
    const mid=(i+0.5)*sweep-90; const rad=(r*0.72);
    const lx=cx+rad*Math.cos(mid*Math.PI/180); const ly=cy+rad*Math.sin(mid*Math.PI/180);
    const text=document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('x',lx); text.setAttribute('y',ly);
    text.setAttribute('class','district-label');
    text.textContent=DISTRICTS[i];
    svg.appendChild(text);

    // owner dot near edge
    const odr = r*0.92; const ox=cx+odr*Math.cos(mid*Math.PI/180); const oy=cy+odr*Math.sin(mid*Math.PI/180);
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('cx',ox); dot.setAttribute('cy',oy); dot.setAttribute('r',8);
    dot.setAttribute('fill', colorFor(state.districts[i].owner));
    dot.setAttribute('class','owner-dot');
    dot.setAttribute('data-od',i);
    svg.appendChild(dot);

    // tiny buildings scatter
    const buildings=document.createElementNS('http://www.w3.org/2000/svg','g');
    const bCount=26;
    for(let b=0;b<bCount;b++){
      const rr = r*(0.43 + Math.random()*0.44);
      const ang = (i*sweep + Math.random()*sweep - 90) * Math.PI/180;
      const bx=cx+rr*Math.cos(ang), by=cy+rr*Math.sin(ang);
      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      const s=2.5+Math.random()*3.2;
      rect.setAttribute('x',bx - s/2); rect.setAttribute('y',by - s/2);
      rect.setAttribute('width',s); rect.setAttribute('height',s);
      rect.setAttribute('rx',0.8);
      rect.setAttribute('fill', ['#233149','#263657','#2a3a5b','#314361'][Math.floor(Math.random()*4)]);
      buildings.appendChild(rect);
    }
    svg.appendChild(buildings);
  }

  svg.appendChild(roads);
  svg.appendChild(streetsG);

  const old=pie.querySelector('svg'); if(old) old.remove();
  pie.appendChild(svg);
}

function onSliceClick(e){
  const idx= +e.target.getAttribute('data-index');
  if(Number.isNaN(idx)) return;
  if(state.selectedCardIndex==null){ openDistrictPanel(idx); return; }
  // We have a selected card -> nudge user to pick a slot
  document.body.classList.add('aiming');
  toast('Choose a ＋ slot in that district to place your card.');
}

/* =================
   Badge Slots Layer
   ================= */
function renderBadges(){
  const wrap=$('badges'); wrap.innerHTML='';
  const rect=$('pie').getBoundingClientRect();
  const size=Math.min(rect.width, rect.height);
  const cx=size/2, cy=size/2, r=size/2-6; const slices=DISTRICTS.length; const sweep=360/slices;

  state.districts.forEach((d,i)=>{
    const mid=(i+0.5)*sweep-90; const ring=r*0.82; // slot ring
    for(let s=0;s<d.slots.length;s++){
      const spread=10; // degrees between slots
      const angle=mid + (s-(d.slots.length-1)/2)*spread;
      const x=cx+ring*Math.cos(angle*Math.PI/180); const y=cy+ring*Math.sin(angle*Math.PI/180);

      const el=document.createElement('div'); el.className='slot';
      el.style.left=(x-14)+'px'; el.style.top=(y-14)+'px';
      el.dataset.d=i; el.dataset.s=s;

      const slotCard=d.slots[s];
      if(slotCard){
        const who=ROLES.find(r=>r.id===slotCard.owner);
        const ownerClass = who ? `owner-${who.pill.replace('pill-','')}` : '';
        if(ownerClass) el.classList.add(ownerClass);
        el.title = `${slotCard.icon} ${slotCard.name}: ${slotCard.text}  (+${slotCard.inf} inf)`;
        el.textContent = slotCard.icon;
      }else{
        el.classList.add('empty');
        el.title = 'Empty building slot';
        el.textContent = '＋';
      }
      wrap.appendChild(el);
    }
  });
}

// slot click handler
$('badges').addEventListener('click', (e)=>{
  const t=e.target.closest('.slot'); if(!t) return;
  const di=+t.dataset.d, si=+t.dataset.s;
  const d=state.districts[di];

  if(state.selectedCardIndex==null){ openDistrictPanel(di); return; }
  if(d.slots[si]){ toast('That slot is occupied.'); return; }

  const card = state.hand.splice(state.selectedCardIndex,1)[0];
  state.selectedCardIndex=null; document.body.classList.remove('aiming'); renderHand();

  d.slots[si] = {owner:state.role, ...card};
  d.cards.push(d.slots[si]);

  // recompute control
  const totals={}; d.cards.forEach(c=>{totals[c.owner]=(totals[c.owner]||0)+c.inf});
  let topOwner=null, topVal=-1; Object.entries(totals).forEach(([o,v])=>{if(v>topVal){topOwner=o; topVal=v}});
  d.owner=topOwner;

  // micro animation
  t.style.transform='scale(0.9)'; setTimeout(()=>{t.style.transform='';},100);

  renderBadges(); buildPie(); openDistrictPanel(di); updateCounts();
});

// tooltips
const tooltip=$('tooltip');
$('badges').addEventListener('mousemove',(e)=>{
  const t=e.target.closest('.slot');
  if(!t){ tooltip.classList.remove('show'); return; }
  const di=+t.dataset.d, si=+t.dataset.s; const slot=state.districts[di].slots[si];
  if(slot){
    tooltip.innerHTML = `<strong>${slot.icon} ${slot.name}</strong><br>
                         <span style="color:var(--muted)">${slot.text}</span><br>
                         <em>Influence: +${slot.inf}</em>`;
  }else{
    tooltip.innerHTML = '<em>Empty building slot</em>';
  }
  const boardRect=$('board').getBoundingClientRect();
  tooltip.style.left=(e.clientX-boardRect.left)+'px';
  tooltip.style.top=(e.clientY-boardRect.top)+'px';
  tooltip.classList.add('show');
});
$('badges').addEventListener('mouseleave',()=>tooltip.classList.remove('show'));

/* ======================
   District Detail Panel
   ====================== */
function openDistrictPanel(idx){
  const d=state.districts[idx];
  $('districtTitle').textContent=d.name;
  $('districtOwner').textContent='owner: '+(ROLES.find(r=>r.id===d.owner)?.name||'—');
  const list=$('districtCards'); list.innerHTML='';
  d.cards.slice().reverse().forEach(c=>{
    const el=document.createElement('div'); el.className='card-ui';
    const who=ROLES.find(r=>r.id===c.owner);
    el.innerHTML=`<div class="name">
                    <span>${c.icon} ${c.name}</span>
                    <span class="dot" style="background:${who?who.color:'var(--gray)'}"></span>
                  </div>
                  <div class="text">${c.text}</div>
                  <div class="tags">Influence here: +${c.inf}</div>`;
    list.appendChild(el);
  });
}

/* ===============
   Role Legend Row
   =============== */
function renderColorLegend(){
  const row=$('colorLegend'); row.innerHTML='';
  ROLES.forEach(r=>{
    const d=document.createElement('div');
    d.style.display='flex'; d.style.alignItems='center'; d.style.gap='6px';
    d.innerHTML=`<span class="dot" style="background:${r.color}"></span><span class="tiny">${r.name}</span>`;
    row.appendChild(d);
  });
}

/* =============
   Self Tests
   ============= */
function runSelfTests(){
  try{
    const slices = document.querySelectorAll('#pie svg .slice');
    if(slices.length !== DISTRICTS.length) throw new Error(`Expected ${DISTRICTS.length} slices, found ${slices.length}`);
    // click open first district
    const first = slices[0]; first.dispatchEvent(new Event('click', {bubbles:true}));
    const title = $('districtTitle').textContent;
    if(title !== DISTRICTS[0]) throw new Error('District panel wrong');
    // slots exist
    const slots = document.querySelectorAll('#badges .slot');
    if(slots.length < DISTRICTS.length*4) throw new Error('Slots missing');
    toast('Self-tests passed ✅');
  }catch(err){
    toast('Self-tests failed: '+ err.message);
    console.error(err);
  }
}
</script>
</body>
</html>
