<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3×3 Image Grid Uploader</title>
  <style>
    :root{
      --card:#1c0a14;      /* grid background */
      --line:#3a1827;      /* grid line */
      --ring:#ffb6e5;      /* focus ring */
      --text:#f9ecff;      /* text */
      --text-soft:rgba(249,236,255,.85);
      --muted:#d5b4c9;     /* subtler text */
      --btn:#23101a;       /* button bg */
      --btn-hover:#2e1823; /* hover */
      --tile-start:#3c1037;
      --tile-mid:#2a0926;
      --tile-end:#170416;
      --tile-border:rgba(255,200,255,.35);
      --tile-border-hover:rgba(255,220,255,.5);
      --grid-size:672px;
      --grid-gap:6px;
      --grid-padding:6px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background-color:#10030f;
      background:
        radial-gradient(90% 140% at 0% 50%, rgba(123, 45, 99, 0.32), rgba(16, 3, 15, 0)),
        radial-gradient(90% 140% at 100% 50%, rgba(76, 34, 122, 0.3), rgba(16, 3, 15, 0)),
        linear-gradient(180deg, #160416 0%, #080009 100%);
      display:flex; flex-direction:column; align-items:center; gap:16px; padding:16px;
    }

    .back-button{
      align-self:flex-start;
      margin-bottom:4px;
    }

    .workspace{
      width:100%;
      max-width:calc(var(--grid-size) + 320px);
      margin:0 auto;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      gap:32px;
    }
    .toolbar-left,
    .toolbar-right{
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:stretch;
      flex:0 0 auto;
    }
    button, label.button{
      border:1px solid var(--line); background:var(--btn); color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; 
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none; display:inline-flex; align-items:center; gap:8px;
    }
    button:hover, label.button:hover{background:var(--btn-hover)}
    button:active, label.button:active{transform:translateY(1px)}
    button:focus-visible, label.button:focus-visible{outline:2px solid var(--ring); outline-offset:2px}

    #bulkInput{display:none}

    /* GRID WRAPPER */
    .grid-wrap{flex:0 0 auto; width:min(92vw, var(--grid-size));}
    .grid{
      background:var(--card);
      display:grid; grid-template-columns:repeat(3, 1fr); gap:var(--grid-gap); padding:var(--grid-padding); border-radius:16px; border:1px solid #000;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }

    /* Each cell maintains a square via aspect-ratio */
    .cell{
      position:relative; aspect-ratio:1/1; border-radius:12px; overflow:hidden;
      border:1px dashed var(--tile-border);
      background:linear-gradient(145deg, var(--tile-start) 0%, var(--tile-mid) 45%, var(--tile-end) 100%);
      display:grid; place-items:center; color:var(--text-soft);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.05),
        inset 0 -12px 26px rgba(0,0,0,.45);
    }
    .cell:hover{border-color:var(--tile-border-hover)}

    .cell input[type=file]{display:none}

    .prompt{ text-align:center; padding:8px; }
    .prompt svg{width:28px; height:28px; opacity:.85; display:block; margin:0 auto 8px; color:var(--text-soft)}
    .prompt b{color:var(--text)}

    /* Image preview */
    .preview{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      background-color:rgba(16, 3, 15, 0.85);
    }

    /* Controls inside cell */
    .controls{position:absolute; inset:auto 8px 8px auto; display:flex; gap:6px; opacity:0; transition:opacity .2s ease}
    .cell:hover .controls{opacity:1}
    .icon-btn{
      border:1px solid var(--line); background:rgba(15,18,22,.75); backdrop-filter:blur(6px);
      width:34px; height:34px; border-radius:9px; display:inline-grid; place-items:center; cursor:pointer;
    }
    .icon-btn:hover{background:rgba(28,35,48,.85)}
    .icon-btn svg{width:18px; height:18px; fill:#e8eef6}

    /* Keyboard focus style for cells */
    .cell:focus-within{outline:2px solid var(--ring); outline-offset:2px}

    @media (max-width: 960px){
      .workspace{flex-direction:column; align-items:center; gap:24px;}
      .toolbar-left,
      .toolbar-right{align-items:center; flex-direction:row; flex-wrap:wrap; justify-content:center; width:100%;}
      .toolbar-right{align-items:center;}
    }

  </style>
</head>
<body>
  <button class="back-button" type="button" data-back-button aria-label="Back">← Back</button>
  <div class="workspace" aria-label="Grid controls and preview">
    <div class="toolbar-left">
      <label class="button" for="bulkInput" title="Add images; they will fill empty cells left-to-right, top-to-bottom.">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Browse images
      </label>
      <input id="bulkInput" type="file" accept="image/*" multiple />
    </div>
    <main class="grid-wrap">
      <section class="grid" id="grid" aria-label="3 by 3 image grid">
      <!-- 9 cells generated by JS if you prefer; here we hardcode for clarity -->
      <div class="cell" data-index="0" tabindex="0">
        <img alt="" class="preview" hidden />
        <div class="prompt" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg>
          <div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div>
        </div>
        <div class="controls" aria-hidden="true">
          <button class="icon-btn replace" title="Replace image" aria-label="Replace image">
            <svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg>
          </button>
          <button class="icon-btn clear" title="Clear image" aria-label="Clear image">
            <svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg>
          </button>
        </div>
        <input type="file" accept="image/*" aria-label="Upload image for cell 1" />
      </div>

      <!-- Duplicate 8 more cells -->
      <div class="cell" data-index="1" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 2" /></div>
      <div class="cell" data-index="2" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 3" /></div>
      <div class="cell" data-index="3" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 4" /></div>
      <div class="cell" data-index="4" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 5" /></div>
      <div class="cell" data-index="5" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 6" /></div>
      <div class="cell" data-index="6" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 7" /></div>
      <div class="cell" data-index="7" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 8" /></div>
      <div class="cell" data-index="8" tabindex="0"><img alt="" class="preview" hidden /><div class="prompt" aria-hidden="true"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-2h4l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Zm-7-3l3-4 4 5H5l4-5 3 4Z"/></svg><div><b>Click</b> to upload<br/><b>Drop</b> or <b>paste</b> an image</div></div><div class="controls" aria-hidden="true"><button class="icon-btn replace" title="Replace image" aria-label="Replace image"><svg viewBox="0 0 24 24"><path d="M12 5v2a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7Zm-7 7H3l3-3 3 3H8a4 4 0 1 0 4 4v2a6 6 0 1 1-6-6Z"/></svg></button><button class="icon-btn clear" title="Clear image" aria-label="Clear image"><svg viewBox="0 0 24 24"><path d="M6 7h12M9 7v10m6-10v10M4 7h16l-1 13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Zm4-3h8l1 3H7l1-3Z"/></svg></button></div><input type="file" accept="image/*" aria-label="Upload image for cell 9" /></div>
      </section>
    </main>

    <div class="toolbar-right">
      <button id="resetGrid" type="button" title="Clear all images from the grid">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18M6 6v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6M9 6V4a3 3 0 0 1 3-3v0a3 3 0 0 1 3 3v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Reset grid
      </button>
      <button id="downloadScreenshot" type="button" title="Download a PNG of the current grid">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3a1 1 0 0 1 1 1v9.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L11 13.586V4a1 1 0 0 1 1-1Zm-7 14a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H6v1h12v-1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1Z"/></svg>
        Download screenshot
      </button>
    </div>
  </div>

  <script>
    const backButton = document.querySelector('[data-back-button]');
    if (backButton) {
      backButton.addEventListener('click', () => {
        if (window.history.length <= 1) {
          window.location.href = 'index.html';
        } else {
          window.history.back();
        }
      });
    }

    /**
     * Minimal, dependency‑free uploader for a 3×3 grid.
     * Features:
     *  - Click cell to pick an image
     *  - Drag & drop files onto cells
     *  - Replace / Clear per cell
     *  - Bulk add (fills empty cells)
     *  - Keyboard friendly (Tab into a cell, press Enter to open file picker)
     */

    const grid = document.getElementById('grid');
    const cells = Array.from(grid.querySelectorAll('.cell'));
    const gridWrap = document.querySelector('.grid-wrap');
    const bulkInput = document.getElementById('bulkInput');
    const resetButton = document.getElementById('resetGrid');
    const screenshotButton = document.getElementById('downloadScreenshot');
    let hoveredCell = null;

    function setPreviewFromFile(cell, file){
      if(!file || !file.type.startsWith('image/')) return;
      const objectUrl = URL.createObjectURL(file);
      setCellImage(cell, { src: objectUrl, alt: file.name, revokeOnClear: true });
    }

    function setCellImage(cell, { src, alt = '', revokeOnClear = false }){
      const img = cell.querySelector('.preview');
      const prompt = cell.querySelector('.prompt');
      if(cell.dataset.revokeUrl && cell.dataset.revokeUrl !== src){
        URL.revokeObjectURL(cell.dataset.revokeUrl);
      }
      img.src = src;
      img.alt = alt;
      img.hidden = false;
      prompt.hidden = true;
      cell.dataset.filled = '1';
      if(revokeOnClear){
        cell.dataset.revokeUrl = src;
      }else{
        delete cell.dataset.revokeUrl;
      }
    }

    function clearCell(cell){
      const img = cell.querySelector('.preview');
      const input = cell.querySelector('input[type=file]');
      const prompt = cell.querySelector('.prompt');
      if(cell.dataset.revokeUrl){
        URL.revokeObjectURL(cell.dataset.revokeUrl);
        delete cell.dataset.revokeUrl;
      }
      img.removeAttribute('src');
      img.alt = '';
      img.hidden = true;
      prompt.hidden = false;
      input.value = '';
      delete cell.dataset.filled;
    }

    function openPicker(cell){
      const input = cell.querySelector('input[type=file]');
      input.click();
    }

    function getImageFromTransfer(transfer){
      if(!transfer) return null;
      const files = Array.from(transfer.files || []).filter(file=>file.type.startsWith('image/'));
      if(files.length) return files[0];
      const items = Array.from(transfer.items || []);
      for(const item of items){
        if(item.kind === 'file' && item.type.startsWith('image/')){
          const file = item.getAsFile();
          if(file) return file;
        }
      }
      return null;
    }

    function handlePasteEvent(e){
      const file = getImageFromTransfer(e.clipboardData);
      if(!file) return;
      e.preventDefault();
      const eventTargetCell = e.target?.closest?.('.cell');
      const activeCell = document.activeElement?.closest?.('.cell');
      const targetCell = eventTargetCell || hoveredCell || activeCell || cells.find(cell=>!cell.dataset.filled) || cells[0];
      if(targetCell){
        setPreviewFromFile(targetCell, file);
      }
    }

    // Per‑cell listeners
    cells.forEach((cell)=>{
      const input = cell.querySelector('input[type=file]');
      const replaceBtn = cell.querySelector('.replace');
      const clearBtn = cell.querySelector('.clear');

      cell.addEventListener('mouseenter', ()=>{ hoveredCell = cell; });
      cell.addEventListener('mouseleave', ()=>{ if(hoveredCell === cell) hoveredCell = null; });

      // Click empty area to pick file
      cell.addEventListener('click', (e)=>{
        // avoid clicks on control buttons bubbling
        if(e.target.closest('.controls')) return;
        openPicker(cell);
      });

      // Keyboard: Enter opens picker
      cell.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          openPicker(cell);
        }
      });

      // File picked
      input.addEventListener('change', (e)=>{
        const file = e.target.files?.[0];
        if(file) setPreviewFromFile(cell, file);
      });

      replaceBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openPicker(cell); });
      clearBtn.addEventListener('click', (e)=>{ e.stopPropagation(); clearCell(cell); });

      // Drag & drop
      ;['dragenter','dragover'].forEach(evt=>{
        cell.addEventListener(evt, (e)=>{ e.preventDefault(); cell.style.outline = '2px solid var(--ring)'; });
      });
      cell.addEventListener('dragleave', (e)=>{
        e.preventDefault();
        const related = e.relatedTarget;
        if(!related || !cell.contains(related)){
          cell.style.outline = '';
        }
      });
      cell.addEventListener('drop', (e)=>{
        e.preventDefault();
        cell.style.outline = '';
      });
      cell.addEventListener('drop', (e)=>{
        const file = e.dataTransfer?.files?.[0];
        if(file) setPreviewFromFile(cell, file);
      });

      cell.addEventListener('paste', handlePasteEvent);

      // Optional: Right‑click to clear
      cell.addEventListener('contextmenu', (e)=>{ e.preventDefault(); clearCell(cell); });
    });

    // Bulk add fills empty cells left‑to‑right, top‑to‑bottom
    if(bulkInput){
      bulkInput.addEventListener('change', (e)=>{
        const files = Array.from(e.target.files || []).filter(f=>f.type.startsWith('image/'));
        if(!files.length) return;
        let i = 0;
        cells.forEach(cell=>{
          if(i >= files.length) return;
          if(!cell.dataset.filled){ setPreviewFromFile(cell, files[i++]); }
        });
        bulkInput.value = '';
      });
    }

    // Reset all
    if(resetButton){
      resetButton.addEventListener('click', ()=>{
        cells.forEach(clearCell);
      });
    }

    async function imageElementToDataUrl(img){
      if(!img) return '';
      const src = img.currentSrc || img.src;
      if(!src) return '';
      if(src.startsWith('data:')){
        return src;
      }
      try{
        const response = await fetch(src);
        const blob = await response.blob();
        return await new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onloadend = ()=>resolve(reader.result?.toString() || '');
          reader.onerror = ()=>reject(new Error('Failed to read image data.'));
          reader.readAsDataURL(blob);
        });
      }catch(err){
        try{
          if(img.naturalWidth && img.naturalHeight){
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            if(ctx){
              ctx.drawImage(img, 0, 0);
              return canvas.toDataURL('image/png');
            }
          }
        }catch(innerErr){
          console.error('Unable to draw image for screenshot', innerErr);
        }
        console.error('Unable to inline image for screenshot', err);
        return '';
      }
    }

    async function downloadGridAsImage(){
      if(!gridWrap || !screenshotButton) return;
      screenshotButton.disabled = true;
      screenshotButton.setAttribute('aria-busy', 'true');

      let svgUrl = '';
      try{
        const styles = Array.from(document.querySelectorAll('style'))
          .map(style=>style.textContent || '')
          .join('\n');
        const width = Math.ceil(gridWrap.offsetWidth);
        const height = Math.ceil(gridWrap.offsetHeight);

        const clone = gridWrap.cloneNode(true);
        clone.querySelectorAll('input[type="file"]').forEach(input=>input.remove());
        clone.style.width = `${width}px`;
        clone.style.maxWidth = 'none';

        const originalImages = Array.from(gridWrap.querySelectorAll('img.preview'));
        const cloneImages = Array.from(clone.querySelectorAll('img.preview'));
        await Promise.all(cloneImages.map(async (cloneImg, index)=>{
          const original = originalImages[index];
          if(!original) return;
          const dataUrl = await imageElementToDataUrl(original);
          if(dataUrl){
            cloneImg.src = dataUrl;
          }
        }));
        const wrapper = document.createElement('div');
        wrapper.appendChild(clone);

        const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
  <foreignObject width="100%" height="100%">
    <div xmlns="http://www.w3.org/1999/xhtml">
      <style>${styles}</style>
      ${wrapper.innerHTML}
    </div>
  </foreignObject>
</svg>`;

        const svgBlob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
        svgUrl = URL.createObjectURL(svgBlob);

        const scale = window.devicePixelRatio || 1;
        const img = await new Promise((resolve, reject)=>{
          const image = new Image();
          image.onload = ()=>resolve(image);
          image.onerror = ()=>reject(new Error('Failed to load SVG data.'));
          image.src = svgUrl;
        });

        const canvas = document.createElement('canvas');
        canvas.width = width * scale;
        canvas.height = height * scale;
        const ctx = canvas.getContext('2d');
        if(!ctx){
          throw new Error('Canvas not supported in this browser.');
        }
        ctx.scale(scale, scale);
        ctx.drawImage(img, 0, 0, width, height);

        const pngBlob = await new Promise((resolve, reject)=>{
          canvas.toBlob(blob=>{
            if(blob) resolve(blob);
            else reject(new Error('Unable to generate PNG.'));
          }, 'image/png');
        });

        const downloadUrl = URL.createObjectURL(pngBlob);
        const anchor = document.createElement('a');
        anchor.href = downloadUrl;
        anchor.download = 'movie-grid.png';
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
        URL.revokeObjectURL(downloadUrl);
      }catch(err){
        console.error(err);
        alert('Sorry, something went wrong while creating the screenshot.');
      }finally{
        if(svgUrl){
          URL.revokeObjectURL(svgUrl);
        }
        screenshotButton.disabled = false;
        screenshotButton.removeAttribute('aria-busy');
      }
    }

    if(screenshotButton){
      screenshotButton.addEventListener('click', ()=>{
        downloadGridAsImage();
      });
    }

    document.addEventListener('paste', handlePasteEvent);
  </script>
</body>
</html>
