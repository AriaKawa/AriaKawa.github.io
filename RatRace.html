<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rat Races â€” ARIA ARCADE</title>
<style>
  :root{
    --bg:#0b1020;        /* site navy */
    --felt:#0e4d37;      /* track */
    --felt-dark:#0a3a2a;
    --lane:#145a46;
    --line:rgba(255,255,255,.16);
    --card:#151a29;
    --text:#e8eef6;
    --muted:#a9b4c7;
    --accent:#ffd13b;
    --accent2:#2b3350;
    --win:#63d471;
    --lose:#ef476f;
    --shadow:0 14px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at 20% 20%, rgba(53,104,214,.25) 0 24%, transparent 60%),
      radial-gradient(circle at 80% 10%, rgba(255,209,59,.15) 0 28%, transparent 62%),
      linear-gradient(160deg, #05060d 0%, #090f1f 60%, #0c1228 100%);
    display:flex; min-height:100dvh; align-items:center; justify-content:center; padding:24px 0;
  }
  .wrap{
    width:min(1240px,96vw); margin:0 auto; display:grid; gap:22px;
    grid-template-columns: 1.15fr .85fr; align-items:start;
  }
  @media (max-width:1080px){ .wrap{ grid-template-columns: 1fr; max-width:680px; } }

  /* Track */
  .track{
    position:relative; aspect-ratio: 16/9; border-radius:32px; overflow:hidden;
    background:
      radial-gradient(150% 130% at 50% -10%, rgba(82,212,183,.25) 0%, rgba(11,78,59,.18) 45%, rgba(5,34,27,1) 100%),
      linear-gradient(180deg, #0b4030 0%, #05231a 85%);
    border:8px solid rgba(8,32,24,.95); box-shadow:0 40px 80px rgba(0,0,0,.45);
  }
  .track::before{
    content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.55) 0%, rgba(0,0,0,0) 32%);
    pointer-events:none; z-index:2;
  }
  .track::after{
    content:""; position:absolute; inset:20px; border-radius:26px;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.08), inset 0 -40px 60px rgba(0,0,0,.4);
    background:radial-gradient(120% 150% at 50% 120%, rgba(255,255,255,.05) 0, transparent 65%);
  }
  .lanes{
    position:absolute; inset:36px 34px 92px 34px; display:grid; gap:12px; z-index:1;
    filter:drop-shadow(0 18px 24px rgba(0,0,0,.35));
  }
  .lane{
    position:relative; overflow:hidden; border-radius:18px; border:1px solid rgba(255,255,255,.08);
    background:
      linear-gradient(90deg, rgba(255,255,255,.08) 0 8px, transparent 8px 18px) repeat-x,
      linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
    background-size:36px 100%, 100% 100%;
  }
  .lane::before{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background:linear-gradient(180deg, rgba(255,255,255,.12) 0%, rgba(0,0,0,.18) 70%);
    mix-blend-mode:soft-light; opacity:.55;
  }
  .finish{
    position:absolute; top:36px; bottom:92px; right:40px; width:12px;
    background:
      linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,0) 18%, rgba(0,0,0,.45) 100%),
      repeating-linear-gradient(180deg, #f4f5f7 0 14px, #1a1f26 14px 28px);
    box-shadow:inset 0 0 0 2px rgba(0,0,0,.6), 0 12px 20px rgba(0,0,0,.45);
    border-radius:6px;
  }

  /* Rat */
  .rat{
    position:absolute; left:0; top:50%; transform:translate(0,-50%);
    width:140px; height:70px; display:grid; place-items:center; pointer-events:none;
  }
  .rat svg{ width:138px; height:auto; }
  .rat svg .tail{ animation:tail-sway 1.1s ease-in-out infinite; transform-origin:24px 70px; }
  .rat svg .body-group{ animation:body-bob .42s ease-in-out infinite; transform-origin:130px 78px; }
  .rat svg .ear{ animation:ear-flick 2.8s ease-in-out infinite; transform-origin:182px 40px; }
  .rat svg .sparkle{ animation:sparkle 2s linear infinite; }
  @keyframes body-bob{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(-4px); } }
  @keyframes tail-sway{ 0%,100%{ transform:rotate(-6deg); } 50%{ transform:rotate(10deg); } }
  @keyframes ear-flick{ 0%,92%{ transform:rotate(0deg); } 96%{ transform:rotate(-6deg); } 100%{ transform:rotate(0deg); } }
  @keyframes sparkle{ 0%{ opacity:0; transform:translate(0,0) scale(.6); }
                       40%{ opacity:.8; transform:translate(4px,-6px) scale(1); }
                       100%{ opacity:0; transform:translate(12px,-18px) scale(0); } }
  .nameTag{
    position:absolute; left:12px; top:10px; background:rgba(18,28,45,.72); padding:.18rem .65rem;
    font-size:.78rem; letter-spacing:.04em; border-radius:999px; backdrop-filter: blur(6px);
    box-shadow:0 6px 12px rgba(0,0,0,.35); text-transform:uppercase;
  }

  /* HUD */
  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between; padding:14px 24px;
    position:absolute; left:0; right:0; bottom:0; height:88px; z-index:3;
    background:linear-gradient(180deg, rgba(0,0,0,0) 0, rgba(5,14,18,.25) 32%, rgba(3,7,10,.55) 100%);
  }
  .status{
    font-weight:800; letter-spacing:.05em; text-shadow:0 6px 20px rgba(0,0,0,.6); font-size:1.25rem;
  }
  .status.countdown{ font-size:1.4rem; }
  .pill{ background:linear-gradient(135deg, #ffe775 0%, #ffbf24 65%, #ff8b24 100%);
    color:#1a1600; border-radius:999px; padding:.4rem .9rem; font-weight:800; box-shadow:0 8px 16px rgba(0,0,0,.35);
  }
  .legend{ display:flex; gap:14px; opacity:.92; font-size:.92rem; align-items:center; }
  .legend span{ display:inline-flex; gap:8px; align-items:center; background:rgba(9,14,24,.55);
    padding:.35rem .65rem; border-radius:999px; border:1px solid rgba(255,255,255,.08); }

  /* Betting Panel */
  .panel{
    background:linear-gradient(180deg,#181f33,#0f1423); border:1px solid rgba(255,255,255,.08);
    border-radius:22px; padding:22px; box-shadow:0 28px 50px rgba(0,0,0,.45);
  }
  .panel h2{ margin:.2rem 0 1.1rem; font-size:1.15rem; letter-spacing:.18em; opacity:.92; text-transform:uppercase; }
  .grid{ display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; }
  @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } }
  .field{ display:flex; gap:12px; align-items:center; }
  .field label{ width:96px; color:var(--muted); font-size:.9rem; text-transform:uppercase; letter-spacing:.08em; }
  input[type="text"], input[type="number"], select{
    width:100%; background:rgba(8,12,24,.85); color:var(--text); border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:.6rem .85rem; outline:none; box-shadow:inset 0 2px 8px rgba(0,0,0,.35);
  }
  .btn{
    appearance:none; border:0; border-radius:14px; padding:.85rem 1.1rem; cursor:pointer; font-weight:800;
    color:#121013; background:linear-gradient(135deg,#ffe775,#ffbf24 65%,#ff8b24);
    box-shadow:0 16px 28px rgba(0,0,0,.4); letter-spacing:.06em; text-transform:uppercase;
  }
  .btn.secondary{ background:linear-gradient(135deg,#2e3757,#1e263f); color:#e9eef6; border:1px solid rgba(255,255,255,.14) }
  .btn.muted{ opacity:.6; pointer-events:none }

  table{ width:100%; border-collapse:separate; border-spacing:0 10px; font-variant-numeric:tabular-nums; }
  th, td{ text-align:left; padding:.65rem .9rem; }
  th{ color:var(--muted); font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.08em; }
  tbody tr{ background:rgba(7,11,24,.85); border:1px solid rgba(255,255,255,.08); box-shadow:0 12px 18px rgba(0,0,0,.35); transition:transform .18s ease, box-shadow .18s ease; }
  tbody tr:hover{ transform:translateY(-2px); box-shadow:0 16px 28px rgba(0,0,0,.42); }
  tbody tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px }
  tbody tr td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px }
  .right{ text-align:right }
  .ok{ color:var(--win); font-weight:800 }
  .bad{ color:var(--lose); font-weight:800 }

  .note{ font-size:.9rem; color:var(--muted); margin-top:.5rem }
</style>
</head>
<body>
  <div class="wrap">
    <!-- TRACK -->
    <div class="track" id="track">
      <div class="lanes" id="lanes"></div>
      <div class="finish"></div>

      <header>
        <div class="status" id="status">Place your bets.</div>
        <div class="legend">
          <span><span class="pill" id="pot">$0</span> pot</span>
          <span>Min bet $1</span>
        </div>
      </header>
    </div>

    <!-- PANEL -->
    <div class="panel">
      <h2>Betting</h2>
      <div class="grid">
        <div class="field"><label for="bettor">Bettor</label><input id="bettor" type="text" placeholder="Name (optional)"></div>
        <div class="field"><label for="rat">Rat</label>
          <select id="rat"></select>
        </div>
        <div class="field"><label for="amount">Amount</label><input id="amount" type="number" min="1" step="1" value="10"></div>
      </div>
      <div style="display:flex; gap:8px; margin:.8rem 0 1rem">
        <button class="btn" id="addBet">Add Bet</button>
        <button class="btn secondary" id="closeBets">Close Bets & Start</button>
        <button class="btn secondary" id="reset">New Race</button>
      </div>

      <table>
        <thead><tr><th>Bettor</th><th>Rat</th><th class="right">Amount</th><th class="right">Remove</th></tr></thead>
        <tbody id="betRows"></tbody>
      </table>

      <div class="note">
        Payouts are pari-mutuel: winners split the pot in proportion to their bet. If nobody bet the winning rat, the house keeps the pot (ðŸ˜¼).
      </div>

      <h2 style="margin-top:1.2rem">Results</h2>
      <table>
        <thead><tr><th>Bettor</th><th>Rat</th><th class="right">Bet</th><th class="right">Payout</th><th class="right">Net</th></tr></thead>
        <tbody id="resultRows"><tr><td colspan="5" style="color:var(--muted)">No results yet.</td></tr></tbody>
      </table>
    </div>
  </div>

<script>
/* ============== Setup rats & lanes ============== */
const RAT_DATA = [
  { id:'r1', name:'Whisker', color:'#b9c2cc' },
  { id:'r2', name:'Nibble',  color:'#cdbfb2' },
  { id:'r3', name:'Shadow',  color:'#9aa6b2' },
  { id:'r4', name:'Cheddar', color:'#d8b04f' },
  { id:'r5', name:'Squeaks', color:'#c59ab2' },
];

const lanes = document.getElementById('lanes');
const statusEl = document.getElementById('status');
const potEl = document.getElementById('pot');
lanes.style.gridTemplateRows = `repeat(${RAT_DATA.length}, 1fr)`;

// build lanes + rats
const rats = RAT_DATA.map((r, idx) => {
  const lane = document.createElement('div');
  lane.className = 'lane';
  lane.dataset.rat = r.id;
  lanes.appendChild(lane);

  const rat = document.createElement('div');
  rat.className = 'rat';
  rat.innerHTML = ratSVG(r.color);
  lane.appendChild(rat);

  const tag = document.createElement('div');
  tag.className = 'nameTag';
  tag.textContent = r.name;
  lane.appendChild(tag);

  return { ...r, lane, el:rat, x:0, v:0 };
});

// selection dropdown
const sel = document.getElementById('rat');
for(const r of RAT_DATA){
  const o = document.createElement('option');
  o.value = r.id; o.textContent = r.name;
  sel.appendChild(o);
}

/* ============== Betting state ============== */
let bets = []; // {id, name, ratId, amount}
const betRows = document.getElementById('betRows');
const resultRows = document.getElementById('resultRows');

function fmt(n){ return '$'+Number(n).toLocaleString(undefined,{minimumFractionDigits:0}); }
function pot(){ return bets.reduce((a,b)=>a+Number(b.amount||0),0); }
function totalOn(rid){ return bets.filter(b=>b.ratId===rid).reduce((a,b)=>a+Number(b.amount),0); }

function redrawBets(){
  betRows.innerHTML = '';
  if(!bets.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" style="color:var(--muted)">No bets yet.</td>`;
    betRows.appendChild(tr);
  }else{
    for(const b of bets){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHTML(b.name||'â€”')}</td>
        <td>${ratName(b.ratId)}</td>
        <td class="right">${fmt(b.amount)}</td>
        <td class="right"><button class="btn secondary" data-remove="${b.id}" style="padding:.4rem .6rem">Ã—</button></td>`;
      betRows.appendChild(tr);
    }
  }
  potEl.textContent = fmt(pot());
}
function escapeHTML(s){ return (s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }
function ratName(id){ return RAT_DATA.find(r=>r.id===id)?.name || id; }

document.getElementById('addBet').addEventListener('click', ()=>{
  const name = document.getElementById('bettor').value.trim();
  const ratId = document.getElementById('rat').value;
  const amount = Math.max(1, Math.floor(Number(document.getElementById('amount').value||0)));
  bets.push({ id:crypto.randomUUID(), name, ratId, amount });
  redrawBets();
});
betRows.addEventListener('click', (e)=>{
  const id = e.target?.dataset?.remove;
  if(!id) return;
  bets = bets.filter(b=>b.id!==id);
  redrawBets();
});

/* ============== Race engine ============== */
let racing = false, finished = false, animId = 0, winner = null;

function resetRacePositions(){
  for(const r of rats){ r.x = 0; r.v = 0; r.el.style.left = '0px'; }
  winner = null; finished=false; racing=false;
}
resetRacePositions();

async function startCountdown(){
  statusEl.classList.add('countdown');
  for(const n of [3,2,1]){ statusEl.textContent = `Racing in ${n}â€¦`; await sleep(700); }
  statusEl.textContent = 'Go!';
  await sleep(200);
  statusEl.classList.remove('countdown');
}

function startRace(){
  const trackWidth = lanes.clientWidth - 26*2; // inner minus padding approx
  const finishX = trackWidth - 140; // where nose hits finish (rat width ~120)
  racing = true;

  // each rat gets base speed and personality jitter
  for(const r of rats){
    r.v = 2.4 + Math.random()*0.9; // base px/frame
    r.j = 0.25 + Math.random()*0.35; // jitter amplitude
  }
  const t0 = performance.now();
  const step = (t)=>{
    const dt = Math.min(32, t - (step.t||t)); step.t = t;
    for(const r of rats){
      if(finished) break;
      const wobble = Math.sin((t - t0)/ (140 + Math.random()*120)) * r.j;
      r.x += (r.v + wobble) * (dt/16.7);
      if(r.x >= finishX && !winner){
        winner = r; finished = true; racing=false;
      }
      r.el.style.transform = `translate(${Math.max(0, r.x)}px,-50%)`;
    }
    if(!finished){ animId = requestAnimationFrame(step); }
    else { cancelAnimationFrame(animId); endRace(); }
  };
  animId = requestAnimationFrame(step);
}

function endRace(){
  if(!winner){ statusEl.textContent = 'No winner?!'; return; }
  statusEl.textContent = `Winner: ${winner.name}!`;
  // payouts
  const p = pot();
  const totalOnWin = totalOn(winner.id);
  const winners = bets.filter(b=>b.ratId===winner.id);
  resultRows.innerHTML = '';
  if(!winners.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5">No one bet on ${winner.name}. House keeps the ${fmt(p)} pot.</td>`;
    resultRows.appendChild(tr);
    return;
  }
  for(const b of bets){
    const payout = b.ratId===winner.id ? (b.amount / totalOnWin) * p : 0;
    const net = payout - b.amount;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(b.name||'â€”')}</td>
      <td>${ratName(b.ratId)}</td>
      <td class="right">${fmt(b.amount)}</td>
      <td class="right ${payout? 'ok':''}">${payout? fmt(Math.round(payout)) : '$0'}</td>
      <td class="right ${net>0?'ok':(net<0?'bad':'')}">${net>0? '+'+fmt(Math.round(net)).slice(1): (net<0? '-'+fmt(Math.round(-net)).slice(1): '$0')}</td>
    `;
    resultRows.appendChild(tr);
  }
}

/* ============== Controls ============== */
document.getElementById('closeBets').addEventListener('click', async ()=>{
  if(!bets.length) { statusEl.textContent = 'Place at least one bet.'; return; }
  // Lock betting UI
  toggleBetUI(true);
  await startCountdown();
  startRace();
});

document.getElementById('reset').addEventListener('click', ()=>{
  bets = []; redrawBets();
  resultRows.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">No results yet.</td></tr>`;
  statusEl.textContent = 'Place your bets.';
  toggleBetUI(false);
  resetRacePositions();
});

function toggleBetUI(lock){
  document.getElementById('addBet').classList.toggle('muted', lock);
  document.getElementById('closeBets').classList.toggle('muted', lock);
  for(const el of [document.getElementById('bettor'), document.getElementById('rat'), document.getElementById('amount')]){
    el.disabled = lock;
  }
}

/* ============== Utilities & SVG ============== */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function ratSVG(color='#b9c2cc'){
  const darker = shade(color, -25);
  const highlight = shade(color, 22);
  const mid = shade(color, -8);
  const earInner = shade(color, 12);
  const sparkle = shade(color, 50);
  const gradId = `g${Math.random().toString(36).slice(2,8)}`;
  const headGradId = `h${Math.random().toString(36).slice(2,8)}`;
  return `
  <svg viewBox="0 0 240 130" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Racing rat">
    <defs>
      <linearGradient id="${gradId}" x1="40" y1="40" x2="210" y2="110" gradientUnits="userSpaceOnUse">
        <stop offset="0%" stop-color="${highlight}"/>
        <stop offset="40%" stop-color="${color}"/>
        <stop offset="100%" stop-color="${darker}"/>
      </linearGradient>
      <linearGradient id="${headGradId}" x1="120" y1="40" x2="220" y2="90" gradientUnits="userSpaceOnUse">
        <stop offset="0%" stop-color="${highlight}"/>
        <stop offset="60%" stop-color="${mid}"/>
        <stop offset="100%" stop-color="${darker}"/>
      </linearGradient>
      <filter id="ratShadow" x="-60%" y="-60%" width="220%" height="220%">
        <feDropShadow dx="0" dy="12" stdDeviation="10" flood-color="rgba(0,0,0,.45)" flood-opacity="1"/>
      </filter>
    </defs>
    <g filter="url(#ratShadow)">
      <path class="tail" d="M18 90 C 55 118, 110 118, 148 98" fill="none" stroke="#d89c86" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
      <g class="body-group">
        <path d="M70 64 C 60 40, 86 18, 138 22 C 188 26, 214 56, 208 86 C 202 114, 142 120, 106 108 C 78 98, 72 84, 70 64 Z" fill="url(#${gradId})"/>
        <ellipse cx="188" cy="66" rx="36" ry="30" fill="url(#${headGradId})"/>
        <ellipse cx="202" cy="46" rx="16" ry="14" fill="${earInner}" class="ear"/>
        <ellipse cx="205" cy="44" rx="8" ry="7" fill="${shade(color,-12)}" opacity=".75" class="ear"/>
        <path d="M174 70 q18 -12 36 0" fill="#f8c2b5" opacity=".25"/>
        <circle cx="206" cy="72" r="4.2" fill="#1a2033"/>
        <circle cx="207.6" cy="70.9" r="1.4" fill="#fff" opacity=".8"/>
        <path d="M224 75 q10 5 0 12" stroke="#f4a698" stroke-width="4" stroke-linecap="round"/>
        <path d="M198 86 q10 4 24 0" stroke="#f4a698" stroke-width="5" stroke-linecap="round"/>
        <path d="M128 104 q16 12 36 0" stroke="#f4a698" stroke-width="6" stroke-linecap="round"/>
        <path d="M156 112 q18 8 34 -4" stroke="#f4a698" stroke-width="6" stroke-linecap="round"/>
        <path d="M176 76 l-18 8" stroke="#f4a698" stroke-width="2.4" stroke-linecap="round"/>
        <path d="M176 82 l-18 8" stroke="#f4a698" stroke-width="2.4" stroke-linecap="round"/>
        <path d="M176 88 l-18 8" stroke="#f4a698" stroke-width="2.4" stroke-linecap="round"/>
        <path d="M168 62 C 150 60, 146 46, 150 34" stroke="${shade(color,-35)}" stroke-width="5" stroke-linecap="round" opacity=".28"/>
        <circle cx="216" cy="74" r="4.4" fill="#f7a9a0"/>
        <circle cx="217.2" cy="72.8" r="1.6" fill="#fff" opacity=".8"/>
        <circle class="sparkle" cx="118" cy="44" r="3" fill="${sparkle}" opacity=".4"/>
        <circle class="sparkle" cx="138" cy="38" r="2" fill="#fff" opacity=".6"/>
      </g>
    </g>
  </svg>`;
}
function shade(hex, amt){
  // naive lighten/darken hex by amt (-100..100)
  let c = hex.replace('#','');
  if(c.length===3) c = c.split('').map(ch=>ch+ch).join('');
  let [r,g,b]=[0,2,4].map(i=>parseInt(c.substring(i,i+2),16));
  const adj = v => Math.max(0,Math.min(255, Math.round(v + (amt/100)*255)));
  r=adj(r); g=adj(g); b=adj(b);
  return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
}

/* initial draw */
redrawBets();
</script>
</body>
</html>
