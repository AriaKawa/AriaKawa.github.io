<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blackjack — Aria & Friends Hub</title>
<style>
  :root{
    --felt:#0e4d37;            /* table background */
    --felt-dark:#0a3a2a;
    --line:#154f40;
    --card:#fff;
    --shadow:0 14px 30px rgba(0,0,0,.35);
    --accent:#ffd13b;          /* primary button */
    --accent-2:#161a24;        /* secondary button */
    --text:#e9f1ee;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    color:var(--text); background:#0b1020; display:grid; place-items:center;
  }
  .table{
    position:relative; width:min(1100px, 96vw); aspect-ratio: 16/9;
    background: radial-gradient(120% 90% at 50% -15%, #208b6e 0, var(--felt) 32%, var(--felt-dark) 95%);
    border-radius:28px; box-shadow: var(--shadow);
    overflow:hidden; border:6px solid #0c3024;
  }
  .table::after{
    content:""; position:absolute; inset:20px;
    border:2px dashed rgba(255,255,255,.15); border-radius:22px; pointer-events:none;
  }
  header{
    position:absolute; top:14px; left:18px; right:18px; display:flex; align-items:center; gap:.75rem;
    z-index:3;
  }
  .brand{font-weight:800; letter-spacing:.08em; opacity:.9}
  .spacer{flex:1}
  .chip{
    font-variant-numeric:tabular-nums;
    background:linear-gradient(#ffe07a, #e3b312);
    color:#2a2100; font-weight:800; padding:.45rem .7rem; border-radius:999px; box-shadow: var(--shadow);
  }

  /* Lanes */
  .lane{ position:absolute; left:50%; transform:translateX(-50%); width:80%; }
  .dealer.lane{ top:10%; }
  .player.lane{ bottom:12%; }

  /* Card */
  .card{
    width:96px; height:136px; border-radius:12px; background:var(--card);
    box-shadow: var(--shadow); position:absolute; transition: transform .4s ease, top .4s ease, left .4s ease, opacity .3s ease;
    display:grid; place-items:center; overflow:hidden;
  }
  @media (max-width:720px){
    .card{ width:78px; height:112px; border-radius:10px; }
  }
  .card .svg{ width:94%; height:94%; }
  .back{
    background:repeating-linear-gradient(45deg, #1d2740, #1d2740 10px, #2b3a66 10px, #2b3a66 20px);
    border:3px solid #e5e9f6; position:absolute; inset:0; border-radius:12px;
  }

  /* Spots where cards settle */
  .spot{ position:relative; height:150px; }
  @media (max-width:720px){ .spot{ height:120px; } }

  /* Labels */
  .label{
    position:absolute; left:50%; transform:translateX(-50%);
    text-align:center; text-shadow:0 2px 8px rgba(0,0,0,.5);
  }
  .label.dealer{ top:4%; font-weight:700; opacity:.9 }
  .label.player{ bottom:6%; font-weight:700; opacity:.95 }
  .total{ font-size:1.05rem; opacity:.9 }

  /* Controls */
  .controls{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:3%; display:flex; gap:.6rem; z-index:3; flex-wrap:wrap; justify-content:center;
  }
  button{
    appearance:none; border:0; border-radius:14px; padding:.9rem 1.2rem;
    font-weight:800; box-shadow: var(--shadow); cursor:pointer; transition: transform .05s ease, filter .2s ease, opacity .2s ease;
  }
  button:active{ transform:translateY(1px) scale(.99) }
  .primary{ background:var(--accent); color:#1a1400 }
  .ghost{ background:var(--accent-2); color:#e9ecf5; border:1px solid rgba(255,255,255,.1) }
  .muted{ opacity:.6; pointer-events:none }

  /* Toast / status */
  .status{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    font-size:1.6rem; font-weight:800; letter-spacing:.02em; text-align:center;
    text-shadow:0 3px 30px rgba(0,0,0,.55); opacity:0; transition:opacity .2s ease;
    pointer-events:none; max-width:80%;
  }
  .status.show{ opacity:1 }

  /* Exit link */
  .back-link{
    position:absolute; top:16px; right:20px; z-index:4; display:inline-flex; align-items:center;
    gap:.4rem; font-size:.95rem; text-decoration:none; font-weight:600; color:var(--text);
    background:rgba(0,0,0,.35); padding:.45rem .8rem; border-radius:999px; transition:background .2s ease, transform .2s ease;
  }
  .back-link:hover{ background:rgba(0,0,0,.55); transform:translateY(-1px); }
</style>
</head>
<body>
  <a class="back-link" href="index.html">← Back to the friend hub</a>
  <div class="table" id="table">
    <header>
      <div class="brand">BLACKJACK • FRIENDS LOUNGE</div>
      <div class="spacer"></div>
      <div class="chip">Bank: <span id="bank">1000</span></div>
    </header>

    <div class="label dealer">Dealer • <span class="total" id="dealerTotal">0</span></div>
    <div class="lane dealer">
      <div class="spot" id="dealerSpot"></div>
    </div>

    <div class="label player">You • <span class="total" id="playerTotal">0</span></div>
    <div class="lane player">
      <div class="spot" id="playerSpot"></div>
    </div>

    <div class="status" id="status"></div>

    <div class="controls" id="controls">
      <button class="primary" id="btnDeal">Deal</button>
      <button class="primary muted" id="btnHit">Hit</button>
      <button class="ghost muted" id="btnStand">Stand</button>
      <button class="ghost" id="btnNew">New Shoe</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
  import { getDatabase, ref, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  /* ---------- Card + Deck ---------- */
  const SUITS = ["♠","♥","♦","♣"];      // Spade, Heart, Diamond, Club
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

  function buildShoe(decks=6){
    const shoe=[];
    for(let d=0; d<decks; d++){
      for(const s of SUITS){
        for(const r of RANKS){
          shoe.push({suit:s, rank:r});
        }
      }
    }
    for(let i=shoe.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [shoe[i], shoe[j]]=[shoe[j], shoe[i]];
    }
    return shoe;
  }

  /* ---------- Values ---------- */
  function cardValue(card){
    if(!card) return 0;
    if(card.rank==="A") return 11;
    if(["K","Q","J"].includes(card.rank)) return 10;
    return parseInt(card.rank,10);
  }
  function handValue(cards){
    let sum = 0, aces = 0;
    for(const c of cards){
      sum += cardValue(c);
      if(c.rank==="A") aces++;
    }
    while(sum>21 && aces>0){ sum -= 10; aces--; }
    return sum;
  }

  /* ---------- SVG Renderer ---------- */
  function suitColor(s){ return (s==="♥"||s==="♦") ? "#d64545" : "#1f2a44"; }
  function renderSVG(card){
    const s = suitColor(card.suit);
    const rank = card.rank;
    return `
    <svg class="svg" viewBox="0 0 250 350" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${rank} ${card.suit}">
      <defs>
        <filter id="innerShadow" x="-50%" y="-50%" width="200%" height="200%">
          <feOffset dx="0" dy="2" />
          <feGaussianBlur stdDeviation="2" result="offblur"/>
          <feComposite in="SourceGraphic" in2="offblur" operator="arithmetic" k2="-1" k3="1"/>
        </filter>
      </defs>
      <rect x="4" y="4" rx="22" ry="22" width="242" height="342" fill="#ffffff" filter="url(#innerShadow)"/>
      <rect x="8" y="8" rx="18" ry="18" width="234" height="334" fill="#ffffff"/>
      <g fill="${s}">
        <text x="22" y="40" font-size="44" font-family="ui-monospace, Menlo, Consolas, monospace">${rank}</text>
        <text x="22" y="76" font-size="44">${card.suit}</text>
        <text x="228" y="340" font-size="44" text-anchor="end" transform="rotate(180,228,340)">${rank}</text>
        <text x="228" y="304" font-size="44" text-anchor="end" transform="rotate(180,228,304)">${card.suit}</text>
        <text x="125" y="205" font-size="120" text-anchor="middle" dominant-baseline="middle" opacity=".9">${card.suit}</text>
      </g>
    </svg>`;
  }

  /* ---------- DOM helpers ---------- */
  const dealerSpot = document.getElementById('dealerSpot');
  const playerSpot = document.getElementById('playerSpot');
  const dealerTotal = document.getElementById('dealerTotal');
  const playerTotal = document.getElementById('playerTotal');
  const statusEl = document.getElementById('status');
  const btnDeal = document.getElementById('btnDeal');
  const btnHit = document.getElementById('btnHit');
  const btnStand = document.getElementById('btnStand');
  const btnNew = document.getElementById('btnNew');
  const bankEl = document.getElementById('bank');

  function setButtons(state){
    const on = (el, ok)=> el.classList.toggle('muted', !ok);
    switch(state){
      case 'deal': on(btnDeal,true); on(btnHit,false); on(btnStand,false); break;
      case 'player': on(btnDeal,false); on(btnHit,true); on(btnStand,true); break;
      default: on(btnDeal,false); on(btnHit,false); on(btnStand,false); break;
    }
  }

  let transientStatus = null;
  function showStatus(msg, ms=1100){
    transientStatus = { message: msg, until: Date.now() + ms };
    statusEl.textContent = msg;
    statusEl.classList.add('show');
    setTimeout(()=>{
      if(transientStatus && Date.now() >= transientStatus.until){
        transientStatus = null;
        statusEl.classList.remove('show');
        renderTable();
      }
    }, ms);
  }

  function normalizeCards(list){
    if(Array.isArray(list)){
      return list.filter(Boolean).map(card=>({suit:card.suit, rank:card.rank}));
    }
    if(!list || typeof list !== 'object') return [];
    return Object.keys(list)
      .map(Number)
      .sort((a,b)=>a-b)
      .map(key=>list[key])
      .filter(Boolean)
      .map(card=>({suit:card.suit, rank:card.rank}));
  }

  function renderHand(hand, spot, {hideHole=false}={}){
    spot.innerHTML='';
    hand.forEach((card, idx)=>{
      const el = document.createElement('div');
      el.className='card';
      const faceDown = hideHole && idx===1;
      el.innerHTML = faceDown ? '<div class="back"></div>' : renderSVG(card);
      el.style.left = `${20 + idx*28}px`;
      el.style.top = `${6 + idx*2}px`;
      el.style.transform = `translate(0,0) rotate(${[-3,-1,1,3][idx%4]}deg)`;
      spot.appendChild(el);
    });
  }

  /* ---------- Firebase ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyDRniZatGeylxphjHQadYjucOcirNBRIdk",
    authDomain: "multiplayer-640ec.firebaseapp.com",
    databaseURL: "https://multiplayer-640ec-default-rtdb.firebaseio.com",
    projectId: "multiplayer-640ec",
    storageBucket: "multiplayer-640ec.firebasestorage.app",
    messagingSenderId: "94914236381",
    appId: "1:94914236381:web:55ab00cc690140180cf034",
    measurementId: "G-V43J1S8RGF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const roomId = window.location.hash.replace('#','') || 'default';
  const tablePath = `tables/${roomId}`;
  const rootRef = ref(db);
  const shoeRef = ref(db, `${tablePath}/shoe`);
  const dealerRef = ref(db, `${tablePath}/dealer`);
  const playersRef = ref(db, `${tablePath}/players`);
  const stateRef = ref(db, `${tablePath}/state`);

  const clientId = (crypto && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
  const playerName = `Player ${clientId.slice(0,4).toUpperCase()}`;
  const presenceRef = ref(db, `${tablePath}/players/${clientId}`);

  const defaultState = {
    phase: 'waiting',
    activePlayer: null,
    hideDealerHole: false,
    banks: {},
    status: '',
    statusUntil: 0
  };

  const tableState = {
    shoe: [],
    dealer: [],
    players: {},
    state: { ...defaultState }
  };

  function cloneCards(cards){
    return (cards || []).map(card=>({suit:card.suit, rank:card.rank}));
  }

  function commitRound({includeDealer=true, includePlayer=true, includeShoe=true}={}){
    const now = Date.now();
    const updates = {};
    if(includeShoe){
      updates[`${tablePath}/shoe`] = {
        cards: cloneCards(tableState.shoe),
        updatedBy: clientId,
        updatedAt: now
      };
    }
    if(includeDealer){
      updates[`${tablePath}/dealer`] = {
        hand: cloneCards(tableState.dealer),
        updatedBy: clientId,
        updatedAt: now
      };
    }
    if(includePlayer && tableState.players[clientId]){
      updates[`${tablePath}/players/${clientId}`] = {
        ...tableState.players[clientId],
        hand: cloneCards(tableState.players[clientId].hand),
        updatedBy: clientId,
        updatedAt: now
      };
    }
    updates[`${tablePath}/state`] = {
      ...tableState.state,
      updatedBy: clientId,
      updatedAt: now
    };
    return update(rootRef, updates);
  }

  function ensureShoe(){
    if(!Array.isArray(tableState.shoe) || tableState.shoe.length === 0){
      tableState.shoe = buildShoe(6);
      return;
    }
    if(tableState.shoe.length < 40){
      showStatus('Shuffling…', 800);
      tableState.shoe = buildShoe(6);
    }
  }

  function drawFromShoe(){
    ensureShoe();
    const shoe = tableState.shoe;
    const card = shoe.pop();
    tableState.shoe = shoe;
    return card;
  }

  function getPlayerEntry(){
    if(!tableState.players[clientId]){
      tableState.players[clientId] = {
        name: playerName,
        bank: tableState.state.banks?.[clientId] ?? 1000,
        hand: [],
        status: 'online'
      };
    }
    if(!tableState.state.banks){
      tableState.state.banks = {};
    }
    if(typeof tableState.state.banks[clientId] !== 'number'){
      tableState.state.banks[clientId] = tableState.players[clientId].bank ?? 1000;
    }
    return tableState.players[clientId];
  }

  function isMyTurn(){
    const { phase, activePlayer } = tableState.state;
    if(phase === 'waiting') return true;
    if(activePlayer && activePlayer !== clientId) return false;
    return true;
  }

  function renderTable(){
    const state = tableState.state || defaultState;
    const me = tableState.players[clientId] || { hand: [], bank: 1000, name: playerName };
    const dealerHand = Array.isArray(tableState.dealer) ? tableState.dealer : [];
    const playerHand = Array.isArray(me.hand) ? me.hand : [];

    renderHand(dealerHand, dealerSpot, { hideHole: !!state.hideDealerHole });
    renderHand(playerHand, playerSpot);

    dealerTotal.textContent = state.hideDealerHole && dealerHand.length
      ? `${cardValue(dealerHand[0])} +`
      : handValue(dealerHand);
    playerTotal.textContent = handValue(playerHand);

    const bankValue = typeof state.banks?.[clientId] === 'number'
      ? state.banks[clientId]
      : (typeof me.bank === 'number' ? me.bank : 1000);
    bankEl.textContent = bankValue;

    if(transientStatus && Date.now() < transientStatus.until){
      statusEl.textContent = transientStatus.message;
      statusEl.classList.add('show');
    }else if(state.status){
      const visible = !state.statusUntil || state.statusUntil > Date.now();
      statusEl.textContent = state.status;
      statusEl.classList.toggle('show', visible);
    }else{
      statusEl.classList.remove('show');
    }

    if(state.phase === 'waiting'){
      setButtons('deal');
    }else if(state.phase === 'player' && state.activePlayer === clientId){
      setButtons('player');
    }else{
      setButtons('lock');
    }
  }

  function shareStatus(msg, duration=1400){
    tableState.state.status = msg;
    tableState.state.statusUntil = Date.now() + duration;
  }

  function handleBlackjack(playerHand, dealerHand){
    const pv = handValue(playerHand);
    const dv = handValue(dealerHand);
    if(pv !== 21) return false;
    const me = getPlayerEntry();
    let bank = tableState.state.banks[clientId] ?? me.bank ?? 1000;
    if(dv === 21){
      shareStatus('Push — both Blackjack', 1500);
    }else{
      bank += 150;
      shareStatus('Blackjack! +150', 1500);
    }
    tableState.state.phase = 'waiting';
    tableState.state.activePlayer = null;
    tableState.state.hideDealerHole = false;
    tableState.state.banks[clientId] = bank;
    me.bank = bank;
    return true;
  }

  function resolveRound(){
    const me = getPlayerEntry();
    const playerHand = me.hand || [];
    const dealerHand = tableState.dealer || [];
    const pv = handValue(playerHand);
    const dv = handValue(dealerHand);
    let bank = tableState.state.banks[clientId] ?? me.bank ?? 1000;
    let msg = '';
    if(dv>21){ bank += 100; msg = 'Dealer busts — You win +100'; }
    else if(pv>dv){ bank += 100; msg = 'You win +100'; }
    else if(pv<dv){ bank -= 100; msg = 'You lose -100'; }
    else { msg = 'Push'; }
    tableState.state.phase = 'waiting';
    tableState.state.activePlayer = null;
    tableState.state.hideDealerHole = false;
    tableState.state.banks[clientId] = bank;
    me.bank = bank;
    shareStatus(msg, 1500);
    commitRound();
    renderTable();
  }

  function dealerPlay(){
    const draw = ()=>{
      const dealerHand = tableState.dealer || [];
      const dv = handValue(dealerHand);
      const hasAce = dealerHand.some(c=>c.rank === 'A');
      const shouldHit = dv < 17 || (dv === 17 && hasAce && handValue(dealerHand) === 17);
      if(shouldHit){
        setTimeout(()=>{
          tableState.dealer = [...dealerHand, drawFromShoe()];
          commitRound();
          renderTable();
          draw();
        }, 420);
      }else{
        resolveRound();
      }
    };
    draw();
  }

  function startDeal(){
    if(tableState.state.phase !== 'waiting' || !isMyTurn()) return;
    const me = getPlayerEntry();
    me.hand = [];
    tableState.dealer = [];

    ensureShoe();
    tableState.dealer = [drawFromShoe(), drawFromShoe()];
    me.hand = [drawFromShoe(), drawFromShoe()];

    tableState.state.phase = 'player';
    tableState.state.activePlayer = clientId;
    tableState.state.hideDealerHole = true;
    tableState.state.status = '';
    tableState.state.statusUntil = 0;

    if(handleBlackjack(me.hand, tableState.dealer)){
      commitRound();
      renderTable();
      return;
    }

    commitRound();
    renderTable();
  }

  function playerHit(){
    if(tableState.state.phase !== 'player' || tableState.state.activePlayer !== clientId) return;
    const me = getPlayerEntry();
    me.hand = [...(me.hand||[]), drawFromShoe()];
    tableState.state.status = '';
    tableState.state.statusUntil = 0;

    const total = handValue(me.hand);
    if(total > 21){
      let bank = tableState.state.banks[clientId] ?? me.bank ?? 1000;
      bank -= 100;
      tableState.state.banks[clientId] = bank;
      me.bank = bank;
      tableState.state.phase = 'waiting';
      tableState.state.activePlayer = null;
      tableState.state.hideDealerHole = false;
      shareStatus('Bust!', 1500);
    }
    commitRound();
    renderTable();
  }

  function playerStand(){
    if(tableState.state.phase !== 'player' || tableState.state.activePlayer !== clientId) return;
    tableState.state.phase = 'dealer';
    tableState.state.hideDealerHole = false;
    tableState.state.status = '';
    tableState.state.statusUntil = 0;
    commitRound();
    renderTable();
    dealerPlay();
  }

  function newShoe(){
    tableState.shoe = buildShoe(6);
    shareStatus('New shoe ready', 700);
    commitRound({ includeDealer:false, includePlayer:false, includeShoe:true });
    renderTable();
  }

  let knownPlayers = new Set();

  onValue(shoeRef, snapshot=>{
    const data = snapshot.val();
    if(data && data.updatedBy === clientId) return;
    if(data && data.cards){
      tableState.shoe = normalizeCards(data.cards);
    }
    renderTable();
  });

  onValue(dealerRef, snapshot=>{
    const data = snapshot.val();
    if(data && data.updatedBy === clientId) return;
    tableState.dealer = normalizeCards(data?.hand);
    renderTable();
  });

  onValue(playersRef, snapshot=>{
    const data = snapshot.val() || {};
    const previousPlayers = { ...tableState.players };
    const currentIds = new Set(Object.keys(data));
    for(const id of currentIds){
      if(!knownPlayers.has(id) && id !== clientId){
        showStatus(`${data[id]?.name || 'Player'} joined`, 1000);
      }
    }
    for(const id of knownPlayers){
      if(!currentIds.has(id) && id !== clientId){
        const name = previousPlayers[id]?.name || 'Player';
        showStatus(`${name} left`, 1000);
      }
    }
    knownPlayers = currentIds;
    const parsed = {};
    for(const [id, info] of Object.entries(data)){
      parsed[id] = {
        ...info,
        hand: normalizeCards(info.hand)
      };
    }
    tableState.players = parsed;
    renderTable();
  });

  onValue(stateRef, snapshot=>{
    const data = snapshot.val();
    if(data && data.updatedBy === clientId) return;
    tableState.state = { ...defaultState, ...(data || {}) };
    if(!tableState.state.banks) tableState.state.banks = {};
    renderTable();
  });

  function joinTable(){
    const me = getPlayerEntry();
    const now = Date.now();
    const updates = {};
    updates[`${tablePath}/players/${clientId}`] = {
      ...me,
      hand: cloneCards(me.hand),
      updatedBy: clientId,
      updatedAt: now
    };
    if(!tableState.state.banks){
      tableState.state.banks = {};
    }
    tableState.state.banks[clientId] = me.bank ?? 1000;
    updates[`${tablePath}/state/banks/${clientId}`] = tableState.state.banks[clientId];
    updates[`${tablePath}/state/updatedBy`] = clientId;
    updates[`${tablePath}/state/updatedAt`] = now;
    update(rootRef, updates).catch(err=>console.warn('Failed to join table', err));
    onDisconnect(presenceRef).remove().catch(()=>{});
  }

  btnDeal.addEventListener('click', ()=> startDeal());
  btnHit.addEventListener('click', ()=> !btnHit.classList.contains('muted') && playerHit());
  btnStand.addEventListener('click', ()=> !btnStand.classList.contains('muted') && playerStand());
  btnNew.addEventListener('click', ()=> newShoe());

  setButtons('deal');
  renderTable();
  joinTable();

  isSupported()
    .then((supported) => {
      if (supported) {
        getAnalytics(app);
      }
    })
    .catch((err) => console.warn('Firebase analytics not supported', err));
</script>
</body>
</html>
