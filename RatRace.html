<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rat Race — ARIA ARCADE</title>
<style>
  :root{
    --bg:#0b1020;        /* site navy */
    --felt:#9b6a3c;      /* dirt track */
    --felt-dark:#6b4728;
    --lane:#b98751;
    --line:rgba(255,244,222,.25);
    --card:#151a29;
    --text:#e8eef6;
    --muted:#a9b4c7;
    --accent:#ffd13b;
    --accent2:#2b3350;
    --win:#63d471;
    --lose:#ef476f;
    --shadow:0 14px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at 20% 20%, rgba(53,104,214,.25) 0 24%, transparent 60%),
      radial-gradient(circle at 80% 10%, rgba(255,209,59,.15) 0 28%, transparent 62%),
      linear-gradient(160deg, #05060d 0%, #090f1f 60%, #0c1228 100%);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    min-height:100dvh; padding:24px clamp(18px,3vw,64px);
  }
  .back-nav{
    position:fixed; top:20px; right:22px; z-index:20;
  }
  .back-nav__button{
    appearance:none; border:1px solid rgba(232,238,246,.35);
    background:linear-gradient(135deg, rgba(18,26,45,.82), rgba(9,14,28,.92));
    color:var(--text); border-radius:999px; display:inline-flex; align-items:center; gap:.45rem;
    padding:.55rem 1.15rem; font-weight:700; letter-spacing:.05em; cursor:pointer;
    box-shadow:0 20px 36px rgba(0,0,0,.4); transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .back-nav__button:hover,
  .back-nav__button:focus-visible{
    transform:translateY(-1px);
    border-color:rgba(255,209,59,.6);
    box-shadow:0 26px 44px rgba(0,0,0,.48);
    outline:none;
  }
  .back-nav__icon{font-size:1.05rem; line-height:1;}
  .wrap{
    width:100%;
    padding:0;
    padding-inline:clamp(12px, 2.5vw, 56px);
  }
  .board{
    width:100%;
    margin:0 auto;
    background:linear-gradient(145deg, rgba(30,39,66,.92), rgba(9,14,26,.88));
    border:1px solid rgba(255,255,255,.05);
    border-radius:34px;
    box-shadow:0 32px 60px rgba(0,0,0,.48);
    display:grid;
    gap:clamp(20px, 2.5vw, 36px);
    grid-template-columns:minmax(0,1fr);
    grid-auto-rows:minmax(0,auto);
    align-items:stretch;
    grid-template-areas:
      "track"
      "info"
      "bets";
    padding:clamp(26px, 2.8vw, 42px);
  }
  @media (max-width:720px){
    .board{ padding:22px; border-radius:26px; gap:20px; }
  }

  .board[data-view="betting"]{
    grid-template-columns:minmax(0,1fr) minmax(0,1fr);
    grid-template-areas:
      "track track"
      "info bets";
  }

  .board[data-view="betting"] .track-card{
    grid-column:1/-1;
  }

  .board[data-view="race"]{
    grid-template-areas:
      "track";
    grid-template-rows:minmax(560px,1fr);
  }

  .board[data-view="race"] .info-panel,
  .board[data-view="race"] .bets-panel{
    display:none;
  }

  .board[data-view="betting"] .track-viewport{
    display:none;
  }

  .board[data-view="betting"] .track-card{
    min-height:0;
    background:none;
    border:none;
    box-shadow:none;
    position:relative;
  }

  .board[data-view="betting"] .track-card::after{
    display:none;
  }

  .board[data-view="betting"] .track-card header{
    position:relative;
    left:auto;
    right:auto;
    bottom:auto;
    background:linear-gradient(180deg, rgba(16,22,38,.92) 0%, rgba(10,16,28,.96) 100%);
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 18px 36px rgba(0,0,0,.35);
  }
  @media (min-width:1100px){
    .board{
      grid-template-columns:minmax(0,1.85fr) minmax(340px,1fr);
      grid-template-areas:
        "track info"
        "track bets";
      max-height:calc(100dvh - clamp(90px,10vh,160px));
    }
    .board[data-view="betting"]{
      grid-template-columns:minmax(0,1.1fr) minmax(340px,1fr);
      grid-template-areas:
        "track track"
        "info bets";
    }
    .board[data-view="betting"] .track-card{
      grid-column:1/-1;
    }
  }

  @media (min-width:1500px){
    .board{
      grid-template-columns:minmax(0,2fr) minmax(360px,1fr) minmax(360px,1fr);
      grid-template-areas:"track bets info";
    }
    .board[data-view="betting"]{
      grid-template-columns:minmax(0,1.25fr) minmax(400px,1fr);
    }
  }

  /* Track */
  .track-card{
    grid-area:track;
    position:relative;
    border-radius:26px;
    border:1px solid rgba(255,255,255,.06);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
    overflow:hidden;
    align-self:start;
    background:
      radial-gradient(160% 140% at 50% -30%, rgba(255,232,189,.18) 0%, rgba(141,86,40,.38) 55%, rgba(63,36,15,.88) 100%),
      linear-gradient(180deg, #b67a46 0%, #7f4f2c 82%);
  }
  .track-card::after{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background:linear-gradient(180deg, rgba(0,0,0,.45) 0%, rgba(0,0,0,0) 35%, rgba(0,0,0,.55) 100%);
    z-index:1;
  }
  .track-viewport{
    position:relative;
    width:100%;
    aspect-ratio:1200/720;
    filter:drop-shadow(0 22px 42px rgba(0,0,0,.45));
    z-index:0;
    overflow:hidden;
  }
  .race-camera{
    position:absolute;
    top:0;
    left:0;
    width:var(--track-length, 2400px);
    height:100%;
    will-change:transform;
  }
  .race-stage{
    position:absolute;
    top:0;
    left:0;
    width:var(--track-length, 2400px);
    height:100%;
    display:flex;
    align-items:flex-end;
    overflow:visible;
  }
  .race-stage__sky,
  .race-stage__far,
  .race-stage__mid,
  .race-stage__ground{
    position:absolute;
    inset:0;
    will-change:transform;
  }
  .race-stage__sky{
    background:linear-gradient(180deg, rgba(64,92,168,.85) 0%, rgba(18,26,45,.92) 65%, rgba(14,19,32,1) 100%);
    z-index:0;
  }
  .race-stage__far{
    background:linear-gradient(180deg, rgba(45,68,128,.6) 0%, rgba(26,37,72,.6) 55%, transparent 100%);
    mask:linear-gradient(90deg, transparent 0 40px, black 80px calc(100% - 80px), transparent 100%);
    z-index:1;
    opacity:.6;
  }
  .race-stage__mid{
    background:
      linear-gradient(180deg, rgba(22,34,64,.7) 0%, rgba(18,26,45,0) 70%),
      repeating-linear-gradient(90deg, rgba(42,62,112,.45) 0 120px, rgba(30,44,82,.35) 120px 240px);
    z-index:2;
    opacity:.75;
  }
  .race-stage__ground{
    position:absolute;
    inset:auto 0 0;
    height:52%;
    background:
      linear-gradient(180deg, rgba(92,62,34,.92) 0%, rgba(74,45,22,.96) 35%, rgba(42,24,12,1) 100%);
    border-top:1px solid rgba(255,244,222,.25);
    z-index:3;
    overflow:hidden;
  }
  .race-stage__lane-lines{
    position:absolute;
    inset:0;
    background:repeating-linear-gradient(
      to bottom,
      transparent 0 calc(var(--lane-spacing, 90px) - 2px),
      rgba(255,244,222,.25) calc(var(--lane-spacing, 90px) - 2px) var(--lane-spacing, 90px)
    );
    opacity:.65;
  }
  .race-stage__finish{
    position:absolute;
    bottom:0;
    left:var(--finish-x, 2000px);
    width:80px;
    height:100%;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    background:
      repeating-linear-gradient(
        135deg,
        rgba(255,255,255,.85) 0 16px,
        rgba(0,0,0,.8) 16px 32px
      );
    border-radius:18px 18px 0 0;
    box-shadow:0 18px 36px rgba(0,0,0,.45);
    padding-bottom:18px;
    transform:translateX(-50%);
  }
  .race-stage__finish span{
    display:block;
    font-weight:800;
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:.75rem;
    color:#0c101c;
    writing-mode:vertical-rl;
    text-shadow:0 2px 6px rgba(0,0,0,.45);
  }
  .race-overlay{
    position:absolute;
    inset:0;
    display:grid;
    place-items:center;
    pointer-events:none;
    z-index:6;
  }
  .race-countdown{
    font-size:clamp(2.4rem, 6vw, 4.5rem);
    font-weight:900;
    letter-spacing:.2em;
    text-transform:uppercase;
    background:rgba(12,18,32,.65);
    border:1px solid rgba(255,255,255,.18);
    padding:1.2rem 2.4rem;
    border-radius:20px;
    backdrop-filter:blur(6px);
    box-shadow:0 28px 60px rgba(0,0,0,.45);
  }
  .track-card header{
    position:absolute;
    left:24px;
    right:24px;
    bottom:24px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    padding:16px 20px;
    border-radius:20px;
    background:linear-gradient(180deg, rgba(9,14,24,.72) 0%, rgba(6,10,18,.92) 100%);
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 18px 36px rgba(0,0,0,.45);
    z-index:5;
  }
  .status{
    font-weight:800;
    letter-spacing:.05em;
    text-shadow:0 6px 20px rgba(0,0,0,.6);
    font-size:1.3rem;
  }
  .status.countdown{ font-size:1.45rem; }
  .pill{
    background:linear-gradient(135deg, #ffe775 0%, #ffbf24 65%, #ff8b24 100%);
    color:#1a1600;
    border-radius:999px;
    padding:.4rem .9rem;
    font-weight:800;
    box-shadow:0 8px 16px rgba(0,0,0,.35);
  }
  .legend{ display:flex; gap:14px; opacity:.92; font-size:.92rem; align-items:center; }
  .legend span{ display:inline-flex; gap:8px; align-items:center; background:rgba(9,14,24,.55);
    padding:.35rem .65rem; border-radius:999px; border:1px solid rgba(255,255,255,.08); }
  .trackHeaderAside{ display:flex; flex-direction:column; align-items:flex-end; gap:10px; margin-left:auto; }
  .trackOdds{ display:flex; flex-wrap:wrap; justify-content:flex-end; gap:8px; max-width:clamp(220px, 40vw, 520px); }
  .trackOdds[hidden]{ display:none !important; }
  .trackOdds__item{ display:inline-flex; align-items:center; gap:8px; padding:.4rem .7rem; border-radius:999px; border:1px solid rgba(255,255,255,.12);
    background:rgba(9,14,26,.62); font-size:.85rem; line-height:1.1; box-shadow:0 12px 24px rgba(0,0,0,.32); transition:background .2s ease, border-color .2s ease, box-shadow .2s ease; }
  .trackOdds__item.selected{ border-color:var(--accent); background:rgba(255,209,59,.16); box-shadow:0 16px 28px rgba(255,209,59,.28); }
  .trackOdds__swatch{ width:10px; height:10px; border-radius:999px; background:var(--rat-color, var(--accent)); box-shadow:0 0 0 2px rgba(0,0,0,.45); }
  .trackOdds__name{ font-weight:600; }
  .trackOdds__odds{ font-weight:700; }
  .trackOdds__share{ font-size:.72rem; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); }
  .trackOdds__empty{ display:inline-flex; align-items:center; padding:.35rem .65rem; border-radius:999px; border:1px solid rgba(255,255,255,.08); background:rgba(9,14,24,.55); color:var(--muted); font-size:.82rem; }

  .info-panel{ grid-area:info; display:flex; flex-direction:column; gap:18px; min-height:0; }
  .info-panel .summaryGrid{ flex:1; }
  .bets-panel{ grid-area:bets; display:flex; flex-direction:column; gap:16px; min-height:0; }
  .info-panel.panel{ padding:24px; align-self:stretch; overflow:auto; }
  .bets-panel.panel{ padding:24px; align-self:stretch; overflow:auto; }
  @media (max-width:720px){
    .info-panel.panel,
    .bets-panel.panel{ padding:20px; }
  }

  .rat-layer{ position:absolute; top:0; left:0; height:100%; width:100%; pointer-events:none; z-index:5; }
  .rat{
    position:absolute;
    width:116px;
    height:104px;
    transform:translate(-9999px,-9999px);
    pointer-events:none;
  }
  .rat-art{ width:116px; height:auto; transform-origin:50% 70%; }
  .rat svg{ width:116px; height:auto; }
  .rat svg .tail{ animation:tail-sway 1.1s ease-in-out infinite; transform-origin:60px 92px; }
  .rat svg .body-group{ animation:body-bob .48s ease-in-out infinite; transform-origin:120px 90px; }
  .rat svg .ear{ animation:ear-flick 2.6s ease-in-out infinite; transform-origin:188px 56px; }
  .rat svg .mane{ animation:mane-flow 1.4s ease-in-out infinite; transform-origin:188px 92px; }
  .rat svg .sparkle{ animation:sparkle 2s linear infinite; }
  @keyframes body-bob{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(-5px); } }
  @keyframes tail-sway{ 0%,100%{ transform:rotate(-8deg); } 50%{ transform:rotate(10deg); } }
  @keyframes ear-flick{ 0%,92%{ transform:rotate(0deg); } 96%{ transform:rotate(-8deg); } 100%{ transform:rotate(0deg); } }
  @keyframes mane-flow{ 0%,100%{ transform:skewX(0deg); } 50%{ transform:skewX(-6deg); } }
  @keyframes sparkle{ 0%{ opacity:0; transform:translate(0,0) scale(.6); }
                       40%{ opacity:.8; transform:translate(4px,-6px) scale(1); }
                       100%{ opacity:0; transform:translate(12px,-18px) scale(0); } }
  .nameTag{
    position:absolute;
    bottom:100%;
    left:50%;
    transform:translate(-50%, -10px);
    background:rgba(18,28,45,.78);
    padding:.18rem .7rem;
    font-size:.78rem;
    letter-spacing:.08em;
    border-radius:999px;
    backdrop-filter:blur(6px);
    box-shadow:0 6px 14px rgba(0,0,0,.38);
    text-transform:uppercase;
    white-space:nowrap;
  }

  /* Betting Panel */
  .panel{
    background:linear-gradient(180deg,#181f33,#0f1423); border:1px solid rgba(255,255,255,.08);
    border-radius:22px; padding:22px; box-shadow:0 28px 50px rgba(0,0,0,.45);
  }
  .panel h2{ margin:.2rem 0 1.1rem; font-size:1.15rem; letter-spacing:.18em; opacity:.92; text-transform:uppercase; }
  .grid{ display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; }
  @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } }
  .field{ display:flex; gap:12px; align-items:center; }
  .field label{ width:96px; color:var(--muted); font-size:.9rem; text-transform:uppercase; letter-spacing:.08em; }
  input[type="text"], input[type="number"], select{
    width:100%; background:rgba(8,12,24,.85); color:var(--text); border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:.6rem .85rem; outline:none; box-shadow:inset 0 2px 8px rgba(0,0,0,.35);
  }
  .btn{
    appearance:none; border:0; border-radius:14px; padding:.85rem 1.1rem; cursor:pointer; font-weight:800;
    color:#121013; background:linear-gradient(135deg,#ffe775,#ffbf24 65%,#ff8b24);
    box-shadow:0 16px 28px rgba(0,0,0,.4); letter-spacing:.06em; text-transform:uppercase;
  }
  .btn.secondary{ background:linear-gradient(135deg,#2e3757,#1e263f); color:#e9eef6; border:1px solid rgba(255,255,255,.14) }
  .btn.muted{ opacity:.6; pointer-events:none }

  .btn.small{ padding:.55rem .8rem; font-size:.85rem; }

  .primary,
  .ghost,
  .secondary{
    appearance:none; border-radius:14px; padding:.8rem 1.05rem; font-weight:800; letter-spacing:.06em;
    text-transform:uppercase; cursor:pointer; border:0; transition:transform .18s ease, box-shadow .18s ease, opacity .18s ease;
  }
  .primary{ background:linear-gradient(135deg,#ffe775,#ffbf24 65%,#ff8b24); color:#121013; box-shadow:0 16px 28px rgba(0,0,0,.4); }
  .ghost{ background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(255,255,255,.04)); color:#e9eef6; border:1px solid rgba(255,255,255,.16); box-shadow:0 16px 28px rgba(0,0,0,.35); }
  .secondary{ background:linear-gradient(135deg,#2e3757,#1e263f); color:#e9eef6; border:1px solid rgba(255,255,255,.16); box-shadow:0 12px 22px rgba(0,0,0,.32); }
  .primary:hover,
  .ghost:hover,
  .secondary:hover,
  .primary:focus-visible,
  .ghost:focus-visible,
  .secondary:focus-visible{ transform:translateY(-1px); outline:none; }
  .muted{ opacity:.6; pointer-events:none }

  .hidden{ display:none !important; }

  .lobby{
    position:fixed; inset:0; z-index:40; display:flex; align-items:center; justify-content:center;
    background:rgba(6,12,24,.82); backdrop-filter:blur(22px); -webkit-backdrop-filter:blur(22px);
    padding:1.6rem;
  }
  .lobby-card{
    background:rgba(13,27,44,.92); border:1px solid rgba(255,255,255,.08); border-radius:26px;
    box-shadow:var(--shadow); padding:clamp(1.6rem,4vw,2.6rem); width:min(420px,94vw);
    display:grid; gap:1.1rem; text-align:center;
  }
  .lobby-card h2{ font-size:1.8rem; margin:0; letter-spacing:.04em; }
  .lobby-card p{ margin:0; opacity:.85; line-height:1.4; }
  .lobby-actions{ display:grid; gap:.8rem; }
  .lobby .ghost{ background:rgba(255,255,255,.12); color:var(--text); border:1px solid rgba(255,255,255,.18); box-shadow:none; }
  .lobby .ghost:hover{ background:rgba(255,255,255,.18); }
  .lobby .secondary{ background:rgba(0,0,0,.35); color:var(--text); border:1px solid rgba(255,255,255,.18); box-shadow:none; }
  .lobby .secondary:hover{ background:rgba(0,0,0,.5); }
  .lobby .back-action{ font-size:.9rem; font-weight:600; padding:.6rem .9rem; justify-self:center; }
  .code-display{
    font-size:2rem; letter-spacing:.24em; font-weight:800; text-transform:uppercase;
    padding:.8rem 1.2rem; border-radius:22px; background:rgba(0,0,0,.38); border:1px solid rgba(255,255,255,.18);
  }
  .lobby input{
    appearance:none; border-radius:16px; border:1px solid rgba(255,255,255,.18);
    padding:.85rem 1rem; background:rgba(0,0,0,.35); color:var(--text); font-size:1.05rem;
    text-transform:none; letter-spacing:.02em; text-align:left;
  }
  .lobby input.code-input{
    text-transform:uppercase; letter-spacing:.18em; text-align:center;
  }
  .lobby input:focus{ outline:2px solid rgba(255,209,59,.55); outline-offset:3px; }
  .lobby input.invalid{ outline:2px solid rgba(239,71,111,.7); outline-offset:3px; }

  .mpCard{
    display:none;
  }
  .mpRow{ display:flex; flex-wrap:wrap; gap:8px; }
  .mpHostActions .btn{ min-width:150px; }
  .mpJoinActions{ justify-content:flex-end; }
  .mpRoom{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:.9rem; }
  .mpRoomCode{ font-weight:700; letter-spacing:.08em; background:rgba(255,255,255,.08); padding:.35rem .65rem; border-radius:10px; }
  .mpJoin{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .mpJoin label{ font-size:.85rem; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }
  .mpJoin input{ flex:1 1 120px; min-width:0; }
  .mpNotice{ font-size:.85rem; color:var(--muted); }

  .summaryGrid{
    display:grid;
    gap:14px;
    margin-top:0;
    grid-template-columns:minmax(0,1fr);
    grid-template-areas:
      "players"
      "pool";
  }
  .summaryCard--players{ grid-area:players; }
  .summaryCard--pool{ grid-area:pool; }
  @media (min-width:1200px){
    .summaryGrid{
      grid-template-columns:repeat(2,minmax(0,1fr));
      grid-template-areas:"pool players";
      align-items:start;
    }
  }
  .summaryCard{
    background:rgba(9,14,26,.72);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px;
    padding:16px 18px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
    display:flex; flex-direction:column; gap:12px;
    flex:1;
  }
  .summaryHeader{ display:flex; justify-content:space-between; align-items:center; font-size:.85rem; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); }
  .summaryMeta{ font-size:.78rem; letter-spacing:.08em; color:var(--muted); opacity:.85; }

  .playerList{ display:flex; flex-direction:column; gap:10px; }
  .playerRow{
    position:relative;
    padding:12px 14px;
    border-radius:14px;
    background:rgba(12,18,32,.78);
    border:1px solid rgba(255,255,255,.04);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    display:flex; flex-direction:column; gap:10px;
  }
  .playerRow.you{ border-color:rgba(255,209,59,.45); box-shadow:0 0 0 1px rgba(255,209,59,.25); }
  .playerRow.ghost{ opacity:.7; }
  .playerRowTop{ display:flex; justify-content:space-between; gap:12px; align-items:center; }
  .playerIdentity{ display:flex; gap:10px; align-items:center; min-width:0; }
  .playerAvatar{
    width:40px; height:40px; border-radius:50%;
    display:grid; place-items:center;
    font-weight:700; letter-spacing:.04em; color:#0c101c;
    background:linear-gradient(135deg, rgba(255,255,255,.25), rgba(255,255,255,0));
    position:relative; isolation:isolate;
  }
  .playerAvatar::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background:var(--avatar-color, #2e3757); z-index:-1;
  }
  .playerInfo{ min-width:0; }
  .playerName{ font-weight:700; letter-spacing:.02em; font-size:1rem; }
  .playerMeta{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; margin-top:2px; font-size:.75rem; color:var(--muted); }
  .playerBadges{ display:flex; flex-wrap:wrap; gap:4px; }
  .playerBadge{
    padding:.15rem .45rem; border-radius:999px; font-size:.7rem; font-weight:700;
    letter-spacing:.08em; text-transform:uppercase;
    border:1px solid rgba(255,255,255,.12); color:var(--muted);
    background:rgba(18,26,42,.75);
  }
  .playerBadge.you{ color:#111; background:linear-gradient(135deg,#ffe775,#ffbf24 70%,#ff8b24); border-color:rgba(255,255,255,.2); }
  .playerBadge.host{ color:#fff; background:linear-gradient(135deg,#506bff,#2c3d8a); border-color:rgba(255,255,255,.18); }
  .playerBadge.ghost{ background:rgba(140,149,171,.2); color:rgba(208,215,230,.9); border-color:rgba(255,255,255,.08); }
  .playerTotals{ text-align:right; min-width:92px; }
  .playerTotals strong{ display:block; font-size:1.05rem; }
  .playerTotals span{ display:block; font-size:.78rem; color:var(--muted); letter-spacing:.05em; }
  .playerBreakdown{ display:flex; flex-wrap:wrap; gap:6px; }
  .playerBreakdown--empty{ color:var(--muted); font-size:.78rem; }
  .ratPill{
    display:inline-flex; align-items:center; gap:6px; padding:.25rem .55rem;
    border-radius:999px; font-size:.78rem; letter-spacing:.03em;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.08);
  }
  .ratPill::before{
    content:""; width:10px; height:10px; border-radius:50%; background:var(--rat-color,#ffd13b);
  }

  .ratTotals{ display:flex; flex-direction:column; gap:10px; }
  .ratRow{
    position:relative; overflow:hidden; border-radius:12px; padding:10px 12px;
    background:rgba(12,18,32,.72); border:1px solid rgba(255,255,255,.05);
  }
  .ratRow.has-bets{ border-color:rgba(255,209,59,.32); }
  .ratRow.selected{ border-color:rgba(255,209,59,.45); box-shadow:0 0 0 1px rgba(255,209,59,.25); }
  .ratProgress{
    position:absolute; inset:0; background:linear-gradient(135deg, rgba(255,209,59,.24), rgba(255,209,59,.05));
    opacity:.9;
  }
  .ratRowInner{ position:relative; display:flex; justify-content:space-between; gap:12px; align-items:center; }
  .ratInfo{ display:flex; gap:10px; align-items:center; font-weight:600; letter-spacing:.03em; }
  .ratInfo .ratSwatch{ width:14px; height:14px; border-radius:4px; box-shadow:0 0 0 1px rgba(255,255,255,.35); }
  .ratNumbers{ text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
  .ratAmount{ display:block; font-weight:700; font-size:1rem; }
  .ratMeta{ display:block; font-size:.78rem; color:var(--muted); letter-spacing:.05em; }
  .ratBetButton{
    appearance:none; border-radius:999px; border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.08); color:var(--text);
    font-size:.75rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase;
    padding:.35rem .8rem; cursor:pointer; transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
  }
  .ratBetButton:hover,
  .ratBetButton:focus-visible{
    outline:none; transform:translateY(-1px);
    background:rgba(255,255,255,.16); box-shadow:0 12px 20px rgba(0,0,0,.32);
  }
  .ratBetButton:disabled{
    opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; background:rgba(255,255,255,.08);
  }

  .emptyState{ padding:14px; border-radius:12px; border:1px dashed rgba(255,255,255,.12); text-align:center; font-size:.82rem; color:var(--muted); background:rgba(9,14,26,.35); }

  .bettorOwner{ margin-top:6px; font-size:.75rem; color:var(--muted); display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  .ownerLabel{ font-weight:600; letter-spacing:.03em; }
  .ownerBadges{ display:flex; flex-wrap:wrap; gap:4px; }

  tbody tr.mine{ border:1px solid rgba(255,209,59,.35); box-shadow:0 16px 28px rgba(255,209,59,.1); }

  table{ width:100%; border-collapse:separate; border-spacing:0 10px; font-variant-numeric:tabular-nums; }
  th, td{ text-align:left; padding:.65rem .9rem; }
  th{ color:var(--muted); font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.08em; }
  tbody tr{ background:rgba(7,11,24,.85); border:1px solid rgba(255,255,255,.08); box-shadow:0 12px 18px rgba(0,0,0,.35); transition:transform .18s ease, box-shadow .18s ease; }
  tbody tr:hover{ transform:translateY(-2px); box-shadow:0 16px 28px rgba(0,0,0,.42); }
  tbody tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px }
  tbody tr td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px }
  .right{ text-align:right }
  .ok{ color:var(--win); font-weight:800 }
  .bad{ color:var(--lose); font-weight:800 }

  .note{ font-size:.9rem; color:var(--muted); margin-top:.5rem }
</style>
</head>
<body>
  <div class="back-nav" role="navigation" aria-label="Exit to main menu">
    <button type="button" class="back-nav__button" data-home="index.html" onclick="handleBack(event)">
      <span class="back-nav__icon" aria-hidden="true">&#8962;</span>
      <span class="back-nav__text">Exit</span>
    </button>
  </div>
  <div class="lobby" id="lobby">
    <div class="lobby-card" id="lobbyMain">
      <h2>Rat Maze Lounge</h2>
      <p>Select how you'd like to play.</p>
      <div class="lobby-actions">
        <button class="primary" id="btnSingleplayer" type="button">Singleplayer</button>
        <button class="ghost" id="btnMultiplayer" type="button">Multiplayer</button>
      </div>
    </div>
    <div class="lobby-card hidden" id="multiplayerCard">
      <h2>Multiplayer</h2>
      <p>Invite friends with a shared room code.</p>
      <div class="lobby-actions">
        <button class="primary" id="btnLobbyHost" type="button">Host</button>
        <button class="ghost" id="btnLobbyJoin" type="button">Join</button>
      </div>
      <button class="secondary back-action" data-target="lobbyMain" type="button">Back</button>
    </div>
    <div class="lobby-card hidden" id="hostCard">
      <h2>Host a Room</h2>
      <p>Choose a name and share this code with friends.</p>
      <input type="text" id="lobbyHostName" maxlength="24" autocomplete="name" placeholder="Your name" spellcheck="false" />
      <div class="code-display" id="lobbyHostCode">----</div>
      <button class="ghost" id="btnCopyLobbyCode" type="button">Copy code</button>
      <button class="primary" id="btnLobbyHostStart" type="button">Enter Room</button>
      <button class="secondary back-action" data-target="multiplayerCard" type="button">Back</button>
    </div>
    <div class="lobby-card hidden" id="joinCard">
      <h2>Join a Room</h2>
      <p>Enter your name and the code from your host.</p>
      <input type="text" id="lobbyJoinName" maxlength="24" autocomplete="name" placeholder="Your name" spellcheck="false" />
      <input type="text" id="lobbyJoinCode" class="code-input" maxlength="12" autocomplete="off" placeholder="CODE" />
      <div class="lobby-actions">
        <button class="primary" id="btnLobbyJoinConfirm" type="button">Join Room</button>
        <button class="secondary back-action" data-target="multiplayerCard" type="button">Back</button>
      </div>
    </div>
  </div>
  <div class="wrap">
    <div class="board" data-view="betting">
      <section class="track-card" id="trackCard">
        <div class="track-viewport" id="trackViewport">
          <div class="race-camera" id="raceCamera">
            <div class="race-stage" id="raceStage" role="img" aria-label="Side-scrolling rat race track">
              <div class="race-stage__sky"></div>
              <div class="race-stage__far"></div>
              <div class="race-stage__mid"></div>
              <div class="race-stage__ground">
                <div class="race-stage__lane-lines" id="laneLines"></div>
                <div class="race-stage__finish" id="finishMarker"><span>Finish</span></div>
              </div>
            </div>
            <div class="rat-layer" id="ratLayer"></div>
          </div>
          <div class="race-overlay" id="raceOverlay">
            <div class="race-countdown hidden" id="raceCountdown"></div>
          </div>
        </div>
        <header>
          <div class="status" id="status">Place your bets.</div>
          <div class="trackHeaderAside">
            <div class="legend">
              <span><span class="pill" id="pot">$0</span> pot</span>
              <span>Min bet $1</span>
            </div>
            <div class="trackOdds" id="trackOdds" hidden></div>
          </div>
        </header>
      </section>

      <aside class="info-panel panel">
        <div class="mpCard" id="mpCard">
          <div class="mpRow" id="mpButtonRow">
            <button class="btn secondary" id="btnSolo" type="button">Solo</button>
            <button class="btn secondary" id="btnHostRoom" type="button">Host Room</button>
            <button class="btn secondary" id="btnJoinRoom" type="button">Join Room</button>
          </div>
          <div class="mpRoom" id="roomInfo" hidden>
            <span>Room:</span>
            <span class="mpRoomCode" id="roomCode">—</span>
            <button class="btn secondary small" id="btnCopyRoom" type="button">Copy Code</button>
          </div>
          <div class="mpRow mpHostActions" id="hostActions" hidden>
            <button class="btn" id="btnConfirmHost" type="button">Create Room</button>
            <button class="btn secondary" id="btnCancelHost" type="button">Back</button>
          </div>
          <div class="mpJoin" id="joinControls" hidden>
            <label for="joinCode">Room Code</label>
            <input id="joinCode" type="text" placeholder="ABCDE" maxlength="12" autocomplete="off" />
            <button class="btn secondary" id="btnConfirmJoin" type="button">Join</button>
          </div>
          <div class="mpRow mpJoinActions" id="joinActions" hidden>
            <button class="btn secondary" id="btnCancelJoin" type="button">Back</button>
          </div>
          <div class="mpNotice" id="mpNotice">You are playing solo.</div>
        </div>
        <div class="summaryGrid">
          <div class="summaryCard summaryCard--players">
            <div class="summaryHeader">Players <span class="summaryMeta" id="playerCount">—</span></div>
            <div class="playerList" id="playerList"></div>
          </div>
          <div class="summaryCard summaryCard--pool">
            <div class="summaryHeader">Rat Pool <span class="summaryMeta" id="poolMeta">—</span></div>
            <div class="ratTotals" id="ratTotals"></div>
          </div>
        </div>
      </aside>

      <section class="bets-panel panel">
        <h2>Betting</h2>
        <div class="grid">
          <div class="field"><label for="bettor">Bettor</label><input id="bettor" type="text" placeholder="Name (optional)"></div>
          <div class="field"><label for="rat">Rat</label>
            <select id="rat"></select>
          </div>
          <div class="field"><label for="amount">Amount</label><input id="amount" type="number" min="1" step="1" value="10"></div>
        </div>
        <div style="display:flex; gap:8px; margin:.8rem 0 1rem">
          <button class="btn" id="addBet">Add Bet</button>
        </div>

        <table>
          <thead><tr><th>Bettor</th><th>Rat</th><th class="right">Amount</th><th class="right">Remove</th></tr></thead>
          <tbody id="betRows"></tbody>
        </table>

        <div class="note">
          Payouts are pari-mutuel: winners split the pot in proportion to their bet. If nobody bet the winning rat, the house keeps the pot (🐀).
        </div>

        <h2 style="margin-top:1.2rem">Results</h2>
        <table>
          <thead><tr><th>Bettor</th><th>Rat</th><th class="right">Bet</th><th class="right">Payout</th><th class="right">Net</th></tr></thead>
          <tbody id="resultRows"><tr><td colspan="5" style="color:var(--muted)">No results yet.</td></tr></tbody>
        </table>
      </section>
    </div>
  </div>

  <script>
    function handleBack(event){
      if(event){
        event.preventDefault();
      }

      const home = event?.currentTarget?.dataset?.home || 'index.html';

      const normalizePath = (value) => {
        const url = new URL(value, window.location.origin);
        let path = url.pathname;

        if(path.endsWith('/index.html')){
          path = path.slice(0, -'/index.html'.length) || '/';
        }

        if(path.endsWith('/')){
          path = path.slice(0, -1) || '/';
        }

        return path || '/';
      };

      const currentPath = normalizePath(window.location.pathname || window.location.href);
      const homePath = normalizePath(home);

      if(currentPath === homePath){
        return;
      }

      window.location.href = home;
    }
  </script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
import { getDatabase, ref, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

/* ============== Track geometry & rats ============== */
const RAT_DATA = [
  { id:'r1', name:'Midnight Gnawer', color:'#5a4332' },
  { id:'r2', name:'Amber Nibbles',  color:'#c18852' },
  { id:'r3', name:'Silver Whisk',  color:'#a8b7c8' },
  { id:'r4', name:'Verdant Scurry', color:'#4b6f5d' },
  { id:'r5', name:'Crimson Scamper', color:'#a24b3c' },
];

const statusEl = document.getElementById('status');
const potEl = document.getElementById('pot');
const trackOddsEl = document.getElementById('trackOdds');
const trackViewport = document.getElementById('trackViewport');
const raceCamera = document.getElementById('raceCamera');
const raceStage = document.getElementById('raceStage');
const parallaxFar = raceStage?.querySelector('.race-stage__far') || null;
const parallaxMid = raceStage?.querySelector('.race-stage__mid') || null;
const laneLinesEl = document.getElementById('laneLines');
const raceCountdownEl = document.getElementById('raceCountdown');
const ratLayer = document.getElementById('ratLayer');
const finishMarker = document.getElementById('finishMarker');
const boardEl = document.querySelector('.board');

const TRACK_DISTANCE = 1800;
const TRACK_START_OFFSET = 140;
const TRACK_END_BUFFER = 220;
const WORLD_LENGTH = TRACK_START_OFFSET + TRACK_DISTANCE + TRACK_END_BUFFER;
const laneCount = RAT_DATA.length;
let viewportWidth = 0;
let viewportHeight = 0;
let laneCenters = [];
let cameraX = 0;

function setScreen(view='betting'){
  if(boardEl){
    boardEl.dataset.view = view;
  }
}

function updateViewportScale(){
  if(!trackViewport) return;
  const rect = trackViewport.getBoundingClientRect();
  viewportWidth = rect.width;
  viewportHeight = rect.height;
  const groundHeight = viewportHeight * 0.52;
  const groundTop = viewportHeight - groundHeight;
  const spacing = laneCount ? groundHeight / (laneCount + 1) : groundHeight;
  laneCenters = Array.from({ length: laneCount }, (_, index) => groundTop + spacing * (index + 1));
  if(raceCamera){
    raceCamera.style.setProperty('--track-length', `${WORLD_LENGTH}px`);
    raceCamera.style.width = `${WORLD_LENGTH}px`;
  }
  if(raceStage){
    raceStage.style.setProperty('--track-length', `${WORLD_LENGTH}px`);
    raceStage.style.width = `${WORLD_LENGTH}px`;
  }
  if(ratLayer){
    ratLayer.style.width = `${WORLD_LENGTH}px`;
    ratLayer.style.height = '100%';
  }
  if(laneLinesEl){
    laneLinesEl.style.setProperty('--lane-spacing', `${spacing}px`);
  }
  if(finishMarker){
    finishMarker.style.setProperty('--finish-x', `${TRACK_START_OFFSET + TRACK_DISTANCE}px`);
  }
}

updateViewportScale();
setCameraX(0);

function setCameraX(value=0){
  const maxOffset = Math.max(0, WORLD_LENGTH - viewportWidth);
  cameraX = Math.min(Math.max(value, 0), maxOffset);
  if(raceCamera){
    raceCamera.style.transform = `translateX(${-cameraX}px)`;
  }
  if(parallaxFar){
    parallaxFar.style.transform = `translateX(${cameraX * 0.25}px)`;
  }
  if(parallaxMid){
    parallaxMid.style.transform = `translateX(${cameraX * 0.45}px)`;
  }
}

const rats = RAT_DATA.map((r, index) => {
  const el = document.createElement('div');
  el.className = 'rat';
  const art = document.createElement('div');
  art.className = 'rat-art';
  art.innerHTML = ratSVG(r.color);
  el.appendChild(art);
  const tag = document.createElement('div');
  tag.className = 'nameTag';
  tag.textContent = r.name;
  el.appendChild(tag);
  ratLayer?.appendChild(el);

  const halfWidth = el.offsetWidth / 2 || 58;
  const halfHeight = el.offsetHeight / 2 || 52;

  return { ...r, el, art, tag, laneIndex:index, halfWidth, halfHeight, x:0, v:0, baseSpeed:0, wobbleAmp:0, wobblePeriod:160, wobblePhase:0, pathLength:TRACK_DISTANCE };
});

for(const r of rats){
  positionRat(r, 0);
}

function positionRat(r, distance=0){
  const clamped = Math.min(distance, TRACK_DISTANCE);
  const worldX = TRACK_START_OFFSET + clamped;
  const laneIndex = r.laneIndex ?? 0;
  const laneY = laneCenters[laneIndex] ?? (viewportHeight * 0.65);
  const halfWidth = r.el.offsetWidth ? r.el.offsetWidth / 2 : (r.halfWidth || 58);
  const halfHeight = r.el.offsetHeight ? r.el.offsetHeight / 2 : (r.halfHeight || 52);
  r.halfWidth = halfWidth;
  r.halfHeight = halfHeight;
  r.el.style.transform = `translate(${worldX - halfWidth}px, ${laneY - halfHeight}px)`;
  r.art.style.transform = 'scaleX(1)';
}

window.addEventListener('resize', () => {
  updateViewportScale();
  setCameraX(cameraX);
  for(const r of rats){
    positionRat(r, r.x || 0);
  }
});

// selection dropdown
const sel = document.getElementById('rat');
for(const r of RAT_DATA){
  const o = document.createElement('option');
  o.value = r.id; o.textContent = r.name;
  sel.appendChild(o);
}

/* ============== Betting state ============== */
let bets = []; // {id, name, ratId, amount, owner, createdAt}
const betRows = document.getElementById('betRows');
const resultRows = document.getElementById('resultRows');
const addBetBtn = document.getElementById('addBet');
const bettorInput = document.getElementById('bettor');
const amountInput = document.getElementById('amount');
let quickBetRatId = sel ? sel.value : null;
let players = {};
let isMultiplayer = false;
let isHost = false;
let roomId = null;
let gamePath = '';
let betsRef = null;
let stateRef = null;
let presenceRef = null;
let playersRef = null;
let unsubscribers = [];
let remoteState = { status:'open', countdownDuration:2100 };
let mpMode = 'solo';
let pendingHostCode = '';
let betUiLocked = false;
const CLIENT_STORAGE_KEY = 'ratRaceClientId';
const NAME_STORAGE_KEY = 'ratRacePlayerName';
let playerName = '';
const AUTO_START_DELAY = 2500;
const AUTO_REOPEN_DELAY = 6000;
let autoStartTimer = null;
let autoReopenTimer = null;
try{
  const stored = localStorage.getItem(NAME_STORAGE_KEY);
  if(stored){
    playerName = stored;
    bettorInput.value = stored;
  }
} catch(err){
  console.debug('Unable to access stored name', err);
}

const clientId = (()=>{
  try{
    const existing = localStorage.getItem(CLIENT_STORAGE_KEY);
    if(existing) return existing;
    const id = generateId();
    localStorage.setItem(CLIENT_STORAGE_KEY, id);
    return id;
  }catch(err){
    return generateId();
  }
})();


const lobbyEl = document.getElementById('lobby');
const lobbyMainCard = document.getElementById('lobbyMain');
const lobbyMultiplayerCard = document.getElementById('multiplayerCard');
const lobbyHostCard = document.getElementById('hostCard');
const lobbyJoinCard = document.getElementById('joinCard');
const lobbySingleBtn = document.getElementById('btnSingleplayer');
const lobbyMultiplayerBtn = document.getElementById('btnMultiplayer');
const lobbyHostBtn = document.getElementById('btnLobbyHost');
const lobbyJoinBtn = document.getElementById('btnLobbyJoin');
const lobbyHostStartBtn = document.getElementById('btnLobbyHostStart');
const lobbyJoinConfirmBtn = document.getElementById('btnLobbyJoinConfirm');
const lobbyHostNameInput = document.getElementById('lobbyHostName');
const lobbyJoinNameInput = document.getElementById('lobbyJoinName');
const lobbyJoinCodeInput = document.getElementById('lobbyJoinCode');
const lobbyHostCodeEl = document.getElementById('lobbyHostCode');
const lobbyCopyCodeBtn = document.getElementById('btnCopyLobbyCode');
const lobbyCards = {
  lobbyMain: lobbyMainCard,
  multiplayerCard: lobbyMultiplayerCard,
  hostCard: lobbyHostCard,
  joinCard: lobbyJoinCard,
};
let lobbyHostCodeValue = '';
let lobbyCopyResetTimer = null;

function showLobbyCard(id){
  Object.values(lobbyCards).forEach(card=>{
    if(card){
      card.classList.add('hidden');
    }
  });
  const target = lobbyCards[id] || lobbyCards.lobbyMain;
  if(target){
    target.classList.remove('hidden');
  }
}

function closeLobby(){
  if(lobbyEl){
    lobbyEl.classList.add('hidden');
  }
}

function openLobby(id='lobbyMain'){
  if(!lobbyEl) return;
  lobbyEl.classList.remove('hidden');
  showLobbyCard(id);
}

const soloBtn = document.getElementById('btnSolo');
const hostBtn = document.getElementById('btnHostRoom');
const joinBtn = document.getElementById('btnJoinRoom');
const joinControls = document.getElementById('joinControls');
const joinCodeInput = document.getElementById('joinCode');
const joinConfirmBtn = document.getElementById('btnConfirmJoin');
const roomInfo = document.getElementById('roomInfo');
const roomCodeEl = document.getElementById('roomCode');
const copyRoomBtn = document.getElementById('btnCopyRoom');
const mpNotice = document.getElementById('mpNotice');
const mpCardEl = document.getElementById('mpCard');
const mpButtonRow = document.getElementById('mpButtonRow');
const hostActions = document.getElementById('hostActions');
const hostConfirmBtn = document.getElementById('btnConfirmHost');
const hostCancelBtn = document.getElementById('btnCancelHost');
const joinActions = document.getElementById('joinActions');
const joinCancelBtn = document.getElementById('btnCancelJoin');
const playerListEl = document.getElementById('playerList');
const ratTotalsEl = document.getElementById('ratTotals');
const playerCountEl = document.getElementById('playerCount');
const poolMetaEl = document.getElementById('poolMeta');

function fmt(n){ return '$'+Number(n).toLocaleString(undefined,{minimumFractionDigits:0}); }
function pot(){ return bets.reduce((a,b)=>a+Number(b.amount||0),0); }
function totalOn(rid){ return bets.filter(b=>b.ratId===rid).reduce((a,b)=>a+Number(b.amount),0); }

function formatOddsMultiplier(value){
  if(!isFinite(value) || value <= 0){
    return '—';
  }
  const precision = value >= 100 ? 0 : value >= 10 ? 1 : 2;
  return Number(value).toFixed(precision).replace(/\.0+$/, '');
}

function sanitizePlayerName(value){
  if(value == null) return '';
  return String(value)
    .replace(/[\r\n\t]+/g, ' ')
    .replace(/\s{2,}/g, ' ')
    .trim()
    .slice(0, 24);
}

function flagInvalidInput(input){
  if(!input) return;
  input.classList.add('invalid');
  setTimeout(()=>input.classList.remove('invalid'), 1600);
}

function canRemoveBet(bet){
  if(!bet) return false;
  if(!isMultiplayer) return true;
  return isHost || bet.owner === clientId;
}

function redrawBets(){
  betRows.innerHTML = '';
  if(!bets.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" style="color:var(--muted)">No bets yet.</td>`;
    betRows.appendChild(tr);
  }else{
    const sorted = [...bets].sort((a,b)=>{
      if(a.createdAt && b.createdAt){ return a.createdAt - b.createdAt; }
      return (a.name || '').localeCompare(b.name || '');
    });
    for(const b of sorted){
      const tr = document.createElement('tr');
      if(b.owner === clientId){
        tr.classList.add('mine');
      }
      const removeCell = canRemoveBet(b)
        ? `<button class="btn secondary" data-remove="${b.id}" style="padding:.4rem .6rem">×</button>`
        : '—';
      const ownerDetail = formatOwnerMeta(b.owner);
      tr.innerHTML = `
        <td>${escapeHTML(b.name||'—')}${ownerDetail}</td>
        <td>${ratName(b.ratId)}</td>
        <td class="right">${fmt(b.amount)}</td>
        <td class="right">${removeCell}</td>`;
      betRows.appendChild(tr);
    }
  }
  potEl.textContent = fmt(pot());
  renderSummaries();
  updateAutoStartState();
}
function escapeHTML(value){
  const str = value ?? '';
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(str).replace(/[&<>"']/g, (match) => map[match]);
}
function ratName(id){ return RAT_DATA.find(r=>r.id===id)?.name || id; }
function ratColor(id){ return RAT_DATA.find(r=>r.id===id)?.color || '#ffd13b'; }
function getLocalPlayerName(){ return bettorInput.value.trim() || playerName || 'You'; }
function defaultPlayerName(id){
  if(id === clientId) return getLocalPlayerName();
  if(!id) return 'Player';
  const tail = String(id).slice(-4).toUpperCase();
  return `Player ${tail}`;
}
function playerInitials(name){
  if(!name) return '?';
  const words = name.trim().split(/\s+/).filter(Boolean);
  if(!words.length) return '?';
  if(words.length === 1) return words[0].slice(0,2).toUpperCase();
  return (words[0][0] + words[words.length-1][0]).toUpperCase();
}
function avatarColorFor(id=''){
  let hash = 0;
  for(let i=0;i<id.length;i++){
    hash = (hash * 31 + id.charCodeAt(i)) >>> 0;
  }
  const hue = hash % 360;
  return `hsl(${hue}, 62%, 45%)`;
}
function computeOwnerStats(){
  const stats = {};
  for(const bet of bets){
    const owner = bet.owner || 'anon';
    const amount = Number(bet.amount) || 0;
    if(!stats[owner]){
      stats[owner] = { total:0, count:0, rats:{} };
    }
    stats[owner].total += amount;
    stats[owner].count += 1;
    stats[owner].rats[bet.ratId] = (stats[owner].rats[bet.ratId] || 0) + amount;
  }
  return stats;
}
function formatBetCount(count){
  return count === 1 ? '1 bet' : `${count || 0} bets`;
}
function playerDisplayInfo(ownerId){
  const info = players?.[ownerId];
  const name = ownerId === clientId
    ? getLocalPlayerName()
    : (info?.name?.trim() || defaultPlayerName(ownerId));
  return {
    id: ownerId,
    name,
    isHost: !!info?.isHost,
    you: ownerId === clientId,
    ghost: isMultiplayer && !!ownerId && !info
  };
}
function formatOwnerMeta(ownerId){
  if(!ownerId) return '';
  const info = playerDisplayInfo(ownerId);
  const badges = [];
  if(info.you) badges.push('<span class="playerBadge you">You</span>');
  if(info.isHost) badges.push('<span class="playerBadge host">Host</span>');
  if(info.ghost) badges.push('<span class="playerBadge ghost">Offline</span>');
  return `<div class="bettorOwner"><span class="ownerLabel">${escapeHTML(info.name)}</span>${badges.length ? `<span class="ownerBadges">${badges.join('')}</span>` : ''}</div>`;
}
function renderSummaries(){
  renderPlayerList();
  renderRatTotals();
}
function renderPlayerList(){
  if(!playerListEl) return;
  const ownerStats = computeOwnerStats();
  let entries = [];
  if(isMultiplayer){
    const activeEntries = Object.entries(players || {}).filter(([,value])=>value);
    entries = activeEntries.map(([id,value])=>({ id, data:value, stats: ownerStats[id] || { total:0, count:0, rats:{} } }));
    for(const ownerId of Object.keys(ownerStats)){
      if(!entries.find(e=>e.id===ownerId)){
        entries.push({ id: ownerId, data: null, stats: ownerStats[ownerId] });
      }
    }
    if(!entries.find(e=>e.id===clientId)){
      entries.push({ id: clientId, data: { name: getLocalPlayerName(), isHost }, stats: ownerStats[clientId] || { total:0, count:0, rats:{} } });
    }
  }else{
    entries = [{ id: clientId, data: { name: getLocalPlayerName(), isHost:true }, stats: ownerStats[clientId] || { total: pot(), count: bets.length, rats:{} } }];
  }
  entries.sort((a,b)=>{
    const aInfo = playerDisplayInfo(a.id);
    const bInfo = playerDisplayInfo(b.id);
    if(aInfo.you !== bInfo.you){ return aInfo.you ? -1 : 1; }
    if(aInfo.isHost !== bInfo.isHost){ return bInfo.isHost ? 1 : -1; }
    const aTotal = a.stats?.total || 0;
    const bTotal = b.stats?.total || 0;
    if(bTotal !== aTotal) return bTotal - aTotal;
    return aInfo.name.localeCompare(bInfo.name);
  });
  const count = entries.length;
  if(playerCountEl){
    playerCountEl.textContent = count ? (count === 1 ? '1 player' : `${count} players`) : 'No players';
  }
  if(!count){
    playerListEl.innerHTML = `<div class="emptyState">No players yet.</div>`;
    return;
  }
  playerListEl.innerHTML = entries.map(entry=>{
    const info = playerDisplayInfo(entry.id);
    const total = entry.stats?.total || 0;
    const countText = formatBetCount(entry.stats?.count || 0);
    const breakdownEntries = Object.entries(entry.stats?.rats || {}).filter(([,amt])=>amt>0).sort((a,b)=>b[1]-a[1]).slice(0,4);
    const breakdown = breakdownEntries.length
      ? `<div class="playerBreakdown">${breakdownEntries.map(([rid,amt])=>`<span class="ratPill" style="--rat-color:${ratColor(rid)}">${escapeHTML(ratName(rid))} <span>${fmt(amt)}</span></span>`).join('')}</div>`
      : `<div class="playerBreakdown playerBreakdown--empty">No bets yet.</div>`;
    const badges = [];
    if(info.you) badges.push('<span class="playerBadge you">You</span>');
    if(info.isHost) badges.push('<span class="playerBadge host">Host</span>');
    if(info.ghost) badges.push('<span class="playerBadge ghost">Offline</span>');
    const metaText = entry.stats?.count ? formatBetCount(entry.stats.count) : 'No bets yet';
    const metaContent = `${badges.length ? `<span class="playerBadges">${badges.join('')}</span>` : ''}<span>${metaText}</span>`;
    return `<div class="playerRow${info.you ? ' you' : ''}${info.ghost ? ' ghost' : ''}">
      <div class="playerRowTop">
        <div class="playerIdentity">
          <div class="playerAvatar" style="--avatar-color:${avatarColorFor(entry.id)}">${escapeHTML(playerInitials(info.name))}</div>
          <div class="playerInfo">
            <div class="playerName">${escapeHTML(info.name)}</div>
            <div class="playerMeta">${metaContent}</div>
          </div>
        </div>
        <div class="playerTotals">
          <strong>${fmt(total)}</strong>
          <span>${countText}</span>
        </div>
      </div>
      ${breakdown}
    </div>`;
  }).join('');
}
function renderTrackOdds({ totalPot=0 }={}){
  if(!trackOddsEl) return;
  if(!isMultiplayer){
    trackOddsEl.hidden = true;
    trackOddsEl.innerHTML = '';
    return;
  }
  trackOddsEl.hidden = false;
  const entries = RAT_DATA.map(r=>{
    const amount = totalOn(r.id);
    const share = totalPot ? (amount / totalPot) : 0;
    const percent = totalPot ? Math.round(share * 100) : 0;
    const payout = amount > 0 ? (totalPot / amount) : 0;
    const payoutText = payout ? `${formatOddsMultiplier(payout)}×` : '—';
    const shareText = totalPot ? `${percent}% pot` : '0% pot';
    const selected = quickBetRatId === r.id;
    return {
      id: r.id,
      name: r.name,
      payoutText,
      shareText,
      selected,
      hasBets: amount > 0
    };
  });
  const hasBets = entries.some(entry=>entry.hasBets);
  const oddsMarkup = entries.map(entry=>`<span class="trackOdds__item${entry.selected ? ' selected' : ''}" style="--rat-color:${ratColor(entry.id)}"><span class="trackOdds__swatch" aria-hidden="true"></span><span class="trackOdds__name">${escapeHTML(entry.name)}</span><span class="trackOdds__odds">${entry.payoutText}</span><span class="trackOdds__share">${entry.shareText}</span></span>`).join('');
  trackOddsEl.innerHTML = hasBets ? oddsMarkup : `<span class="trackOdds__empty">No bets yet</span>${oddsMarkup}`;
}

function renderRatTotals(){
  if(!ratTotalsEl) return;
  const totalPot = pot();
  if(poolMetaEl){
    poolMetaEl.textContent = totalPot ? `${fmt(totalPot)} total` : 'No bets yet — select a rat below.';
  }
  const bettingLocked = betUiLocked || (isMultiplayer && remoteState.status !== 'open');
  const rows = RAT_DATA.map(r=>{
    const amount = totalOn(r.id);
    const count = bets.filter(b=>b.ratId===r.id).length;
    const share = totalPot ? Math.round((amount/totalPot)*100) : 0;
    const barPct = totalPot ? Math.max(6, (amount/totalPot)*100) : 0;
    const progress = amount > 0 ? `<div class="ratProgress" style="width:${Math.min(barPct,100)}%"></div>` : '';
    const metaParts = [];
    metaParts.push(count ? formatBetCount(count) : 'No bets');
    if(share) metaParts.push(`${share}% of pot`);
    const ratLabel = escapeHTML(r.name);
    const selectedClass = quickBetRatId === r.id ? ' selected' : '';
    const title = bettingLocked ? 'Betting is closed' : `Bet on ${ratLabel}`;
    return `<div class="ratRow${amount ? ' has-bets' : ''}${selectedClass}" data-rat="${r.id}">${progress}<div class="ratRowInner"><div class="ratInfo"><span class="ratSwatch" style="background:${ratColor(r.id)}"></span><span>${ratLabel}</span></div><div class="ratNumbers"><span class="ratAmount">${fmt(amount)}</span><span class="ratMeta">${metaParts.join(' • ')}</span><button class="ratBetButton" type="button" data-bet-rat="${r.id}" aria-label="Bet on ${ratLabel}" title="${title}"${bettingLocked ? ' disabled' : ''}>Bet</button></div></div></div>`;
  }).join('');
  ratTotalsEl.innerHTML = rows || `<div class="emptyState">No bets yet.</div>`;
  renderTrackOdds({ totalPot });
}

if(sel){
  sel.addEventListener('change', ()=>{
    quickBetRatId = sel.value || null;
    renderRatTotals();
  });
}

if(ratTotalsEl){
  ratTotalsEl.addEventListener('click', (event)=>{
    const button = event.target.closest('[data-bet-rat]');
    if(!button || button.disabled) return;
    const ratId = button.dataset.betRat;
    if(!ratId) return;
    quickBetRatId = ratId;
    renderRatTotals();
    if(sel){
      sel.value = ratId;
    }
    if(amountInput){
      amountInput.focus();
      amountInput.select();
    }
    const canUpdateStatus = (!isMultiplayer || (remoteState?.status ?? 'open') === 'open') && !racing && !finished;
    if(canUpdateStatus){
      statusEl.classList.remove('countdown');
      statusEl.textContent = `Bet on ${ratName(ratId)}. Enter amount below.`;
    }
  });
}

function cancelAutoStart(){
  if(autoStartTimer){
    clearTimeout(autoStartTimer);
    autoStartTimer = null;
  }
}

async function triggerAutoStart(){
  cancelAutoStart();
  if(isMultiplayer){
    if(!isHost || remoteState.status !== 'open' || !bets.length){
      return;
    }
    cancelAutoReopen();
    await hostStartRace();
  }else{
    if(!bets.length || racing || finished){
      return;
    }
    toggleBetUI(true);
    const startTime = Date.now();
    await startCountdown({ startTime });
    if(!bets.length){
      toggleBetUI(false);
      return;
    }
    cancelAutoReopen();
    startRace();
  }
}

function scheduleAutoStart(){
  if(betUiLocked || !bets.length){
    cancelAutoStart();
    return;
  }
  if(isMultiplayer){
    if(!isHost || remoteState.status !== 'open'){
      cancelAutoStart();
      return;
    }
  }else{
    if(racing || finished){
      cancelAutoStart();
      return;
    }
  }
  cancelAutoStart();
  statusEl.classList.remove('countdown');
  statusEl.textContent = 'Race starting soon…';
  autoStartTimer = setTimeout(()=>{
    autoStartTimer = null;
    triggerAutoStart();
  }, AUTO_START_DELAY);
}

function cancelAutoReopen(){
  if(autoReopenTimer){
    clearTimeout(autoReopenTimer);
    autoReopenTimer = null;
  }
}

function scheduleAutoReopen(options={}){
  if(options.triggeredByNetwork){
    return;
  }
  if(isMultiplayer && !isHost){
    return;
  }
  cancelAutoReopen();
  autoReopenTimer = setTimeout(()=>{
    autoReopenTimer = null;
    if(isMultiplayer){
      hostResetRace({ preserveResults:true });
    }else{
      openNextSoloRound();
    }
  }, AUTO_REOPEN_DELAY);
}

function openNextSoloRound(){
  cancelAutoStart();
  cancelAutoReopen();
  bets = [];
  redrawBets();
  resetRacePositions();
  statusEl.classList.remove('countdown');
  statusEl.textContent = 'Place your bets.';
  toggleBetUI(false);
  setScreen('betting');
}

function updateAutoStartState(){
  if(betUiLocked){
    cancelAutoStart();
    return;
  }
  if(!bets.length && !racing){
    statusEl.classList.remove('countdown');
    statusEl.textContent = 'Place your bets.';
  }
  if(isMultiplayer){
    if(isHost && remoteState.status === 'open' && bets.length && !racing){
      scheduleAutoStart();
    }else{
      cancelAutoStart();
    }
  }else{
    if(bets.length && !racing && !finished){
      scheduleAutoStart();
    }else{
      cancelAutoStart();
    }
  }
}

addBetBtn.addEventListener('click', ()=>{
  if(isMultiplayer && remoteState.status !== 'open'){ statusEl.textContent = 'Betting is closed.'; return; }
  const name = bettorInput.value.trim();
  const ratId = sel.value;
  const amount = Math.max(1, Math.floor(Number(amountInput.value||0)));
  const bet = { id:generateId(), name, ratId, amount, owner:clientId, createdAt:Date.now() };
  if(isMultiplayer){
    if(!gamePath) return;
    const updatePayload = {};
    updatePayload[`${gamePath}/bets/${bet.id}`] = bet;
    update(rootRef, updatePayload).catch(err=>{
      console.warn('Failed to add bet', err);
      statusEl.textContent = 'Unable to add bet right now.';
    });
  }else{
    bets.push(bet);
    redrawBets();
  }
});

betRows.addEventListener('click', (e)=>{
  const id = e.target?.dataset?.remove;
  if(!id) return;
  const bet = bets.find(b=>b.id===id);
  if(!bet) return;
  if(isMultiplayer){
    if(!canRemoveBet(bet)) return;
    const updatePayload = {};
    updatePayload[`${gamePath}/bets/${id}`] = null;
    update(rootRef, updatePayload).catch(err=>{
      console.warn('Failed to remove bet', err);
    });
  }else{
    bets = bets.filter(b=>b.id!==id);
    redrawBets();
  }
});

/* ============== Race engine ============== */
let racing = false, finished = false, animId = 0, winner = null;
let countdownToken = 0;
let currentRaceSetup = null;
let postedResults = false;

function resetRacePositions(){
  for(const r of rats){
    r.x = 0;
    r.v = 0;
    r.baseSpeed = 0;
    r.wobbleAmp = 0;
    r.wobblePeriod = 160;
    r.wobblePhase = 0;
    positionRat(r, 0);
  }
  setCameraX(0);
  if(raceCountdownEl){
    raceCountdownEl.classList.add('hidden');
  }
  winner = null; finished=false; racing=false; currentRaceSetup=null; postedResults=false;
}
resetRacePositions();

function cancelCountdown(){
  countdownToken++;
  statusEl.classList.remove('countdown');
  if(raceCountdownEl){
    raceCountdownEl.classList.add('hidden');
  }
}

async function startCountdown({ startTime=Date.now(), duration=2100 }={}){
  const token = ++countdownToken;
  setScreen('race');
  statusEl.classList.add('countdown');
  if(raceCountdownEl){
    raceCountdownEl.classList.remove('hidden');
  }
  const steps = [
    { value:3, offset:0 },
    { value:2, offset:700 },
    { value:1, offset:1400 }
  ];
  for(const step of steps){
    const wait = startTime + step.offset - Date.now();
    if(wait > 1) await sleep(wait);
    if(token !== countdownToken) return;
    const remaining = startTime + duration - Date.now();
    if(remaining <= 0) break;
    statusEl.textContent = `Racing in ${step.value}…`;
    if(raceCountdownEl){
      raceCountdownEl.textContent = step.value;
    }
  }
  const finalWait = startTime + duration - Date.now();
  if(finalWait > 1) await sleep(finalWait);
  if(token !== countdownToken) return;
  statusEl.textContent = 'Go!';
  if(raceCountdownEl){
    raceCountdownEl.textContent = 'Go!';
  }
  await sleep(200);
  if(token !== countdownToken) return;
  statusEl.classList.remove('countdown');
  if(raceCountdownEl){
    raceCountdownEl.classList.add('hidden');
  }
}

function startRace(setup){
  setScreen('race');
  racing = true;
  finished = false;
  setCameraX(0);

  const configuration = setup || createRaceSetup();
  currentRaceSetup = configuration;

  const byId = new Map((configuration?.rats || []).map(cfg => [cfg.id, cfg]));
  for(const r of rats){
    const cfg = byId.get(r.id) || {};
    r.v = cfg.baseSpeed ?? (4.1 + Math.random()*1.6);
    r.baseSpeed = r.v;
    r.wobbleAmp = cfg.wobbleAmp ?? (0.5 + Math.random()*0.4);
    r.wobblePeriod = cfg.wobblePeriod ?? (180 + Math.random()*140);
    r.wobblePhase = cfg.wobblePhase ?? (Math.random()*Math.PI*2);
  }
  const t0 = performance.now();
  const step = (t)=>{
    const dt = Math.min(32, t - (step.t||t)); step.t = t;
    let leadX = 0;
    for(const r of rats){
      if(finished) break;
      const wobble = Math.sin(((t - t0)/(r.wobblePeriod||200)) + (r.wobblePhase||0)) * (r.wobbleAmp||0.4);
      r.x += (r.baseSpeed + wobble) * (dt/16.7);
      if(r.x >= TRACK_DISTANCE){
        r.x = TRACK_DISTANCE;
        if(!winner){
          winner = r;
          finished = true;
          racing = false;
        }
      }
      positionRat(r, Math.min(r.x, TRACK_DISTANCE));
      if(r.x > leadX) leadX = r.x;
    }
    if(viewportWidth > 0){
      const worldLead = TRACK_START_OFFSET + leadX;
      const cameraTarget = worldLead - viewportWidth * 0.55;
      setCameraX(cameraTarget);
    }
    if(!finished){
      animId = requestAnimationFrame(step);
    }else{
      cancelAnimationFrame(animId);
      for(const r of rats){
        positionRat(r, Math.min(r.x, TRACK_DISTANCE));
      }
      if(viewportWidth > 0){
        const worldLead = TRACK_START_OFFSET + leadX;
        const cameraTarget = worldLead - viewportWidth * 0.55;
        setCameraX(cameraTarget);
      }
      endRace();
    }
  };
  animId = requestAnimationFrame(step);
}

function endRace(options={}){
  if(!winner){ statusEl.textContent = 'No winner?!'; return; }
  statusEl.textContent = `Winner: ${winner.name}!`;
  setScreen('betting');
  const p = pot();
  const totalOnWin = totalOn(winner.id);
  const winners = bets.filter(b=>b.ratId===winner.id);
  resultRows.innerHTML = '';
  if(!winners.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5">No one bet on ${winner.name}. House keeps the ${fmt(p)} pot.</td>`;
    resultRows.appendChild(tr);
    postWinnerToNetwork(winner.id, options);
    scheduleAutoReopen(options);
    return;
  }
  for(const b of bets){
    const payout = b.ratId===winner.id ? (b.amount / totalOnWin) * p : 0;
    const net = payout - b.amount;
    const tr = document.createElement('tr');
    if(b.owner === clientId){ tr.classList.add('mine'); }
    const ownerDetail = formatOwnerMeta(b.owner);
    tr.innerHTML = `
      <td>${escapeHTML(b.name||'—')}${ownerDetail}</td>
      <td>${ratName(b.ratId)}</td>
      <td class="right">${fmt(b.amount)}</td>
      <td class="right ${payout? 'ok':''}">${payout? fmt(Math.round(payout)) : '$0'}</td>
      <td class="right ${net>0?'ok':(net<0?'bad':'')}">${net>0? '+'+fmt(Math.round(net)).slice(1): (net<0? '-'+fmt(Math.round(-net)).slice(1): '$0')}</td>
    `;
    resultRows.appendChild(tr);
  }
  postWinnerToNetwork(winner.id, options);
  scheduleAutoReopen(options);
}

/* ============== Controls ============== */
function toggleBetUI(lock){
  betUiLocked = !!lock;
  addBetBtn.classList.toggle('muted', lock);
  addBetBtn.disabled = lock;
  for(const el of [bettorInput, sel, amountInput]){
    el.disabled = lock;
  }
  renderRatTotals();
  if(lock){
    cancelAutoStart();
  }else{
    updateAutoStartState();
  }
}

/* ============== Utilities & SVG ============== */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function generateId(){
  if(window.crypto?.randomUUID){
    return window.crypto.randomUUID();
  }
  return 'b'+Math.random().toString(36).slice(2,10)+Date.now().toString(36);
}

function createRaceSetup(){
  return {
    rats: RAT_DATA.map(r=>({
      id: r.id,
      baseSpeed: 4.1 + Math.random()*1.6,
      wobbleAmp: 0.5 + Math.random()*0.35,
      wobblePeriod: 180 + Math.random()*160,
      wobblePhase: Math.random()*Math.PI*2
    }))
  };
}

function ratSVG(color='#b9c2cc'){
  const darker = shade(color, -32);
  const darkest = shade(color, -46);
  const highlight = shade(color, 26);
  const mid = shade(color, -10);
  const blush = shade(color, 18);
  const innerEar = shade(color, 55);
  const tailColor = shade(color, -55);
  const sparkle = shade(color, 55);
  const gradId = `g${Math.random().toString(36).slice(2,8)}`;
  const bellyId = `b${Math.random().toString(36).slice(2,8)}`;
  return `
  <svg viewBox="0 0 220 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Racing rat">
    <defs>
      <linearGradient id="${gradId}" x1="54" y1="30" x2="176" y2="130" gradientUnits="userSpaceOnUse">
        <stop offset="0%" stop-color="${highlight}"/>
        <stop offset="45%" stop-color="${color}"/>
        <stop offset="100%" stop-color="${darker}"/>
      </linearGradient>
      <linearGradient id="${bellyId}" x1="0" y1="0" x2="0" y2="120" gradientUnits="userSpaceOnUse">
        <stop offset="0%" stop-color="${highlight}" stop-opacity=".8"/>
        <stop offset="100%" stop-color="${mid}" stop-opacity=".55"/>
      </linearGradient>
      <filter id="ratShadow" x="-60%" y="-60%" width="220%" height="220%">
        <feDropShadow dx="0" dy="12" stdDeviation="10" flood-color="rgba(0,0,0,.45)" flood-opacity="1"/>
      </filter>
    </defs>
    <g filter="url(#ratShadow)">
      <ellipse cx="110" cy="118" rx="78" ry="18" fill="rgba(0,0,0,.28)" opacity=".55"/>
      <path class="tail" d="M52 94 C 18 90, 6 70, 26 54 C 44 40, 88 46, 112 60" fill="none" stroke="${tailColor}" stroke-width="9" stroke-linecap="round" stroke-linejoin="round"/>
      <g class="body-group">
        <path d="M64 88 C 74 46, 130 36, 174 70 C 198 88, 204 116, 174 128 C 136 144, 82 132, 58 116 C 38 104, 44 98, 64 88 Z" fill="url(#${gradId})"/>
        <path d="M102 98 C 118 92, 146 96, 162 108 C 150 118, 126 122, 104 114 C 90 110, 92 104, 102 98 Z" fill="url(#${bellyId})" opacity=".7"/>
        <path d="M150 82 C 168 62, 202 62, 210 84 C 214 98, 200 112, 184 110 C 172 108, 162 98, 150 90 Z" fill="${mid}"/>
        <path d="M166 80 C 182 64, 204 66, 210 84 C 196 84, 186 92, 174 96 Z" fill="${highlight}" opacity=".6"/>
        <path class="ear" d="M170 58 C 186 36, 210 38, 216 60 C 202 60, 192 68, 178 74 Z" fill="${blush}"/>
        <path class="ear" d="M176 54 C 190 40, 208 42, 212 58 C 198 60, 190 66, 182 70 Z" fill="${innerEar}" opacity=".7"/>
        <circle cx="188" cy="90" r="5.2" fill="#141924"/>
        <circle cx="189.6" cy="88.6" r="1.6" fill="#fff" opacity=".8"/>
        <path d="M178 104 Q 188 110 204 100" stroke="${highlight}" stroke-width="4" stroke-linecap="round" opacity=".6"/>
        <path class="mane" d="M182 100 Q 198 100 214 94" stroke="${highlight}" stroke-width="3" stroke-linecap="round" opacity=".75"/>
        <path class="mane" d="M182 94 Q 198 92 212 86" stroke="${highlight}" stroke-width="3" stroke-linecap="round" opacity=".55"/>
        <path d="M94 108 L110 110 L104 136 L88 134 Z" fill="${darkest}"/>
        <path d="M122 110 L138 112 L132 138 L116 136 Z" fill="${darkest}" opacity=".85"/>
        <path d="M70 96 C 90 70, 132 66, 162 82" stroke="${highlight}" stroke-width="6" stroke-linecap="round" opacity=".35"/>
        <circle class="sparkle" cx="128" cy="54" r="3" fill="${sparkle}" opacity=".45"/>
        <circle class="sparkle" cx="146" cy="50" r="2.4" fill="#fff" opacity=".6"/>
      </g>
    </g>
  </svg>`;
}
function shade(hex, amt){
  let c = hex.replace('#','');
  if(c.length===3) c = c.split('').map(ch=>ch+ch).join('');
  let [r,g,b]=[0,2,4].map(i=>parseInt(c.substring(i,i+2),16));
  const adj = v => Math.max(0,Math.min(255, Math.round(v + (amt/100)*255)));
  r=adj(r); g=adj(g); b=adj(b);
  return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
}

/* initial draw */
redrawBets();

/* ============== Multiplayer / Firebase ============== */
const firebaseConfig = {
  apiKey: "AIzaSyBN7Y6JcmhMf04ghX2KUoSHbrZMYGtSrDs",
  authDomain: "multiplayer-640ec.firebaseapp.com",
  databaseURL: "https://multiplayer-640ec-default-rtdb.firebaseio.com",
  projectId: "multiplayer-640ec",
  storageBucket: "multiplayer-640ec.firebasestorage.app",
  messagingSenderId: "739760736627",
  appId: "1:739760736627:web:5f7f92ea5af55f3d4dbebb",
  measurementId: "G-S6CYR8YP69"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const rootRef = ref(db);


function rememberPlayerName(name){
  try{
    localStorage.setItem(NAME_STORAGE_KEY, name);
  }catch(err){
    console.debug('Unable to persist name', err);
  }
}

function setLocalPlayerIdentity(name){
  const sanitized = sanitizePlayerName(name);
  if(!sanitized) return '';
  playerName = sanitized;
  bettorInput.value = sanitized;
  rememberPlayerName(sanitized);
  renderSummaries();
  return sanitized;
}

function syncPresenceName(name){
  if(!isMultiplayer || !gamePath) return;
  const clean = (name || '').trim() || getLocalPlayerName() || 'Player';
  const now = Date.now();
  const payload = {};
  payload[`${gamePath}/players/${clientId}/name`] = clean;
  payload[`${gamePath}/players/${clientId}/lastSeen`] = now;
  update(rootRef, payload).catch(()=>{});
}

bettorInput.addEventListener('input', ()=>{
  renderSummaries();
});

bettorInput.addEventListener('blur', ()=>{
  const value = bettorInput.value.trim();
  if(value){
    playerName = value;
    rememberPlayerName(value);
  }
  renderSummaries();
  syncPresenceName(value);
});

function sanitizeRoomCode(value){
  const cleaned = String(value || '').replace(/[^a-zA-Z0-9]/g,'').slice(0,12);
  if(!cleaned) return '';
  if(cleaned.length <= 5){
    return cleaned.toUpperCase();
  }
  return cleaned.toLowerCase();
}

function generateRoomCode(){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for(let i=0;i<5;i++){ code += chars[Math.floor(Math.random()*chars.length)]; }
  return code;
}

function detachListeners(){
  for(const unsub of unsubscribers){
    try{ unsub(); }catch(err){ console.debug('Listener cleanup failed', err); }
  }
  unsubscribers = [];
  if(presenceRef){
    try{ onDisconnect(presenceRef).cancel(); }catch(err){ /* ignore */ }
    presenceRef = null;
  }
  betsRef = null;
  stateRef = null;
  playersRef = null;
  players = {};
  renderSummaries();
}

function attachListeners(){
  if(!gamePath) return;
  betsRef = ref(db, `${gamePath}/bets`);
  stateRef = ref(db, `${gamePath}/state`);
  playersRef = ref(db, `${gamePath}/players`);
  unsubscribers.push(onValue(betsRef, snapshot=>{
    const data = snapshot.val() || {};
    bets = Object.values(data);
    redrawBets();
  }));
  unsubscribers.push(onValue(stateRef, snapshot=>{
    const data = snapshot.val();
    if(data && data.updatedBy === clientId) return;
    remoteState = { status:'open', countdownDuration:2100, ...(data||{}) };
    handleNetworkState(remoteState);
  }));
  unsubscribers.push(onValue(playersRef, snapshot=>{
    const raw = snapshot.val() || {};
    const filtered = Object.fromEntries(Object.entries(raw).filter(([,value])=>value));
    players = filtered;
    renderSummaries();
  }));
}

function handleNetworkState(state){
  const phase = state.status || 'open';
  if(phase === 'open'){
    cancelCountdown();
    statusEl.textContent = 'Place your bets.';
    if(state.resetResults){
      resultRows.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">No results yet.</td></tr>`;
    }
    setScreen('betting');
    toggleBetUI(false);
    resetRacePositions();
  }else if(phase === 'countdown'){
    toggleBetUI(true);
    setScreen('race');
    const startTime = state.countdownStartedAt || Date.now();
    startCountdown({ startTime, duration: state.countdownDuration || 2100 });
    currentRaceSetup = state.raceSetup || currentRaceSetup;
  }else if(phase === 'running'){
    toggleBetUI(true);
    setScreen('race');
    if(state.raceSetup){ currentRaceSetup = state.raceSetup; }
    if(!racing){
      startRace(currentRaceSetup);
    }
  }else if(phase === 'finished'){
    toggleBetUI(true);
    setScreen('betting');
    cancelCountdown();
    if(state.winnerId){
      const rat = rats.find(r=>r.id===state.winnerId);
      if(rat){
        winner = rat;
        finished = true;
        racing = false;
        cancelAnimationFrame(animId);
        endRace({ triggeredByNetwork:true });
      }
    }
  }
  updateNotice();
}

function updateNotice(){
  if(mpNotice){
    if(mpMode === 'hostPrompt'){
      mpNotice.textContent = 'Share this code with friends. Create the room when you\'re ready.';
    }else if(mpMode === 'joinPrompt'){
      mpNotice.textContent = 'Enter a room code to join a friend.';
    }else if(isMultiplayer){
      const code = roomId || '—';
      mpNotice.textContent = isHost
        ? `Hosting room ${code}. Share the code with friends.`
        : `Joined room ${code}. Place your bets!`;
    }else{
      mpNotice.textContent = 'You are playing solo.';
    }
  }
}

function setMpMode(mode){
  mpMode = mode;
  if(mpCardEl){
    mpCardEl.dataset.mode = mode;
  }
  if(mode === 'room'){
    if(mpButtonRow) mpButtonRow.hidden = false;
    if(hostActions) hostActions.hidden = true;
    if(joinControls) joinControls.hidden = true;
    if(joinActions) joinActions.hidden = true;
    if(roomInfo) roomInfo.hidden = false;
    if(roomCodeEl) roomCodeEl.textContent = roomId || '—';
    if(copyRoomBtn) copyRoomBtn.textContent = 'Copy Code';
    hostBtn.disabled = true;
    hostBtn.classList.add('muted');
    joinBtn.disabled = true;
    joinBtn.classList.add('muted');
  }else if(mode === 'hostPrompt'){
    if(!pendingHostCode){ pendingHostCode = generateRoomCode(); }
    if(mpButtonRow) mpButtonRow.hidden = true;
    if(hostActions) hostActions.hidden = false;
    if(joinControls) joinControls.hidden = true;
    if(joinActions) joinActions.hidden = true;
    if(roomInfo){
      roomInfo.hidden = false;
      if(roomCodeEl) roomCodeEl.textContent = pendingHostCode;
    }
    if(copyRoomBtn) copyRoomBtn.textContent = 'Copy Code';
    hostBtn.disabled = false;
    hostBtn.classList.remove('muted');
    joinBtn.disabled = false;
    joinBtn.classList.remove('muted');
  }else if(mode === 'joinPrompt'){
    pendingHostCode = '';
    if(mpButtonRow) mpButtonRow.hidden = true;
    if(hostActions) hostActions.hidden = true;
    if(joinControls) joinControls.hidden = false;
    if(joinActions) joinActions.hidden = false;
    if(roomInfo) roomInfo.hidden = true;
    hostBtn.disabled = false;
    hostBtn.classList.remove('muted');
    joinBtn.disabled = false;
    joinBtn.classList.remove('muted');
    joinCodeInput.value = '';
    setTimeout(()=> joinCodeInput.focus(), 50);
  }else{
    pendingHostCode = '';
    if(mpButtonRow) mpButtonRow.hidden = false;
    if(hostActions) hostActions.hidden = true;
    if(joinControls) joinControls.hidden = true;
    if(joinActions) joinActions.hidden = true;
    if(!isMultiplayer && roomInfo) roomInfo.hidden = true;
    hostBtn.disabled = false;
    hostBtn.classList.remove('muted');
    joinBtn.disabled = false;
    joinBtn.classList.remove('muted');
  }
  updateNotice();
}

function updateModeUI(){
  if(isMultiplayer){
    setMpMode('room');
    toggleBetUI(remoteState.status !== 'open');
  }else{
    if(mpMode === 'room'){
      setMpMode('solo');
    }else{
      updateNotice();
    }
    toggleBetUI(false);
  }
}

function startSolo(){
  detachListeners();
  isMultiplayer = false;
  isHost = false;
  roomId = null;
  gamePath = '';
  cancelAutoStart();
  cancelAutoReopen();
  bets = [];
  players = { [clientId]: { name: getLocalPlayerName(), isHost:true } };
  redrawBets();
  resultRows.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">No results yet.</td></tr>`;
  statusEl.classList.remove('countdown');
  statusEl.textContent = 'Place your bets.';
  resetRacePositions();
  toggleBetUI(false);
  setScreen('betting');
  window.location.hash = '';
  setMpMode('solo');
  updateModeUI();
  renderSummaries();
}

async function hostStartRace(){
  if(!isHost || !isMultiplayer || !gamePath) return;
  const now = Date.now();
  const setup = createRaceSetup();
  currentRaceSetup = setup;
  const payload = {};
  payload[`${gamePath}/state`] = {
    status:'countdown',
    countdownStartedAt: now,
    countdownDuration: 2100,
    raceSetup: setup,
    winnerId: null,
    updatedBy: clientId,
    updatedAt: now
  };
  try{
    await update(rootRef, payload);
  }catch(err){
    console.warn('Failed to start countdown', err);
    statusEl.textContent = 'Unable to start race.';
    return;
  }
  toggleBetUI(true);
  await startCountdown({ startTime: now });
  const raceStart = Date.now();
  const runningPayload = {};
  runningPayload[`${gamePath}/state/status`] = 'running';
  runningPayload[`${gamePath}/state/raceSetup`] = setup;
  runningPayload[`${gamePath}/state/raceStartedAt`] = raceStart;
  runningPayload[`${gamePath}/state/updatedBy`] = clientId;
  runningPayload[`${gamePath}/state/updatedAt`] = raceStart;
  try{
    await update(rootRef, runningPayload);
  }catch(err){
    console.warn('Failed to announce race start', err);
  }
  startRace(setup);
}

function postWinnerToNetwork(winnerId, options={}){
  if(options.triggeredByNetwork) return;
  if(!isMultiplayer || !isHost || postedResults || !gamePath) return;
  postedResults = true;
  const now = Date.now();
  const payload = {};
  payload[`${gamePath}/state/status`] = 'finished';
  payload[`${gamePath}/state/winnerId`] = winnerId;
  payload[`${gamePath}/state/updatedBy`] = clientId;
  payload[`${gamePath}/state/updatedAt`] = now;
  update(rootRef, payload).catch(err=>{
    console.warn('Failed to publish winner', err);
    postedResults = false;
  });
}

function hostResetRace({ preserveResults=false }={}){
  if(!isHost || !gamePath) return;
  cancelAutoStart();
  cancelAutoReopen();
  bets = [];
  redrawBets();
  if(!preserveResults){
    resultRows.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">No results yet.</td></tr>`;
  }
  const now = Date.now();
  const statePayload = {
    status:'open',
    winnerId:null,
    countdownDuration:2100,
    updatedBy: clientId,
    updatedAt: now,
    resetResults: !preserveResults
  };
  const payload = {};
  payload[`${gamePath}/bets`] = null;
  payload[`${gamePath}/state`] = statePayload;
  update(rootRef, payload).catch(err=>{
    console.warn('Failed to reset race', err);
  });
  remoteState = { ...remoteState, ...statePayload };
  handleNetworkState(statePayload);
}

function joinRoom(code, { host=false }={}){
  const sanitized = sanitizeRoomCode(code);
  if(!sanitized) return;
  detachListeners();
  isMultiplayer = true;
  isHost = host;
  roomId = sanitized;
  gamePath = `ratRaces/${roomId}`;
  cancelAutoStart();
  cancelAutoReopen();
  bets = [];
  redrawBets();
  resultRows.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">No results yet.</td></tr>`;
  statusEl.classList.remove('countdown');
  statusEl.textContent = 'Place your bets.';
  players = { [clientId]: { name: getLocalPlayerName(), isHost: host } };
  renderSummaries();
  remoteState = { status:'open', countdownDuration:2100 };
  window.location.hash = roomId;
  setMpMode('room');
  updateModeUI();
  attachListeners();
  const now = Date.now();
  const presencePath = `${gamePath}/players/${clientId}`;
  presenceRef = ref(db, presencePath);
  const presenceData = {
    name: bettorInput.value || playerName || 'Player',
    isHost,
    lastSeen: now
  };
  update(rootRef, { [presencePath]: presenceData }).catch(()=>{});
  try{
    onDisconnect(presenceRef).remove();
  }catch(err){/* ignore */}
  if(host){
    const initPayload = {};
    initPayload[`${gamePath}/bets`] = null;
    initPayload[`${gamePath}/state`] = {
      status:'open',
      countdownDuration:2100,
      winnerId:null,
      updatedBy: clientId,
      updatedAt: now,
      resetResults:true
    };
    update(rootRef, initPayload).catch(err=>console.warn('Failed to prepare room', err));
  }
  toggleBetUI(false);
  syncPresenceName(bettorInput.value);
  pendingHostCode = '';
}

function showJoinControls(show){
  if(show){
    setMpMode('joinPrompt');
  }else if(!isMultiplayer){
    setMpMode('solo');
  }
}

function requestLobbyJoin(){
  const code = sanitizeRoomCode(lobbyJoinCodeInput ? lobbyJoinCodeInput.value : '');
  if(!code){
    if(lobbyJoinCodeInput){
      flagInvalidInput(lobbyJoinCodeInput);
      lobbyJoinCodeInput.focus();
    }
    return;
  }

  const nameInputValue = lobbyJoinNameInput ? lobbyJoinNameInput.value : playerName;
  const name = setLocalPlayerIdentity(nameInputValue);
  if(!name){
    if(lobbyJoinNameInput){
      flagInvalidInput(lobbyJoinNameInput);
      lobbyJoinNameInput.focus();
    }
    return;
  }

  if(lobbyJoinCodeInput){
    lobbyJoinCodeInput.value = code;
  }

  joinRoom(code, { host:false });
  closeLobby();
}

if(lobbyEl){
  lobbyEl.querySelectorAll('.back-action').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      showLobbyCard(btn.dataset.target || 'lobbyMain');
    });
  });
}

if(lobbySingleBtn){
  lobbySingleBtn.addEventListener('click', ()=>{
    startSolo();
    closeLobby();
  });
}

if(lobbyMultiplayerBtn){
  lobbyMultiplayerBtn.addEventListener('click', ()=>{
    showLobbyCard('multiplayerCard');
  });
}

if(lobbyHostBtn){
  lobbyHostBtn.addEventListener('click', ()=>{
    lobbyHostCodeValue = generateRoomCode();
    if(lobbyHostCodeEl){
      lobbyHostCodeEl.textContent = lobbyHostCodeValue;
      lobbyHostCodeEl.dataset.code = lobbyHostCodeValue;
    }
    if(lobbyHostNameInput){
      lobbyHostNameInput.value = bettorInput.value.trim() || playerName || '';
      lobbyHostNameInput.classList.remove('invalid');
    }
    if(lobbyCopyCodeBtn){
      lobbyCopyCodeBtn.textContent = 'Copy code';
      if(lobbyCopyResetTimer){
        clearTimeout(lobbyCopyResetTimer);
        lobbyCopyResetTimer = null;
      }
    }
    showLobbyCard('hostCard');
    setTimeout(()=>{
      if(lobbyHostNameInput){
        lobbyHostNameInput.focus();
        lobbyHostNameInput.select();
      }
    }, 50);
  });
}

if(lobbyCopyCodeBtn){
  lobbyCopyCodeBtn.addEventListener('click', async ()=>{
    const code = sanitizeRoomCode(lobbyHostCodeEl ? (lobbyHostCodeEl.dataset.code || lobbyHostCodeEl.textContent || '') : '');
    if(!code) return;
    const success = await copyTextToClipboard(code);
    lobbyCopyCodeBtn.textContent = success ? 'Copied!' : 'Press Ctrl+C';
    if(lobbyCopyResetTimer){
      clearTimeout(lobbyCopyResetTimer);
    }
    lobbyCopyResetTimer = setTimeout(()=>{
      lobbyCopyCodeBtn.textContent = 'Copy code';
    }, success ? 1600 : 2600);
  });
}

if(lobbyHostStartBtn){
  lobbyHostStartBtn.addEventListener('click', ()=>{
    let code = lobbyHostCodeEl ? (lobbyHostCodeEl.dataset.code || lobbyHostCodeEl.textContent || lobbyHostCodeValue) : lobbyHostCodeValue;
    if(!code){
      lobbyHostCodeValue = generateRoomCode();
      if(lobbyHostCodeEl){
        lobbyHostCodeEl.textContent = lobbyHostCodeValue;
        lobbyHostCodeEl.dataset.code = lobbyHostCodeValue;
      }
      code = lobbyHostCodeValue;
    }
    code = sanitizeRoomCode(code);
    if(!code){
      return;
    }

    const name = setLocalPlayerIdentity(lobbyHostNameInput ? lobbyHostNameInput.value : playerName);
    if(!name){
      flagInvalidInput(lobbyHostNameInput);
      if(lobbyHostNameInput){
        lobbyHostNameInput.focus();
      }
      return;
    }

    joinRoom(code, { host:true });
    closeLobby();
  });
}

if(lobbyJoinBtn){
  lobbyJoinBtn.addEventListener('click', ()=>{
    if(lobbyJoinNameInput){
      lobbyJoinNameInput.value = bettorInput.value.trim() || playerName || '';
      lobbyJoinNameInput.classList.remove('invalid');
    }
    if(lobbyJoinCodeInput){
      lobbyJoinCodeInput.value = '';
      lobbyJoinCodeInput.classList.remove('invalid');
    }
    showLobbyCard('joinCard');
    setTimeout(()=>{
      if(lobbyJoinNameInput){
        lobbyJoinNameInput.focus();
        lobbyJoinNameInput.select();
      }else if(lobbyJoinCodeInput){
        lobbyJoinCodeInput.focus();
      }
    }, 50);
  });
}

if(lobbyJoinConfirmBtn){
  lobbyJoinConfirmBtn.addEventListener('click', requestLobbyJoin);
}

if(lobbyJoinCodeInput){
  lobbyJoinCodeInput.addEventListener('input', ()=>{
    lobbyJoinCodeInput.value = sanitizeRoomCode(lobbyJoinCodeInput.value);
    lobbyJoinCodeInput.classList.remove('invalid');
  });
  lobbyJoinCodeInput.addEventListener('keydown', event=>{
    if(event.key === 'Enter'){
      event.preventDefault();
      requestLobbyJoin();
    }
  });
}

if(lobbyHostNameInput){
  lobbyHostNameInput.addEventListener('input', ()=>{
    lobbyHostNameInput.classList.remove('invalid');
  });
}

if(lobbyJoinNameInput){
  lobbyJoinNameInput.addEventListener('input', ()=>{
    lobbyJoinNameInput.classList.remove('invalid');
  });
}

soloBtn.addEventListener('click', ()=> startSolo());
hostBtn.addEventListener('click', ()=>{
  if(isMultiplayer){
    setMpMode('room');
    return;
  }
  pendingHostCode = generateRoomCode();
  setMpMode('hostPrompt');
});
if(hostConfirmBtn){
  hostConfirmBtn.addEventListener('click', ()=>{
    if(isMultiplayer){
      setMpMode('room');
      return;
    }
    if(!pendingHostCode){
      pendingHostCode = generateRoomCode();
    }
    joinRoom(pendingHostCode, { host:true });
    pendingHostCode = '';
  });
}
if(hostCancelBtn){
  hostCancelBtn.addEventListener('click', ()=>{
    setMpMode(isMultiplayer ? 'room' : 'solo');
  });
}
joinBtn.addEventListener('click', ()=>{
  if(isMultiplayer){
    setMpMode('room');
    return;
  }
  showJoinControls(true);
});
if(joinCancelBtn){
  joinCancelBtn.addEventListener('click', ()=>{
    setMpMode(isMultiplayer ? 'room' : 'solo');
  });
}

joinConfirmBtn.addEventListener('click', ()=>{
  const code = sanitizeRoomCode(joinCodeInput.value);
  if(!code){
    joinCodeInput.focus();
    return;
  }
  joinRoom(code, { host:false });
});

joinCodeInput.addEventListener('keydown', event=>{
  if(event.key === 'Enter'){
    event.preventDefault();
    joinConfirmBtn.click();
  }
});

joinCodeInput.addEventListener('input', ()=>{
  joinCodeInput.value = sanitizeRoomCode(joinCodeInput.value);
});

if(copyRoomBtn){
  copyRoomBtn.addEventListener('click', async ()=>{
    if(roomInfo.hidden) return;
    const code = roomCodeEl.textContent?.trim();
    if(!code || code === '—') return;
    const success = await copyTextToClipboard(code);
    copyRoomBtn.textContent = success ? 'Copied!' : 'Press Ctrl+C';
    setTimeout(()=>{
      copyRoomBtn.textContent = 'Copy Code';
    }, success ? 1600 : 2600);
  });
}

async function copyTextToClipboard(text){
  if(!navigator.clipboard) {
    try{
      const activeElement = document.activeElement;
      const isTextControl = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');
      let selectionRange = null;
      if(isTextControl){
        try{
          selectionRange = { start: activeElement.selectionStart, end: activeElement.selectionEnd };
        }catch(err){
          selectionRange = null;
        }
      }
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.setAttribute('readonly', '');
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      const selection = document.getSelection();
      const previousRange = selection && selection.rangeCount ? selection.getRangeAt(0) : null;
      textarea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textarea);
      if(previousRange){
        selection.removeAllRanges();
        selection.addRange(previousRange);
      }
      if(activeElement && typeof activeElement.focus === 'function'){
        try{
          activeElement.focus({ preventScroll: true });
        }catch(err){
          activeElement.focus();
        }
        if(isTextControl && selectionRange && typeof activeElement.setSelectionRange === 'function'){
          try{
            activeElement.setSelectionRange(selectionRange.start, selectionRange.end);
          }catch(err){
            /* ignore selection restore errors */
          }
        }
      }
      return success;
    }catch(err){
      console.warn('Clipboard fallback failed', err);
      return false;
    }
  }
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(err){
    console.warn('Clipboard copy failed', err);
    return false;
  }
}

const initialCode = sanitizeRoomCode(window.location.hash.replace('#',''));
if(initialCode){
  joinRoom(initialCode, { host:false });
  closeLobby();
}else{
  startSolo();
  openLobby('lobbyMain');
}

isSupported()
  .then((supported)=>{ if(supported){ getAnalytics(app); } })
  .catch(err=>console.warn('Firebase analytics not supported', err));

</script>
</body>
</html>
